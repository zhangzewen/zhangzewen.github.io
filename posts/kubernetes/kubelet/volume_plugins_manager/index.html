<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xml:lang="zh-cn" lang="zh-cn" >

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.149.0">

  <title>kubernetes 源码分析之 kubelet volume plugins manager &middot; What a Life!</title>

  <meta name="description" content="" />

  
  <meta itemprop="name" content="kubernetes 源码分析之 kubelet volume plugins manager">
  <meta itemprop="description" content="本篇文章基于 Kubernetes v1.25.1
在 kubernetes 中存储以插件的形似存在，kubernetes 提供了接口 Volume 极其扩展接口来表示存储卷，使用 VolumePlugin 接口来表示一个存储卷插件。像常用的 empty/hostpath/configmap/secert/csi 等都是以插件形式存在的存储卷（这里的 csi 是让 kubernetes 可以使用第三方提供的存储功能），kubelet 使用 volume plugins manager 来管理它们。">
  <meta itemprop="datePublished" content="2025-06-18T09:43:31+08:00">
  <meta itemprop="dateModified" content="2025-06-18T09:43:31+08:00">
  <meta itemprop="wordCount" content="542">
  <meta itemprop="image" content="https://www.zhangzewen.net/images/profile.png">
  <meta itemprop="keywords" content="源码分析,Kubernetes,Kubelet,Csi">


  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://www.zhangzewen.net/images/profile.png">
  <meta name="twitter:title" content="kubernetes 源码分析之 kubelet volume plugins manager">
  <meta name="twitter:description" content="本篇文章基于 Kubernetes v1.25.1
在 kubernetes 中存储以插件的形似存在，kubernetes 提供了接口 Volume 极其扩展接口来表示存储卷，使用 VolumePlugin 接口来表示一个存储卷插件。像常用的 empty/hostpath/configmap/secert/csi 等都是以插件形式存在的存储卷（这里的 csi 是让 kubernetes 可以使用第三方提供的存储功能），kubelet 使用 volume plugins manager 来管理它们。">


<meta property="og:url" content="https://www.zhangzewen.net/posts/kubernetes/kubelet/volume_plugins_manager/">
  <meta property="og:site_name" content="What a Life!">
  <meta property="og:title" content="kubernetes 源码分析之 kubelet volume plugins manager">
  <meta property="og:description" content="本篇文章基于 Kubernetes v1.25.1
在 kubernetes 中存储以插件的形似存在，kubernetes 提供了接口 Volume 极其扩展接口来表示存储卷，使用 VolumePlugin 接口来表示一个存储卷插件。像常用的 empty/hostpath/configmap/secert/csi 等都是以插件形式存在的存储卷（这里的 csi 是让 kubernetes 可以使用第三方提供的存储功能），kubelet 使用 volume plugins manager 来管理它们。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-06-18T09:43:31+08:00">
    <meta property="article:modified_time" content="2025-06-18T09:43:31+08:00">
    <meta property="article:tag" content="源码分析">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Kubelet">
    <meta property="article:tag" content="Csi">
    <meta property="og:image" content="https://www.zhangzewen.net/images/profile.png">



<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type":"Person",
      "@id": "https://www.zhangzewen.net/#author",
      "name": "Zhang Zewen",
      "image": {
        "@type":"ImageObject",
        
        "url": "https://www.zhangzewen.net/images/android-chrome-512x512.png"
        
      },
      "description": "Software Engineer"
    },
    {
      "@type": "WebSite",
      "@id": "https://www.zhangzewen.net/#website",
      "url": "https://www.zhangzewen.net/",
      "name": "What a Life!",
      "description": "Software Engineer",
      "publisher": {
        "@id": "https://www.zhangzewen.net/#author"
      },
      "inLanguage": "zh-cn"
    },
    {
      "@type": "ImageObject",
      "url": "https://www.zhangzewen.net/images/profile.png",
      "caption": "What a Life!"
    },
    {
      "@type": "WebPage",
      "@id": "https://www.zhangzewen.net/posts/kubernetes/kubelet/volume_plugins_manager/#webpage",
      "url": "https://www.zhangzewen.net/posts/kubernetes/kubelet/volume_plugins_manager/",
      "name": "kubernetes 源码分析之 kubelet volume plugins manager",
      "isPartOf": {
        "@id": "https://www.zhangzewen.net/#website"
      },
      "about": {
         "@id": "https://www.zhangzewen.net/#author"
      },
      "datePublished": "2025-06-18T09:43:31+08:00",
      "dateModified": "2025-06-18T09:43:31+08:00",
      "description": "\u003cblockquote\u003e\n\u003cp\u003e本篇文章基于 Kubernetes v1.25.1\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e在 kubernetes 中存储以插件的形似存在，kubernetes 提供了接口 \u003ca href=\"https://github.com/kubernetes/kubernetes/blob/e4d4e1ab7cf1bf15273ef97303551b279f0920a9/pkg/volume/volume.go#L30\"\u003eVolume\u003c/a\u003e 极其扩展接口来表示存储卷，使用 \u003ca href=\"https://github.com/kubernetes/kubernetes/blob/e4d4e1ab7cf1bf15273ef97303551b279f0920a9/pkg/volume/plugins.go#L134\"\u003eVolumePlugin\u003c/a\u003e 接口来表示一个存储卷插件。像常用的 \u003ccode\u003eempty/hostpath/configmap/secert/csi\u003c/code\u003e 等都是以插件形式存在的存储卷（这里的 csi 是让 kubernetes 可以使用第三方提供的存储功能），kubelet 使用 volume plugins manager 来管理它们。\u003c/p\u003e",
      "inLanguage": "zh-cn",
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "https://www.zhangzewen.net/posts/kubernetes/kubelet/volume_plugins_manager/"
          ]
        }
      ]
    },
    {
      "@type": "Article",
      "isPartOf": {
        "@id": "https://www.zhangzewen.net/posts/kubernetes/kubelet/volume_plugins_manager/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "https://www.zhangzewen.net/posts/kubernetes/kubelet/volume_plugins_manager/#webpage"
      },
      "headline": "kubernetes 源码分析之 kubelet volume plugins manager",
      "datePublished": "2025-06-18T09:43:31+08:00",
      "dateModified": "2025-06-18T09:43:31+08:00",
      "publisher": {
        "@id": "https://www.zhangzewen.net/#author"
      },
      "keywords": [
        "源码分析",
        "Kubernetes",
        "Kubelet",
        "Csi"
      ],
      "articleSection": [
      ],
      "inLanguage": "zh-cn",
      "author": {
        "@type": "Person",
        "name":  null 
      },
      "potentialAction": [
        {
          "@type": "CommentAction",
          "name": "Comment",
          "target": [
            "https://www.zhangzewen.net/posts/kubernetes/kubelet/volume_plugins_manager/#comments"
          ]
        }
      ]
    }
  ]
}
</script>



  <link type="text/css" rel="stylesheet" href="/css/print.css" media="print">

  <link type="text/css" rel="stylesheet" href="/css/poole.css">

  <link type="text/css" rel="stylesheet" href="/css/hyde.css">

  


  

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
    integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>

<body>
  <aside class="toc">
  
  
  <h3>目录</h3>
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#实现">实现</a></li>
        <li><a href="#检索合适的-volume-plugin">检索合适的 volume plugin</a></li>
        <li><a href="#帮助类接口-volumehost">帮助类接口 VolumeHost</a></li>
      </ul>
    </li>
  </ul>
</nav>
  
  
</aside>

  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <a href="https://www.zhangzewen.net/">
            <img src="/images/android-chrome-512x512.png" class="img-circle img-headshot center" alt="Profile Picture">
          </a>
        </div>
        
      

      <h1>What a Life!</h1>

      
      <p class="lead">Software Engineer</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="https://www.zhangzewen.net/">Home</a>
        </li>
        <li>
          <a href="/tags/">Tags</a>
        </li><li>
          <a href="/archive/">Archives</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
    </section>
  </div>
</aside>


  <main class="content container">
    <div class="post">
  <h1 class="title">kubernetes 源码分析之 kubelet volume plugins manager</h1>
  
  

  <div class="post-date">
    <time datetime=" 2025-06-18T09:43:31&#43;0800">Created: Jun 18, 2025</time>
    <span class="readtime">&middot; 3 min read</span>
  </div>

  <div>
    <blockquote>
<p>本篇文章基于 Kubernetes v1.25.1</p></blockquote>
<p>在 kubernetes 中存储以插件的形似存在，kubernetes 提供了接口 <a href="https://github.com/kubernetes/kubernetes/blob/e4d4e1ab7cf1bf15273ef97303551b279f0920a9/pkg/volume/volume.go#L30">Volume</a> 极其扩展接口来表示存储卷，使用 <a href="https://github.com/kubernetes/kubernetes/blob/e4d4e1ab7cf1bf15273ef97303551b279f0920a9/pkg/volume/plugins.go#L134">VolumePlugin</a> 接口来表示一个存储卷插件。像常用的 <code>empty/hostpath/configmap/secert/csi</code> 等都是以插件形式存在的存储卷（这里的 csi 是让 kubernetes 可以使用第三方提供的存储功能），kubelet 使用 volume plugins manager 来管理它们。</p>
<h2 id="实现">实现</h2>
<p>结构体 volume plugins manager 的定义</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// VolumePluginMgr tracks registered plugins.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">type</span> VolumePluginMgr <span style="color:#fe8019">struct</span> {
</span></span><span style="display:flex;"><span>	mutex                     sync.RWMutex
</span></span><span style="display:flex;"><span>	plugins                   <span style="color:#fe8019">map</span>[<span style="color:#fabd2f">string</span>]VolumePlugin
</span></span><span style="display:flex;"><span>	prober                    DynamicPluginProber
</span></span><span style="display:flex;"><span>	probedPlugins             <span style="color:#fe8019">map</span>[<span style="color:#fabd2f">string</span>]VolumePlugin
</span></span><span style="display:flex;"><span>	loggedDeprecationWarnings sets.String
</span></span><span style="display:flex;"><span>	Host                      VolumeHost
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>kubelet 在启动时，会创建和初始化 volume plugins manager：</p>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// k8s.io/kubernetes/cmd/kubelet/app/plugins.go</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// kubernetes 支持的存储卷插件</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> <span style="color:#fabd2f">ProbeVolumePlugins</span>(featureGate featuregate.FeatureGate) ([]volume.VolumePlugin, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>	allPlugins <span style="color:#fe8019">:=</span> []volume.VolumePlugin{}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">var</span> err <span style="color:#fabd2f">error</span>
</span></span><span style="display:flex;"><span>	allPlugins, err = <span style="color:#fabd2f">appendLegacyProviderVolumes</span>(allPlugins, featureGate)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> allPlugins, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, emptydir.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, git_repo.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, hostpath.<span style="color:#fabd2f">ProbeVolumePlugins</span>(volume.VolumeConfig{})<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, nfs.<span style="color:#fabd2f">ProbeVolumePlugins</span>(volume.VolumeConfig{})<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, secret.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, iscsi.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, glusterfs.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, cephfs.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, downwardapi.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, fc.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, configmap.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, projected.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, local.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	allPlugins = <span style="color:#fabd2f">append</span>(allPlugins, csi.<span style="color:#fabd2f">ProbeVolumePlugins</span>()<span style="color:#fe8019">...</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> allPlugins, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// k8s.io/kubernetes/cmd/kubelet/app/server.go</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// 构建依赖项</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> <span style="color:#fabd2f">UnsecuredDependencies</span>(s <span style="color:#fe8019">*</span>options.KubeletServer, featureGate featuregate.FeatureGate) (<span style="color:#fe8019">*</span>kubelet.Dependencies, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// ...</span>
</span></span><span style="display:flex;"><span>	plugins, err <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">ProbeVolumePlugins</span>(featureGate)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// ...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// k8s.io/kubernetes/pkg/kubelet/kubelet.go</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// 创建 volume plugins manager 实例</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> <span style="color:#fabd2f">NewMainKubelet</span>(<span style="color:#fe8019">...</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// ...</span>
</span></span><span style="display:flex;"><span>	klet.volumePluginMgr, err =
</span></span><span style="display:flex;"><span>		<span style="color:#fabd2f">NewInitializedVolumePluginMgr</span>(klet, secretManager, configMapManager, tokenManager, kubeDeps.VolumePlugins, kubeDeps.DynamicPluginProber)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// ...</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// k8s.io/kubernetes/pkg/kubelet/volume_host.go</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> <span style="color:#fabd2f">NewInitializedVolumePluginMgr</span>(<span style="color:#fe8019">...</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// ...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">:=</span> kvh.volumePluginMgr.<span style="color:#fabd2f">InitPlugins</span>(plugins, prober, kvh); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>, fmt.<span style="color:#fabd2f">Errorf</span>(
</span></span><span style="display:flex;"><span>			<span style="color:#b8bb26">&#34;could not initialize volume plugins for KubeletVolumePluginMgr: %v&#34;</span>,
</span></span><span style="display:flex;"><span>			err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// ...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<p>并调用 InitPlugins 来初始化 kubernetes 所支持的存储卷插件：</p>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// k8s.io/kubernetes/pkg/volume/plugins.go</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (pm <span style="color:#fe8019">*</span>VolumePluginMgr) <span style="color:#fabd2f">InitPlugins</span>(plugins []VolumePlugin, prober DynamicPluginProber, host VolumeHost) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>	pm.mutex.<span style="color:#fabd2f">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">defer</span> pm.mutex.<span style="color:#fabd2f">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pm.Host = host
</span></span><span style="display:flex;"><span>	pm.loggedDeprecationWarnings = sets.<span style="color:#fabd2f">NewString</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> prober <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// Use a dummy prober to prevent nil deference.</span>
</span></span><span style="display:flex;"><span>		pm.prober = <span style="color:#fe8019">&amp;</span>dummyPluginProber{}
</span></span><span style="display:flex;"><span>	} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>		pm.prober = prober
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">:=</span> pm.prober.<span style="color:#fabd2f">Init</span>(); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// Prober init failure should not affect the initialization of other plugins.</span>
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Error initializing dynamic plugin prober: %s&#34;</span>, err)
</span></span><span style="display:flex;"><span>		pm.prober = <span style="color:#fe8019">&amp;</span>dummyPluginProber{}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> pm.plugins <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		pm.plugins = <span style="color:#fe8019">map</span>[<span style="color:#fabd2f">string</span>]VolumePlugin{}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> pm.probedPlugins <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		pm.probedPlugins = <span style="color:#fe8019">map</span>[<span style="color:#fabd2f">string</span>]VolumePlugin{}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	allErrs <span style="color:#fe8019">:=</span> []<span style="color:#fabd2f">error</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">for</span> _, plugin <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> plugins {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 校验plugin的name</span>
</span></span><span style="display:flex;"><span>		name <span style="color:#fe8019">:=</span> plugin.<span style="color:#fabd2f">GetPluginName</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> errs <span style="color:#fe8019">:=</span> validation.<span style="color:#fabd2f">IsQualifiedName</span>(name); <span style="color:#fabd2f">len</span>(errs) <span style="color:#fe8019">!=</span> <span style="color:#d3869b">0</span> {
</span></span><span style="display:flex;"><span>			allErrs = <span style="color:#fabd2f">append</span>(allErrs, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;volume plugin has invalid name: %q: %s&#34;</span>, name, strings.<span style="color:#fabd2f">Join</span>(errs, <span style="color:#b8bb26">&#34;;&#34;</span>)))
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 避免注册plugin</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> _, found <span style="color:#fe8019">:=</span> pm.plugins[name]; found {
</span></span><span style="display:flex;"><span>			allErrs = <span style="color:#fabd2f">append</span>(allErrs, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;volume plugin %q was registered more than once&#34;</span>, name))
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 调用plugin的Init来初始化plugin</span>
</span></span><span style="display:flex;"><span>		err <span style="color:#fe8019">:=</span> plugin.<span style="color:#fabd2f">Init</span>(host)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Failed to load volume plugin %s, error: %s&#34;</span>, name, err.<span style="color:#fabd2f">Error</span>())
</span></span><span style="display:flex;"><span>			allErrs = <span style="color:#fabd2f">append</span>(allErrs, err)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 进行关联映射</span>
</span></span><span style="display:flex;"><span>		pm.plugins[name] = plugin
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">1</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Loaded volume plugin %q&#34;</span>, name)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> utilerrors.<span style="color:#fabd2f">NewAggregate</span>(allErrs)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h2 id="检索合适的-volume-plugin">检索合适的 volume plugin</h2>
<p>在 <code>k8s.io/kubernetes/pkg/volume/plugins.go</code> 下可以看到有不少接口扩展了 VolumePlugin 这个接口，给其赋予了不同的能力：</p>
<ul>
<li>VolumePlugin，所有volume plugin的基类。</li>
<li>PersistentVolumePlugin，支持持久存储卷。</li>
<li>RecyclableVolumePlugin，支持回收。</li>
<li>DeletableVolumePlugin，支持释放 pvc 的时候删除与之绑定的 pv。</li>
<li>ProvisionableVolumePlugin，支持创建volume。</li>
<li>AttachableVolumePlugin，支持 attach。</li>
<li>DeviceMountableVolumePlugin，支持在把 device 作为 volume 提供给 Pod 前必须要把 device 挂载到 node 上。</li>
<li>ExpandableVolumePlugin，支持通过 control-plane 调用 ExpandVolumeDevice 来进行扩展。</li>
<li>NodeExpandableVolumePlugin，支持通过 NodeExpand 调用来展开节点。</li>
<li>VolumePluginWithAttachLimits，支持限制同一个节点 attach 限制</li>
<li>BlockVolumePlugin，支持块设备</li>
</ul>
<p>然后就可以大致理解 VolumePluginMgr 的方法组:</p>
<ul>
<li>FindXXXByName</li>
<li>FindXXXBySpec</li>
</ul>
<p>这两个方法组很好理解，对其已经注册的 volume plugin 作类型判断过滤，返回符合要求的 volume plugin：</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (pm <span style="color:#fe8019">*</span>VolumePluginMgr) <span style="color:#fabd2f">FindPersistentPluginBySpec</span>(spec <span style="color:#fe8019">*</span>Spec) (PersistentVolumePlugin, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>	volumePlugin, err <span style="color:#fe8019">:=</span> pm.<span style="color:#fabd2f">FindPluginBySpec</span>(spec)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;could not find volume plugin for spec: %#v&#34;</span>, spec)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> persistentVolumePlugin, ok <span style="color:#fe8019">:=</span> volumePlugin.(PersistentVolumePlugin); ok {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> persistentVolumePlugin, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;no persistent volume plugin matched&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="帮助类接口-volumehost">帮助类接口 VolumeHost</h2>
<p>帮助类接口 VolumeHost 可以让 volume plugin 能够通过 kubelet 获取到相关的数据，这样的接口还有：KubeletVolumeHost 和 AttachDetachVolumeHost。接口描述可以在<code>k8s.io/kubernetes/pkg/volume/plugins.go</code>下找到。</p>

  </div>


  
<div>
  <ul class="tags">
  <li>
    <a href="https://www.zhangzewen.net/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="tag-link">源码分析</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/kubernetes/" class="tag-link">Kubernetes</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/kubelet/" class="tag-link">Kubelet</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/csi/" class="tag-link">Csi</a>
  </li>
  </ul>
</div>



  <div class="share-buttons">
    
  
<script src="https://utteranc.es/client.js"
        repo="zhangzewen/zhangzewen.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>


  
</div>
  </main>

  <footer>
  <div>
    <p>
      &copy; Zhang Zewen 2025

      &middot; <a href="https://creativecommons.org/licenses/by-sa/4.0" target="_blank">CC BY-SA 4.0</a>

      
    </p>
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
    integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin="anonymous"></script>


  <script src="/js/jquery.min.js"></script>
  <script src="/js/soho.js"></script>

  

  
  
  
</body>

</html>
