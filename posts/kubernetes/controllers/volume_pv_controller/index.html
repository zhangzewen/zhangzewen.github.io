<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xml:lang="zh-cn" lang="zh-cn" >

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.149.1">

  <title>kubernetes 源码分析之 PV Controller &middot; What a Life!</title>

  <meta name="description" content="" />

  
  <meta itemprop="name" content="kubernetes 源码分析之 PV Controller">
  <meta itemprop="description" content="本篇文章基于 Kubernetes v1.25.1
PV Controller 的作用是 把 PVC 和 PV 绑定起来，其内部是通过 PersistentVolumeController 实现，通过 NewController 来创建PersistentVolumeController，NewController 主要做了如下几件事情：">
  <meta itemprop="datePublished" content="2025-08-29T02:43:31+08:00">
  <meta itemprop="dateModified" content="2025-08-29T02:43:31+08:00">
  <meta itemprop="wordCount" content="9609">
  <meta itemprop="image" content="https://www.zhangzewen.net/images/profile.png">
  <meta itemprop="keywords" content="源码分析,Kubernetes,Kubelet,Csi">


  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://www.zhangzewen.net/images/profile.png">
  <meta name="twitter:title" content="kubernetes 源码分析之 PV Controller">
  <meta name="twitter:description" content="本篇文章基于 Kubernetes v1.25.1
PV Controller 的作用是 把 PVC 和 PV 绑定起来，其内部是通过 PersistentVolumeController 实现，通过 NewController 来创建PersistentVolumeController，NewController 主要做了如下几件事情：">


<meta property="og:url" content="https://www.zhangzewen.net/posts/kubernetes/controllers/volume_pv_controller/">
  <meta property="og:site_name" content="What a Life!">
  <meta property="og:title" content="kubernetes 源码分析之 PV Controller">
  <meta property="og:description" content="本篇文章基于 Kubernetes v1.25.1
PV Controller 的作用是 把 PVC 和 PV 绑定起来，其内部是通过 PersistentVolumeController 实现，通过 NewController 来创建PersistentVolumeController，NewController 主要做了如下几件事情：">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-29T02:43:31+08:00">
    <meta property="article:modified_time" content="2025-08-29T02:43:31+08:00">
    <meta property="article:tag" content="源码分析">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Kubelet">
    <meta property="article:tag" content="Csi">
    <meta property="og:image" content="https://www.zhangzewen.net/images/profile.png">



<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type":"Person",
      "@id": "https://www.zhangzewen.net/#author",
      "name": "Zhang Zewen",
      "image": {
        "@type":"ImageObject",
        
        "url": "https://www.zhangzewen.net/images/android-chrome-512x512.png"
        
      },
      "description": "Software Engineer"
    },
    {
      "@type": "WebSite",
      "@id": "https://www.zhangzewen.net/#website",
      "url": "https://www.zhangzewen.net/",
      "name": "What a Life!",
      "description": "Software Engineer",
      "publisher": {
        "@id": "https://www.zhangzewen.net/#author"
      },
      "inLanguage": "zh-cn"
    },
    {
      "@type": "ImageObject",
      "url": "https://www.zhangzewen.net/images/profile.png",
      "caption": "What a Life!"
    },
    {
      "@type": "WebPage",
      "@id": "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_pv_controller/#webpage",
      "url": "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_pv_controller/",
      "name": "kubernetes 源码分析之 PV Controller",
      "isPartOf": {
        "@id": "https://www.zhangzewen.net/#website"
      },
      "about": {
         "@id": "https://www.zhangzewen.net/#author"
      },
      "datePublished": "2025-08-29T02:43:31+08:00",
      "dateModified": "2025-08-29T02:43:31+08:00",
      "description": "\u003cblockquote\u003e\n\u003cp\u003e本篇文章基于 Kubernetes v1.25.1\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003ePV Controller 的作用是 把 PVC 和 PV 绑定起来，其内部是通过 PersistentVolumeController 实现，通过 NewController 来创建PersistentVolumeController，NewController 主要做了如下几件事情：\u003c/p\u003e",
      "inLanguage": "zh-cn",
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_pv_controller/"
          ]
        }
      ]
    },
    {
      "@type": "Article",
      "isPartOf": {
        "@id": "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_pv_controller/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_pv_controller/#webpage"
      },
      "headline": "kubernetes 源码分析之 PV Controller",
      "datePublished": "2025-08-29T02:43:31+08:00",
      "dateModified": "2025-08-29T02:43:31+08:00",
      "publisher": {
        "@id": "https://www.zhangzewen.net/#author"
      },
      "keywords": [
        "源码分析",
        "Kubernetes",
        "Kubelet",
        "Csi"
      ],
      "articleSection": [
      ],
      "inLanguage": "zh-cn",
      "author": {
        "@type": "Person",
        "name":  null 
      },
      "potentialAction": [
        {
          "@type": "CommentAction",
          "name": "Comment",
          "target": [
            "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_pv_controller/#comments"
          ]
        }
      ]
    }
  ]
}
</script>



  <link type="text/css" rel="stylesheet" href="/css/print.css" media="print">

  <link type="text/css" rel="stylesheet" href="/css/poole.css">

  <link type="text/css" rel="stylesheet" href="/css/hyde.css">

  


  

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
    integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>

<body>
  <aside class="toc">
  
  
  <h3>目录</h3>
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#run">Run</a></li>
        <li><a href="#生产者协程resync">生产者协程：resync</a></li>
        <li><a href="#消费者协程volumeworker">消费者协程：volumeWorker</a>
          <ul>
            <li><a href="#updatevolume">updateVolume</a></li>
            <li><a href="#deletevolume">deleteVolume</a></li>
            <li><a href="#syncvolume">syncVolume</a></li>
            <li><a href="#reclaimvolume">reclaimVolume</a></li>
          </ul>
        </li>
        <li><a href="#消费者协程claimworker">消费者协程：claimWorker</a>
          <ul>
            <li><a href="#updateclaim">updateClaim</a>
              <ul>
                <li><a href="#syncclaim">syncClaim</a></li>
                <li><a href="#syncunboundclaim">syncUnboundClaim</a></li>
                <li><a href="#provisionclaim">provisionClaim</a></li>
                <li><a href="#provisionclaimoperation">provisionClaimOperation</a></li>
                <li><a href="#provisionclaimoperationexternal">provisionClaimOperationExternal</a></li>
                <li><a href="#syncboundclaim">syncBoundClaim</a></li>
                <li><a href="#bind">bind</a></li>
                <li><a href="#bindvolumetoclaim">bindVolumeToClaim</a></li>
                <li><a href="#bindclaimtovolume">bindClaimToVolume</a></li>
              </ul>
            </li>
            <li><a href="#deleteclaim">deleteClaim</a></li>
          </ul>
        </li>
        <li><a href="#pv-的三种回收策略">PV 的三种回收策略</a>
          <ul>
            <li><a href="#retain-保留策略">Retain： 保留策略</a></li>
            <li><a href="#recycle-重新利用策略">Recycle： 重新利用策略</a></li>
            <li><a href="#delete删除策略">Delete：删除策略</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  
  
</aside>

  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <a href="https://www.zhangzewen.net/">
            <img src="/images/android-chrome-512x512.png" class="img-circle img-headshot center" alt="Profile Picture">
          </a>
        </div>
        
      

      <h1>What a Life!</h1>

      
      <p class="lead">Software Engineer</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="https://www.zhangzewen.net/">Home</a>
        </li>
        <li>
          <a href="/tags/">Tags</a>
        </li><li>
          <a href="/archive/">Archives</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
    </section>
  </div>
</aside>


  <main class="content container">
    <div class="post">
  <h1 class="title">kubernetes 源码分析之 PV Controller</h1>
  
  

  <div class="post-date">
    <time datetime=" 2025-08-29T02:43:31&#43;0800">Created: Aug 29, 2025</time>
    <span class="readtime">&middot; 46 min read</span>
  </div>

  <div>
    <blockquote>
<p>本篇文章基于 Kubernetes v1.25.1</p></blockquote>
<p>PV Controller 的作用是 把 PVC 和 PV 绑定起来，其内部是通过 PersistentVolumeController 实现，通过 NewController 来创建PersistentVolumeController，NewController 主要做了如下几件事情：</p>
<ul>
<li>初始化 eventRecorder</li>
<li>初始化 PersistentVolumeController 对象，</li>
<li>调用 VolumePluginMgr.InitPlugins() 方法 初始化存储插件，代码存在于 pkg/volume/plugins.go 文件中</li>
<li>开始创建 informer 监听集群内的资源，初始化了如下 informer
<ul>
<li>PersistentVolumeInformer</li>
<li>PersistentVolumeClaimInformer</li>
<li>StorageClassInformer</li>
<li>PodInformer</li>
<li>NodeInformer</li>
</ul>
</li>
<li>将 PV &amp; PVC 的 event 分别放入 volumeQueue &amp; claimQueue</li>
<li>为了不每次都迭代 pods ，自定义一个通过 pvc 键索引 pod 的索引器</li>
<li>初始化 intree 存储 -&gt; csi 迁移相关功能的 manager</li>
</ul>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> <span style="color:#fabd2f">NewController</span>(p ControllerParameters) (<span style="color:#fe8019">*</span>PersistentVolumeController, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 初始化eventRecorder</span>
</span></span><span style="display:flex;"><span>	eventRecorder <span style="color:#fe8019">:=</span> p.EventRecorder
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">var</span> eventBroadcaster record.EventBroadcaster
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> eventRecorder <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		eventBroadcaster = record.<span style="color:#fabd2f">NewBroadcaster</span>()
</span></span><span style="display:flex;"><span>		eventRecorder = eventBroadcaster.<span style="color:#fabd2f">NewRecorder</span>(scheme.Scheme, v1.EventSource{Component: <span style="color:#b8bb26">&#34;persistentvolume-controller&#34;</span>})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 构建和初始化PersistentVolumeController</span>
</span></span><span style="display:flex;"><span>	controller <span style="color:#fe8019">:=</span> <span style="color:#fe8019">&amp;</span>PersistentVolumeController{
</span></span><span style="display:flex;"><span>		volumes:                       <span style="color:#fabd2f">newPersistentVolumeOrderedIndex</span>(),
</span></span><span style="display:flex;"><span>		claims:                        cache.<span style="color:#fabd2f">NewStore</span>(cache.DeletionHandlingMetaNamespaceKeyFunc),
</span></span><span style="display:flex;"><span>		kubeClient:                    p.KubeClient,
</span></span><span style="display:flex;"><span>		eventBroadcaster:              eventBroadcaster,
</span></span><span style="display:flex;"><span>		eventRecorder:                 eventRecorder,
</span></span><span style="display:flex;"><span>		runningOperations:             goroutinemap.<span style="color:#fabd2f">NewGoRoutineMap</span>(<span style="color:#fe8019">true</span> <span style="color:#928374;font-style:italic">/* exponentialBackOffOnError */</span>),
</span></span><span style="display:flex;"><span>		cloud:                         p.Cloud,
</span></span><span style="display:flex;"><span>		enableDynamicProvisioning:     p.EnableDynamicProvisioning,
</span></span><span style="display:flex;"><span>		clusterName:                   p.ClusterName,
</span></span><span style="display:flex;"><span>		createProvisionedPVRetryCount: createProvisionedPVRetryCount,
</span></span><span style="display:flex;"><span>		createProvisionedPVInterval:   createProvisionedPVInterval,
</span></span><span style="display:flex;"><span>		claimQueue:                    workqueue.<span style="color:#fabd2f">NewNamed</span>(<span style="color:#b8bb26">&#34;claims&#34;</span>),
</span></span><span style="display:flex;"><span>		volumeQueue:                   workqueue.<span style="color:#fabd2f">NewNamed</span>(<span style="color:#b8bb26">&#34;volumes&#34;</span>),
</span></span><span style="display:flex;"><span>		resyncPeriod:                  p.SyncPeriod,
</span></span><span style="display:flex;"><span>		operationTimestamps:           metrics.<span style="color:#fabd2f">NewOperationStartTimeCache</span>(),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// Prober is nil because PV is not aware of Flexvolume.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">//  初始化存储插件, 需要注意的是PersistentVolumeController实现了VolumeHost，实现了个寂寞，具体可以看volume_host.go这个源码文件</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">:=</span> controller.volumePluginMgr.<span style="color:#fabd2f">InitPlugins</span>(p.VolumePlugins, <span style="color:#fe8019">nil</span> <span style="color:#928374;font-style:italic">/* prober */</span>, controller); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;could not initialize volume plugins for PersistentVolume Controller: %w&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 构建pv Informer</span>
</span></span><span style="display:flex;"><span>	p.VolumeInformer.<span style="color:#fabd2f">Informer</span>().<span style="color:#fabd2f">AddEventHandler</span>(
</span></span><span style="display:flex;"><span>		cache.ResourceEventHandlerFuncs{
</span></span><span style="display:flex;"><span>			AddFunc:    <span style="color:#fe8019">func</span>(obj <span style="color:#fe8019">interface</span>{}) { controller.<span style="color:#fabd2f">enqueueWork</span>(controller.volumeQueue, obj) },
</span></span><span style="display:flex;"><span>			UpdateFunc: <span style="color:#fe8019">func</span>(oldObj, newObj <span style="color:#fe8019">interface</span>{}) { controller.<span style="color:#fabd2f">enqueueWork</span>(controller.volumeQueue, newObj) },
</span></span><span style="display:flex;"><span>			DeleteFunc: <span style="color:#fe8019">func</span>(obj <span style="color:#fe8019">interface</span>{}) { controller.<span style="color:#fabd2f">enqueueWork</span>(controller.volumeQueue, obj) },
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	controller.volumeLister = p.VolumeInformer.<span style="color:#fabd2f">Lister</span>()
</span></span><span style="display:flex;"><span>	controller.volumeListerSynced = p.VolumeInformer.<span style="color:#fabd2f">Informer</span>().HasSynced
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 构建pvc informer</span>
</span></span><span style="display:flex;"><span>	p.ClaimInformer.<span style="color:#fabd2f">Informer</span>().<span style="color:#fabd2f">AddEventHandler</span>(
</span></span><span style="display:flex;"><span>		cache.ResourceEventHandlerFuncs{
</span></span><span style="display:flex;"><span>			AddFunc:    <span style="color:#fe8019">func</span>(obj <span style="color:#fe8019">interface</span>{}) { controller.<span style="color:#fabd2f">enqueueWork</span>(controller.claimQueue, obj) },
</span></span><span style="display:flex;"><span>			UpdateFunc: <span style="color:#fe8019">func</span>(oldObj, newObj <span style="color:#fe8019">interface</span>{}) { controller.<span style="color:#fabd2f">enqueueWork</span>(controller.claimQueue, newObj) },
</span></span><span style="display:flex;"><span>			DeleteFunc: <span style="color:#fe8019">func</span>(obj <span style="color:#fe8019">interface</span>{}) { controller.<span style="color:#fabd2f">enqueueWork</span>(controller.claimQueue, obj) },
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	controller.claimLister = p.ClaimInformer.<span style="color:#fabd2f">Lister</span>()
</span></span><span style="display:flex;"><span>	controller.claimListerSynced = p.ClaimInformer.<span style="color:#fabd2f">Informer</span>().HasSynced
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// sorageclass lister</span>
</span></span><span style="display:flex;"><span>	controller.classLister = p.ClassInformer.<span style="color:#fabd2f">Lister</span>()
</span></span><span style="display:flex;"><span>	controller.classListerSynced = p.ClassInformer.<span style="color:#fabd2f">Informer</span>().HasSynced
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// pod lister</span>
</span></span><span style="display:flex;"><span>	controller.podLister = p.PodInformer.<span style="color:#fabd2f">Lister</span>()
</span></span><span style="display:flex;"><span>	controller.podIndexer = p.PodInformer.<span style="color:#fabd2f">Informer</span>().<span style="color:#fabd2f">GetIndexer</span>()
</span></span><span style="display:flex;"><span>	controller.podListerSynced = p.PodInformer.<span style="color:#fabd2f">Informer</span>().HasSynced
</span></span><span style="display:flex;"><span>    <span style="color:#8ec07c">//node lister</span>
</span></span><span style="display:flex;"><span>	controller.NodeLister = p.NodeInformer.<span style="color:#fabd2f">Lister</span>()
</span></span><span style="display:flex;"><span>	controller.NodeListerSynced = p.NodeInformer.<span style="color:#fabd2f">Informer</span>().HasSynced
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// This custom indexer will index pods by its PVC keys. Then we don&#39;t need</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// to iterate all pods every time to find pods which reference given PVC.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 添加索引，可以通过pvc找到pod， pvc的key是namespace+pvc_name， 对于特性EphemeralVolume则是namespace+pod_name_+pvc_name </span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">:=</span> common.<span style="color:#fabd2f">AddPodPVCIndexerIfNotPresent</span>(controller.podIndexer); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;could not initialize attach detach controller: %w&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	csiTranslator <span style="color:#fe8019">:=</span> csitrans.<span style="color:#fabd2f">New</span>()
</span></span><span style="display:flex;"><span>	controller.translator = csiTranslator
</span></span><span style="display:flex;"><span>	controller.csiMigratedPluginManager = csimigration.<span style="color:#fabd2f">NewPluginManager</span>(csiTranslator, utilfeature.DefaultFeatureGate)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	controller.filteredDialOptions = p.FilteredDialOptions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> controller, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h2 id="run">Run</h2>
<p>在调用 NewController 创建成功之后调用 Run 方法运行，其流程如下：</p>
<ul>
<li>等 pv, pvc, sc 的informer cache 同步就位。</li>
<li>初始化 PersistentVolumeController 自己内部的 pv cache和 pvc cache。</li>
<li>启动三个协程分别运行： resync, volumeWorker, claimWorker。</li>
</ul>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">Run</span>(ctx context.Context) {
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">defer</span> utilruntime.<span style="color:#fabd2f">HandleCrash</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">defer</span> ctrl.claimQueue.<span style="color:#fabd2f">ShutDown</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">defer</span> ctrl.volumeQueue.<span style="color:#fabd2f">ShutDown</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// Start events processing pipeline.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> ctrl.eventBroadcaster <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		ctrl.eventBroadcaster.<span style="color:#fabd2f">StartStructuredLogging</span>(<span style="color:#d3869b">0</span>)
</span></span><span style="display:flex;"><span>		ctrl.eventBroadcaster.<span style="color:#fabd2f">StartRecordingToSink</span>(<span style="color:#fe8019">&amp;</span>v1core.EventSinkImpl{Interface: ctrl.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">Events</span>(<span style="color:#b8bb26">&#34;&#34;</span>)})
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">defer</span> ctrl.eventBroadcaster.<span style="color:#fabd2f">Shutdown</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	klog.<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Starting persistent volume controller&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">defer</span> klog.<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Shutting down persistent volume controller&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> !cache.<span style="color:#fabd2f">WaitForNamedCacheSync</span>(<span style="color:#b8bb26">&#34;persistent volume&#34;</span>, ctx.<span style="color:#fabd2f">Done</span>(), ctrl.volumeListerSynced, ctrl.claimListerSynced, ctrl.classListerSynced, ctrl.podListerSynced, ctrl.NodeListerSynced) {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ctrl.<span style="color:#fabd2f">initializeCaches</span>(ctrl.volumeLister, ctrl.claimLister)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">go</span> wait.<span style="color:#fabd2f">Until</span>(ctrl.resync, ctrl.resyncPeriod, ctx.<span style="color:#fabd2f">Done</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">go</span> wait.<span style="color:#fabd2f">UntilWithContext</span>(ctx, ctrl.volumeWorker, time.Second)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">go</span> wait.<span style="color:#fabd2f">UntilWithContext</span>(ctx, ctrl.claimWorker, time.Second)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	metrics.<span style="color:#fabd2f">Register</span>(ctrl.volumes.store, ctrl.claims, <span style="color:#fe8019">&amp;</span>ctrl.volumePluginMgr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">&lt;-</span>ctx.<span style="color:#fabd2f">Done</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">initializeCaches</span>(volumeLister corelisters.PersistentVolumeLister, claimLister corelisters.PersistentVolumeClaimLister) {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 填充内部的pv cache， PersistentVolumeController.volums</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 这里不访问 apiserver，是从本地缓存拿出的对象，这些对象不可以被外部函数修改</span>
</span></span><span style="display:flex;"><span>	volumeList, err <span style="color:#fe8019">:=</span> volumeLister.<span style="color:#fabd2f">List</span>(labels.<span style="color:#fabd2f">Everything</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;PersistentVolumeController can&#39;t initialize caches: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">for</span> _, volume <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> volumeList {
</span></span><span style="display:flex;"><span>		volumeClone <span style="color:#fe8019">:=</span> volume.<span style="color:#fabd2f">DeepCopy</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> _, err = ctrl.<span style="color:#fabd2f">storeVolumeUpdate</span>(volumeClone); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;error updating volume cache: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 填充内部的pvc cache， PersistentVolumeController.claims</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 这里不访问 apiserver，是从本地缓存拿出的对象，这些对象不可以被外部函数修改</span>
</span></span><span style="display:flex;"><span>	claimList, err <span style="color:#fe8019">:=</span> claimLister.<span style="color:#fabd2f">List</span>(labels.<span style="color:#fabd2f">Everything</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;PersistentVolumeController can&#39;t initialize caches: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">for</span> _, claim <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> claimList {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> _, err = ctrl.<span style="color:#fabd2f">storeClaimUpdate</span>(claim.<span style="color:#fabd2f">DeepCopy</span>()); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;error updating claim cache: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;controller initialized&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h2 id="生产者协程resync">生产者协程：resync</h2>
<p>resync方法十分简单，主要作用是定时循环拉取 pv 和 pvc ，然后放入到队列 volumeQueue 和 claimQueue 中，供 volumeWorker 和 claimWorker 进行消费：</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">resync</span>() {
</span></span><span style="display:flex;"><span>	klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;resyncing PV controller&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pvcs, err <span style="color:#fe8019">:=</span> ctrl.claimLister.<span style="color:#fabd2f">List</span>(labels.<span style="color:#fabd2f">NewSelector</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Warningf</span>(<span style="color:#b8bb26">&#34;cannot list claims: %s&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">for</span> _, pvc <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> pvcs {
</span></span><span style="display:flex;"><span>		ctrl.<span style="color:#fabd2f">enqueueWork</span>(ctrl.claimQueue, pvc)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pvs, err <span style="color:#fe8019">:=</span> ctrl.volumeLister.<span style="color:#fabd2f">List</span>(labels.<span style="color:#fabd2f">NewSelector</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Warningf</span>(<span style="color:#b8bb26">&#34;cannot list persistent volumes: %s&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">for</span> _, pv <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> pvs {
</span></span><span style="display:flex;"><span>		ctrl.<span style="color:#fabd2f">enqueueWork</span>(ctrl.volumeQueue, pv)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="消费者协程volumeworker">消费者协程：volumeWorker</h2>
<p>volumeWorker 从 volumeQ 中拿到pv：</p>
<ul>
<li>如果 pv 在 informer cacher 中有记录的话，调用 <a href="#updateVolume">updateVolume</a>来进行更新。</li>
<li>如果 pv 不在 informer cacher，且本地记录缓存中有记录的化，则调用 <a href="#deleteVolume">deleteVolume</a>来进行更新。</li>
</ul>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">volumeWorker</span>(ctx context.Context) {
</span></span><span style="display:flex;"><span>	workFunc <span style="color:#fe8019">:=</span> <span style="color:#fe8019">func</span>(ctx context.Context) <span style="color:#fabd2f">bool</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 丛volumeQ中拿到pv</span>
</span></span><span style="display:flex;"><span>		keyObj, quit <span style="color:#fe8019">:=</span> ctrl.volumeQueue.<span style="color:#fabd2f">Get</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> quit {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">defer</span> ctrl.volumeQueue.<span style="color:#fabd2f">Done</span>(keyObj)
</span></span><span style="display:flex;"><span>		key <span style="color:#fe8019">:=</span> keyObj.(<span style="color:#fabd2f">string</span>)
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volumeWorker[%s]&#34;</span>, key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       <span style="color:#928374;font-style:italic">// 获取pvName</span>
</span></span><span style="display:flex;"><span>		_, name, err <span style="color:#fe8019">:=</span> cache.<span style="color:#fabd2f">SplitMetaNamespaceKey</span>(key)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error getting name of volume %q to get volume from informer: %v&#34;</span>, key, err)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 获取pvObj</span>
</span></span><span style="display:flex;"><span>		volume, err <span style="color:#fe8019">:=</span> ctrl.volumeLister.<span style="color:#fabd2f">Get</span>(name)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// The volume still exists in informer cache, the event must have</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// been add/update/sync</span>
</span></span><span style="display:flex;"><span>			ctrl.<span style="color:#fabd2f">updateVolume</span>(ctx, volume)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> !errors.<span style="color:#fabd2f">IsNotFound</span>(err) {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error getting volume %q from informer: %v&#34;</span>, key, err)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// The volume is not in informer cache, the event must have been</span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// &#34;delete&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// informer cache中已经不存在pvObj了， 说明集群中已经没有pv资源了，本地缓存需要删除该pv的记录</span>
</span></span><span style="display:flex;"><span>		volumeObj, found, err <span style="color:#fe8019">:=</span> ctrl.volumes.store.<span style="color:#fabd2f">GetByKey</span>(key)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error getting volume %q from cache: %v&#34;</span>, key, err)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> !found {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// The controller has already processed the delete event and</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// deleted the volume from its cache</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;deletion of volume %q was already processed&#34;</span>, key)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		volume, ok <span style="color:#fe8019">:=</span> volumeObj.(<span style="color:#fe8019">*</span>v1.PersistentVolume)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> !ok {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;expected volume, got %+v&#34;</span>, volumeObj)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		ctrl.<span style="color:#fabd2f">deleteVolume</span>(volume)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> quit <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">workFunc</span>(ctx); quit {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume worker queue shutting down&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h3 id="updatevolume">updateVolume</h3>
<p>deleteVolume 的逻辑很明了：</p>
<ul>
<li>更新本地的缓存中的记录。</li>
<li>调用 <a href="#syncVolume">syncVolume</a> 来进行同步。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// updateVolume runs in worker thread and handles &#34;volume added&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// &#34;volume updated&#34; and &#34;periodic sync&#34; events.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">updateVolume</span>(ctx context.Context, volume <span style="color:#fe8019">*</span>v1.PersistentVolume) {
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// Store the new volume version in the cache and do not process it if this</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// is an old version.</span>
</span></span><span style="display:flex;"><span>	new, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">storeVolumeUpdate</span>(volume)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;%v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> !new {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	err = ctrl.<span style="color:#fabd2f">syncVolume</span>(ctx, volume)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> errors.<span style="color:#fabd2f">IsConflict</span>(err) {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Version conflict error happens quite often and the controller</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// recovers from it easily.</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;could not sync volume %q: %+v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;could not sync volume %q: %+v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="deletevolume">deleteVolume</h3>
<p>deleteVolume 的逻辑很简单：</p>
<ul>
<li>把本地的缓存中的记录删除。</li>
<li>然后把与之绑定的 PVC 加入到 claimQ 中。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">deleteVolume</span>(volume <span style="color:#fe8019">*</span>v1.PersistentVolume) {
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">:=</span> ctrl.volumes.store.<span style="color:#fabd2f">Delete</span>(volume); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;volume %q deletion encountered : %v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>	} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q deleted&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	metrics.<span style="color:#fabd2f">RecordMetric</span>(volume.Name, <span style="color:#fe8019">&amp;</span>ctrl.operationTimestamps, <span style="color:#fe8019">nil</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> volume.Spec.ClaimRef <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	claimKey <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef)
</span></span><span style="display:flex;"><span>	klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;deleteVolume[%s]: scheduling sync of claim %q&#34;</span>, volume.Name, claimKey)
</span></span><span style="display:flex;"><span>	ctrl.claimQueue.<span style="color:#fabd2f">Add</span>(claimKey)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="syncvolume">syncVolume</h3>
<p>syncVolume 的会根据不同情况做不同的逻辑：</p>
<ul>
<li>如果 pv 的 ClaimRef 有没有被赋值，则更新状态为Available。</li>
<li>如果 pv 的 ClaimRef 被赋值，校验UID，UID为空说明 pv 绑定了 pvc，但是 pvc 却没有绑定 pv，需要重新设置 pv 的状态为Available。</li>
<li>如果 pv 找到了对应的 pvc，比较UID是否相等，如果不相等，那么说明不是被绑定的那个 pvc，可以认为 pvc 是被删除了，那么需要更新释放pv，将 pv 的状态改为Released。</li>
<li>检查 VolumeName 是否为空，这种情况是表明正在绑定中。</li>
<li>如果 pvc 的 VolumeName 等于pv 的 name，说明已经绑定，更新状态为Bound；否则表示 pv 绑定到 pvc 上，但是 pvc 被绑定到其他 pv 上，检查是否是 dynamically provisioned 自动生成的，如果是的话就释放这个pv；如果是手动创建的 pv，那么调用 unbindVolume 进行解绑。</li>
</ul>
<p>对claim进行校验之后会继续；</p>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">syncVolume</span>(ctx context.Context, volume <span style="color:#fe8019">*</span>v1.PersistentVolume) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>	klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: %s&#34;</span>, volume.Name, <span style="color:#fabd2f">getVolumeStatusForLogging</span>(volume))
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// Set correct &#34;migrated-to&#34; annotations and modify finalizers on PV and update in API server if</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// necessary</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// CSI Driver migration相关</span>
</span></span><span style="display:flex;"><span>	newVolume, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">updateVolumeMigrationAnnotationsAndFinalizers</span>(ctx, volume)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// Nothing was saved; we will fall back into the same</span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// condition in the next call to this method</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	volume = newVolume
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// [Unit test set 4]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8ec07c">//如果 claimRef 未设置，则是未使用过的 pv，则调用 updateVolumePhase 函数更新状态设置 phase 为 available</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> volume.Spec.ClaimRef <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// Volume is unused</span>
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: volume is unused&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> _, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">updateVolumePhase</span>(volume, v1.VolumeAvailable, <span style="color:#b8bb26">&#34;&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Nothing was saved; we will fall back into the same</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// condition in the next call to this method</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#fe8019">else</span> <span style="color:#928374;font-style:italic">/* pv.Spec.ClaimRef != nil */</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// Volume is bound to a claim.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8ec07c">//正在被bound中，更新状态available</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> volume.Spec.ClaimRef.UID <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// The PV is reserved for a PVC; that PVC has not yet been</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// bound to this PV; the PVC sync will handle it.</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: volume is pre-bound to claim %s&#34;</span>, volume.Name, <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef))
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> _, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">updateVolumePhase</span>(volume, v1.VolumeAvailable, <span style="color:#b8bb26">&#34;&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Nothing was saved; we will fall back into the same</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// condition in the next call to this method</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: volume is bound to claim %s&#34;</span>, volume.Name, <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef))
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// Get the PVC by _name_</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">var</span> claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">/</span>根据 pv 的 claimRef 获得 pvc
</span></span><span style="display:flex;"><span>		claimName <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef)
</span></span><span style="display:flex;"><span>		obj, found, err <span style="color:#fe8019">:=</span> ctrl.claims.<span style="color:#fabd2f">GetByKey</span>(claimName)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> !found {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// If the PV was created by an external PV provisioner or</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// bound by external PV binder (e.g. kube-scheduler), it&#39;s</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// possible under heavy load that the corresponding PVC is not synced to</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// controller local cache yet. So we need to double-check PVC in</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">//   1) informer cache</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">//   2) apiserver if not found in informer cache</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// to make sure we will not reclaim a PV wrongly.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Note that only non-released and non-failed volumes will be</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// updated to Released state when PVC does not exist.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> volume.Status.Phase <span style="color:#fe8019">!=</span> v1.VolumeReleased <span style="color:#fe8019">&amp;&amp;</span> volume.Status.Phase <span style="color:#fe8019">!=</span> v1.VolumeFailed {
</span></span><span style="display:flex;"><span>				obj, err = ctrl.claimLister.<span style="color:#fabd2f">PersistentVolumeClaims</span>(volume.Spec.ClaimRef.Namespace).<span style="color:#fabd2f">Get</span>(volume.Spec.ClaimRef.Name)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">&amp;&amp;</span> !apierrors.<span style="color:#fabd2f">IsNotFound</span>(err) {
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				found = !apierrors.<span style="color:#fabd2f">IsNotFound</span>(err)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> !found {
</span></span><span style="display:flex;"><span>					obj, err = ctrl.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">PersistentVolumeClaims</span>(volume.Spec.ClaimRef.Namespace).<span style="color:#fabd2f">Get</span>(context.<span style="color:#fabd2f">TODO</span>(), volume.Spec.ClaimRef.Name, metav1.GetOptions{})
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">&amp;&amp;</span> !apierrors.<span style="color:#fabd2f">IsNotFound</span>(err) {
</span></span><span style="display:flex;"><span>						<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					found = !apierrors.<span style="color:#fabd2f">IsNotFound</span>(err)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> !found {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: claim %s not found&#34;</span>, volume.Name, <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef))
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Fall through with claim = nil</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">var</span> ok <span style="color:#fabd2f">bool</span>
</span></span><span style="display:flex;"><span>			claim, ok = obj.(<span style="color:#fe8019">*</span>v1.PersistentVolumeClaim)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> !ok {
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;cannot convert object from volume cache to volume %q!?: %#v&#34;</span>, claim.Spec.VolumeName, obj)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: claim %s found: %s&#34;</span>, volume.Name, <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef), <span style="color:#fabd2f">getClaimStatusForLogging</span>(claim))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> claim <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">&amp;&amp;</span> claim.UID <span style="color:#fe8019">!=</span> volume.Spec.ClaimRef.UID {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// The claim that the PV was pointing to was deleted, and another</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// with the same name created.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// in some cases, the cached claim is not the newest, and the volume.Spec.ClaimRef.UID is newer than cached.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// so we should double check by calling apiserver and get the newest claim, then compare them.</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Maybe cached claim: %s is not the newest one, we should fetch it from apiserver&#34;</span>, <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			claim, err = ctrl.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">PersistentVolumeClaims</span>(volume.Spec.ClaimRef.Namespace).<span style="color:#fabd2f">Get</span>(context.<span style="color:#fabd2f">TODO</span>(), volume.Spec.ClaimRef.Name, metav1.GetOptions{})
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">&amp;&amp;</span> !apierrors.<span style="color:#fabd2f">IsNotFound</span>(err) {
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>			} <span style="color:#fe8019">else</span> <span style="color:#fe8019">if</span> claim <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Treat the volume as bound to a missing claim.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> claim.UID <span style="color:#fe8019">!=</span> volume.Spec.ClaimRef.UID {
</span></span><span style="display:flex;"><span>					klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: claim %s has a newer UID than pv.ClaimRef, the old one must have been deleted&#34;</span>, volume.Name, <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef))
</span></span><span style="display:flex;"><span>					claim = <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>				} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>					klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: claim %s has a same UID with pv.ClaimRef&#34;</span>, volume.Name, <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef))
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>        <span style="color:#8ec07c">//claim可能被删除了，或者pv被删除了</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> claim <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// If we get into this block, the claim must have been deleted;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// NOTE: reclaimVolume may either release the PV back into the pool or</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// recycle it or do nothing (retain)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Do not overwrite previous Failed state - let the user see that</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// something went wrong, while we still re-try to reclaim the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// volume.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> volume.Status.Phase <span style="color:#fe8019">!=</span> v1.VolumeReleased <span style="color:#fe8019">&amp;&amp;</span> volume.Status.Phase <span style="color:#fe8019">!=</span> v1.VolumeFailed {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Also, log this only once:</span>
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q is released and reclaim policy %q will be executed&#34;</span>, volume.Name, volume.Spec.PersistentVolumeReclaimPolicy)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> volume, err = ctrl.<span style="color:#fabd2f">updateVolumePhase</span>(volume, v1.VolumeReleased, <span style="color:#b8bb26">&#34;&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// Nothing was saved; we will fall back into the same condition</span>
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// in the next call to this method</span>
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>            <span style="color:#8ec07c">//根据 persistentVolumeReclaimPolicy 配置做相应的处理，Retain/Delete/Recycle</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">reclaimVolume</span>(volume); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Release failed, we will fall back into the same condition</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// in the next call to this method</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> volume.Spec.PersistentVolumeReclaimPolicy <span style="color:#fe8019">==</span> v1.PersistentVolumeReclaimRetain {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// volume is being retained, it references a claim that does not exist now.</span>
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;PersistentVolume[%s] references a claim %q (%s) that is not found&#34;</span>, volume.Name, <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef), volume.Spec.ClaimRef.UID)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> <span style="color:#fe8019">if</span> claim.Spec.VolumeName <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> storagehelpers.<span style="color:#fabd2f">CheckVolumeModeMismatches</span>(<span style="color:#fe8019">&amp;</span>claim.Spec, <span style="color:#fe8019">&amp;</span>volume.Spec) {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Binding for the volume won&#39;t be called in syncUnboundClaim,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// because findBestMatchForClaim won&#39;t return the volume due to volumeMode mismatch.</span>
</span></span><span style="display:flex;"><span>				volumeMsg <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Cannot bind PersistentVolume to requested PersistentVolumeClaim %q due to incompatible volumeMode.&#34;</span>, claim.Name)
</span></span><span style="display:flex;"><span>				ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(volume, v1.EventTypeWarning, events.VolumeMismatch, volumeMsg)
</span></span><span style="display:flex;"><span>				claimMsg <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Cannot bind PersistentVolume %q to requested PersistentVolumeClaim due to incompatible volumeMode.&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>				ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.VolumeMismatch, claimMsg)
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Skipping syncClaim</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> metav1.<span style="color:#fabd2f">HasAnnotation</span>(volume.ObjectMeta, storagehelpers.AnnBoundByController) {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// The binding is not completed; let PVC sync handle it</span>
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: volume not bound yet, waiting for syncClaim to fix it&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>			} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Dangling PV; try to re-establish the link in the PVC sync</span>
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: volume was bound and got unbound (by user?), waiting for syncClaim to fix it&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// In both cases, the volume is Bound and the claim is Pending.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Next syncClaim will fix it. To speed it up, we enqueue the claim</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// into the controller, which results in syncClaim to be called</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// shortly (and in the right worker goroutine).</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// This speeds up binding of provisioned volumes - provisioner saves</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// only the new PV and it expects that next syncClaim will bind the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// claim to it.</span>
</span></span><span style="display:flex;"><span>			ctrl.claimQueue.<span style="color:#fabd2f">Add</span>(<span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> <span style="color:#fe8019">if</span> claim.Spec.VolumeName <span style="color:#fe8019">==</span> volume.Name { <span style="color:#928374;font-style:italic">// 已经绑定更新状态为Bound</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Volume is bound to a claim properly, update status if necessary</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: all is bound&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> _, err = ctrl.<span style="color:#fabd2f">updateVolumePhase</span>(volume, v1.VolumeBound, <span style="color:#b8bb26">&#34;&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Nothing was saved; we will fall back into the same</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// condition in the next call to this method</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> {<span style="color:#928374;font-style:italic">// pv绑定到pvc上，但是pvc被绑定到其他pv上，重置                  </span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Volume is bound to a claim, but the claim is bound elsewhere</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> metav1.<span style="color:#fabd2f">HasAnnotation</span>(volume.ObjectMeta, storagehelpers.AnnDynamicallyProvisioned) <span style="color:#fe8019">&amp;&amp;</span> volume.Spec.PersistentVolumeReclaimPolicy <span style="color:#fe8019">==</span> v1.PersistentVolumeReclaimDelete {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// This volume was dynamically provisioned for this claim. The</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// claim got bound elsewhere, and thus this volume is not</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// needed. Delete it.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Mark the volume as Released for external deleters and to let</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// the user know. Don&#39;t overwrite existing Failed status!</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> volume.Status.Phase <span style="color:#fe8019">!=</span> v1.VolumeReleased <span style="color:#fe8019">&amp;&amp;</span> volume.Status.Phase <span style="color:#fe8019">!=</span> v1.VolumeFailed {
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// Also, log this only once:</span>
</span></span><span style="display:flex;"><span>					klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;dynamically volume %q is released and it will be deleted&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">if</span> volume, err = ctrl.<span style="color:#fabd2f">updateVolumePhase</span>(volume, v1.VolumeReleased, <span style="color:#b8bb26">&#34;&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#928374;font-style:italic">// Nothing was saved; we will fall back into the same condition</span>
</span></span><span style="display:flex;"><span>						<span style="color:#928374;font-style:italic">// in the next call to this method</span>
</span></span><span style="display:flex;"><span>						<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">reclaimVolume</span>(volume); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// Deletion failed, we will fall back into the same condition</span>
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// in the next call to this method</span>
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>			} <span style="color:#fe8019">else</span> { 
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Volume is bound to a claim, but the claim is bound elsewhere</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// and it&#39;s not dynamically provisioned.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> metav1.<span style="color:#fabd2f">HasAnnotation</span>(volume.ObjectMeta, storagehelpers.AnnBoundByController) {
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// This is part of the normal operation of the controller; the</span>
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// controller tried to use this volume for a claim but the claim</span>
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// was fulfilled by another volume. We did this; fix it.</span>
</span></span><span style="display:flex;"><span>					klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: volume is bound by controller to a claim that is bound to another volume, unbinding&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">unbindVolume</span>(volume); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>				} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// The PV must have been created with this ptr; leave it alone.</span>
</span></span><span style="display:flex;"><span>					klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolume[%s]: volume is bound by user to a claim that is bound to another volume, waiting for the claim to get unbound&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// This just updates the volume phase and clears</span>
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// volume.Spec.ClaimRef.UID. It leaves the volume pre-bound</span>
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// to the claim.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">unbindVolume</span>(volume); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h3 id="reclaimvolume">reclaimVolume</h3>
<p>reclaimVolume 方法会根据 persistentVolumeReclaimPolicy 做相应的处理：</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">reclaimVolume</span>(volume <span style="color:#fe8019">*</span>v1.PersistentVolume) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> migrated <span style="color:#fe8019">:=</span> volume.Annotations[storagehelpers.AnnMigratedTo]; <span style="color:#fabd2f">len</span>(migrated) &gt; <span style="color:#d3869b">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// PV is Migrated. The PV controller should stand down and the external</span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// provisioner will handle this PV</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">switch</span> volume.Spec.PersistentVolumeReclaimPolicy {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 允许手动回收资源，当 pvc 被删除后，pv 仍然可以存在，管理员可以手动的执行删除 pv</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">case</span> v1.PersistentVolumeReclaimRetain:
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;reclaimVolume[%s]: policy is Retain, nothing to do&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 回收pv，如果没有pod在使用pv，那么将该pv的状态设置为Available</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">case</span> v1.PersistentVolumeReclaimRecycle:
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;reclaimVolume[%s]: policy is Recycle&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>		opName <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;recycle-%s[%s]&#34;</span>, volume.Name, <span style="color:#fabd2f">string</span>(volume.UID))
</span></span><span style="display:flex;"><span>		ctrl.<span style="color:#fabd2f">scheduleOperation</span>(opName, <span style="color:#fe8019">func</span>() <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>			ctrl.<span style="color:#fabd2f">recycleVolumeOperation</span>(volume)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// pvc被删除之后，pv 也会被删除</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">case</span> v1.PersistentVolumeReclaimDelete:
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;reclaimVolume[%s]: policy is Delete&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>		opName <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;delete-%s[%s]&#34;</span>, volume.Name, <span style="color:#fabd2f">string</span>(volume.UID))
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// create a start timestamp entry in cache for deletion operation if no one exists with</span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// key = volume.Name, pluginName = provisionerName, operation = &#34;delete&#34;</span>
</span></span><span style="display:flex;"><span>		ctrl.operationTimestamps.<span style="color:#fabd2f">AddIfNotExist</span>(volume.Name, ctrl.<span style="color:#fabd2f">getProvisionerNameFromVolume</span>(volume), <span style="color:#b8bb26">&#34;delete&#34;</span>)
</span></span><span style="display:flex;"><span>		ctrl.<span style="color:#fabd2f">scheduleOperation</span>(opName, <span style="color:#fe8019">func</span>() <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>			_, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">deleteVolumeOperation</span>(volume)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// only report error count to &#34;volume_operation_total_errors&#34;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// latency reporting will happen when the volume get finally</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// deleted and a volume deleted event is captured</span>
</span></span><span style="display:flex;"><span>				metrics.<span style="color:#fabd2f">RecordMetric</span>(volume.Name, <span style="color:#fe8019">&amp;</span>ctrl.operationTimestamps, err)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>		})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// Unknown PersistentVolumeReclaimPolicy</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> _, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">updateVolumePhaseWithEvent</span>(volume, v1.VolumeFailed, v1.EventTypeWarning, <span style="color:#b8bb26">&#34;VolumeUnknownReclaimPolicy&#34;</span>, <span style="color:#b8bb26">&#34;Volume has unrecognized PersistentVolumeReclaimPolicy&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="消费者协程claimworker">消费者协程：claimWorker</h2>
<p>cliamWorker 在每次被循环调用的时候会：</p>
<ul>
<li>如果在informer cache中，调用 <a href="#updateClaim">updateClaim</a> 来看看可不可以更新 pvc 的状态。</li>
<li>如果不再informer cache中，说明被删除了，就需要通过 <a href="#deleteClaim">deleteClaim</a> 来更新状态，以及本地缓存。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">claimWorker</span>(ctx context.Context) {
</span></span><span style="display:flex;"><span>	workFunc <span style="color:#fe8019">:=</span> <span style="color:#fe8019">func</span>() <span style="color:#fabd2f">bool</span> {
</span></span><span style="display:flex;"><span>		keyObj, quit <span style="color:#fe8019">:=</span> ctrl.claimQueue.<span style="color:#fabd2f">Get</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> quit {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">true</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">defer</span> ctrl.claimQueue.<span style="color:#fabd2f">Done</span>(keyObj)
</span></span><span style="display:flex;"><span>		key <span style="color:#fe8019">:=</span> keyObj.(<span style="color:#fabd2f">string</span>)
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;claimWorker[%s]&#34;</span>, key)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 就是namespace+pvc_name字符串的拆分</span>
</span></span><span style="display:flex;"><span>		namespace, name, err <span style="color:#fe8019">:=</span> cache.<span style="color:#fabd2f">SplitMetaNamespaceKey</span>(key)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error getting namespace &amp; name of claim %q to get claim from informer: %v&#34;</span>, key, err)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 看看informer cache里面是不是有pvc，如果有，执行updateClaim来更新状态</span>
</span></span><span style="display:flex;"><span>		claim, err <span style="color:#fe8019">:=</span> ctrl.claimLister.<span style="color:#fabd2f">PersistentVolumeClaims</span>(namespace).<span style="color:#fabd2f">Get</span>(name)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// The claim still exists in informer cache, the event must have</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// been add/update/sync</span>
</span></span><span style="display:flex;"><span>			ctrl.<span style="color:#fabd2f">updateClaim</span>(ctx, claim)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> !errors.<span style="color:#fabd2f">IsNotFound</span>(err) {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error getting claim %q from informer: %v&#34;</span>, key, err)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// The claim is not in informer cache, the event must have been &#34;delete&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 到这里说明不存在informer cache里了，下面就要来判断是不是在本地缓存中</span>
</span></span><span style="display:flex;"><span>		claimObj, found, err <span style="color:#fe8019">:=</span> ctrl.claims.<span style="color:#fabd2f">GetByKey</span>(key)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error getting claim %q from cache: %v&#34;</span>, key, err)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> !found {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// The controller has already processed the delete event and</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// deleted the claim from its cache</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;deletion of claim %q was already processed&#34;</span>, key)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 如果在的话，就需要更新本地缓存了</span>
</span></span><span style="display:flex;"><span>		claim, ok <span style="color:#fe8019">:=</span> claimObj.(<span style="color:#fe8019">*</span>v1.PersistentVolumeClaim)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> !ok {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;expected claim, got %+v&#34;</span>, claimObj)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		ctrl.<span style="color:#fabd2f">deleteClaim</span>(claim)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> quit <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">workFunc</span>(); quit {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;claim worker queue shutting down&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="updateclaim">updateClaim</h3>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// updateClaim runs in worker thread and handles &#34;claim added&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// &#34;claim updated&#34; and &#34;periodic sync&#34; events.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">updateClaim</span>(ctx context.Context, claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim) {
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// Store the new claim version in the cache and do not process it if this is</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// an old version.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 上来先更新本地缓存，返回值new表示更新成功（新增/更新），方法注释看下面</span>
</span></span><span style="display:flex;"><span>	new, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">storeClaimUpdate</span>(claim)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;%v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 不是新增/更新，直接返回</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> !new {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 这里就需要重新同步pvc的信息了</span>
</span></span><span style="display:flex;"><span>	err = ctrl.<span style="color:#fabd2f">syncClaim</span>(ctx, claim)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> errors.<span style="color:#fabd2f">IsConflict</span>(err) {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Version conflict error happens quite often and the controller</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// recovers from it easily.</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;could not sync claim %q: %+v&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;could not sync volume %q: %+v&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">storeClaimUpdate</span>(claim <span style="color:#fe8019">interface</span>{}) (<span style="color:#fabd2f">bool</span>, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> <span style="color:#fabd2f">storeObjectUpdate</span>(ctrl.claims, claim, <span style="color:#b8bb26">&#34;claim&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// storeObjectUpdate updates given cache with a new object version from Informer</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// callback (i.e. with events from etcd) or with an object modified by the</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// controller itself. Returns &#34;true&#34;, if the cache was updated, false if the</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// object is an old version and should be ignored.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> <span style="color:#fabd2f">storeObjectUpdate</span>(store cache.Store, obj <span style="color:#fe8019">interface</span>{}, className <span style="color:#fabd2f">string</span>) (<span style="color:#fabd2f">bool</span>, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 获取key</span>
</span></span><span style="display:flex;"><span>	objName, err <span style="color:#fe8019">:=</span> controller.<span style="color:#fabd2f">KeyFunc</span>(obj)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;couldn&#39;t get key for object %+v: %w&#34;</span>, obj, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 看是否在本地cache中存在</span>
</span></span><span style="display:flex;"><span>	oldObj, found, err <span style="color:#fe8019">:=</span> store.<span style="color:#fabd2f">Get</span>(obj)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;error finding %s %q in controller cache: %w&#34;</span>, className, objName, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 提供操作传入的参数pvc的方法</span>
</span></span><span style="display:flex;"><span>	objAccessor, err <span style="color:#fe8019">:=</span> meta.<span style="color:#fabd2f">Accessor</span>(obj)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 本地cache中不存在，说明是新增加的pvc，这里需要把新增加的pvc更新到本地cache里，然后函数返回</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> !found {
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// This is a new object</span>
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;storeObjectUpdate: adding %s %q, version %s&#34;</span>, className, objName, objAccessor.<span style="color:#fabd2f">GetResourceVersion</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err = store.<span style="color:#fabd2f">Add</span>(obj); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;error adding %s %q to controller cache: %w&#34;</span>, className, objName, err)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">true</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 到这里说明本地cache里已经存在了namespace+pvc_name的oldpvc， 需要操作该oldpvc</span>
</span></span><span style="display:flex;"><span>	oldObjAccessor, err <span style="color:#fe8019">:=</span> meta.<span style="color:#fabd2f">Accessor</span>(oldObj)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 先获取传入pvc的rv以及oldpvc的rv，就是版本号</span>
</span></span><span style="display:flex;"><span>	objResourceVersion, err <span style="color:#fe8019">:=</span> strconv.<span style="color:#fabd2f">ParseInt</span>(objAccessor.<span style="color:#fabd2f">GetResourceVersion</span>(), <span style="color:#d3869b">10</span>, <span style="color:#d3869b">64</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;error parsing ResourceVersion %q of %s %q: %s&#34;</span>, objAccessor.<span style="color:#fabd2f">GetResourceVersion</span>(), className, objName, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	oldObjResourceVersion, err <span style="color:#fe8019">:=</span> strconv.<span style="color:#fabd2f">ParseInt</span>(oldObjAccessor.<span style="color:#fabd2f">GetResourceVersion</span>(), <span style="color:#d3869b">10</span>, <span style="color:#d3869b">64</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;error parsing old ResourceVersion %q of %s %q: %s&#34;</span>, oldObjAccessor.<span style="color:#fabd2f">GetResourceVersion</span>(), className, objName, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// Throw away only older version, let the same version pass - we do want to</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// get periodic sync events.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 如果传入的pvc的rv（版本号）小于oldpvc的rv， 就是说新传入的pvc版本滞后了， 直接返回false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> oldObjResourceVersion &gt; objResourceVersion {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;storeObjectUpdate: ignoring %s %q version %s&#34;</span>, className, objName, objAccessor.<span style="color:#fabd2f">GetResourceVersion</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 更新</span>
</span></span><span style="display:flex;"><span>	klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;storeObjectUpdate updating %s %q with version %s&#34;</span>, className, objName, objAccessor.<span style="color:#fabd2f">GetResourceVersion</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err = store.<span style="color:#fabd2f">Update</span>(obj); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;error updating %s %q in controller cache: %w&#34;</span>, className, objName, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> <span style="color:#fe8019">true</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h4 id="syncclaim">syncClaim</h4>
<p>pvc 的新增/更新/删除必然伴随着和PV的绑定/解绑/<code>.metadata.annotations</code>的变更：</p>
<ul>
<li>更新<code>.metadata.annotations</code>。</li>
<li>根据根据<code>.metadata.annotations[&quot;pv.kubernetes.io/bind-completed&quot;]</code>来判断绑定 pv 是否完成来走不同的处理分支。</li>
</ul>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// syncClaim is the main controller method to decide what to do with a claim.</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// It&#39;s invoked by appropriate cache.Controller callbacks when a claim is</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// created, updated or periodically synced. We do not differentiate between</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// these events.</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// For easier readability, it was split into syncUnboundClaim and syncBoundClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// methods.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">syncClaim</span>(claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing PersistentVolumeClaim[%s]: %s&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), <span style="color:#fabd2f">getClaimStatusForLogging</span>(claim))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Set correct &#34;migrated-to&#34; annotations on PVC and update in API server if</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// necessary</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 这个和in-tree/out-tree storage provisioner相关，这里不做解释</span>
</span></span><span style="display:flex;"><span>    newClaim, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">updateClaimMigrationAnnotations</span>(claim)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Nothing was saved; we will fall back into the same</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// condition in the next call to this method</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    claim = newClaim
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 根据.metadata.annotations[&#34;pv.kubernetes.io/bind-completed&#34;]来判断绑定pv是否完成</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !metav1.<span style="color:#fabd2f">HasAnnotation</span>(claim.ObjectMeta, pvutil.AnnBindCompleted) {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 没有完成</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> ctrl.<span style="color:#fabd2f">syncUnboundClaim</span>(claim)
</span></span><span style="display:flex;"><span>    } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 完成了</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> ctrl.<span style="color:#fabd2f">syncBoundClaim</span>(claim)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">updateClaimMigrationAnnotations</span>(claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim) (<span style="color:#fe8019">*</span>v1.PersistentVolumeClaim, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// TODO: update[Claim|Volume]MigrationAnnotations can be optimized to not</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// copy the claim/volume if no modifications are required. Though this</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// requires some refactoring as well as an interesting change in the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// semantics of the function which may be undesirable. If no copy is made</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// when no modifications are required this function could sometimes return a</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// copy of the volume and sometimes return a ref to the original</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 先来个克隆体</span>
</span></span><span style="display:flex;"><span>    claimClone <span style="color:#fe8019">:=</span> claim.<span style="color:#fabd2f">DeepCopy</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#8ec07c">//这里主要是更新 .metadata.annotations中的键&#34;pv.kubernetes.io/migrated-to&#34;， 涉及到in-tree storage provisioner 和out-tree storage provisioner 之间的转换</span>
</span></span><span style="display:flex;"><span>    modified <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">updateMigrationAnnotations</span>(ctrl.csiMigratedPluginManager, ctrl.translator, claimClone.Annotations, pvutil.AnnStorageProvisioner)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !modified {<span style="color:#8ec07c">//没有修改，直接返回克隆体</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> claimClone, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 通过apiserver 更新到etcd</span>
</span></span><span style="display:flex;"><span>    newClaim, err <span style="color:#fe8019">:=</span> ctrl.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">PersistentVolumeClaims</span>(claimClone.Namespace).<span style="color:#fabd2f">Update</span>(context.<span style="color:#fabd2f">TODO</span>(), claimClone, metav1.UpdateOptions{})
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;persistent Volume Controller can&#39;t anneal migration annotations: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 更新本地缓存</span>
</span></span><span style="display:flex;"><span>    _, err = ctrl.<span style="color:#fabd2f">storeClaimUpdate</span>(newClaim)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;persistent Volume Controller can&#39;t anneal migration annotations: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> newClaim, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// updateMigrationAnnotations takes an Annotations map and checks for a</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// provisioner name using the provisionerKey. It will then add a</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// &#34;pv.kubernetes.io/migrated-to&#34; annotation if migration with the CSI</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// driver name for that provisioner is &#34;on&#34; based on feature flags, it will also</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// remove the annotation is migration is &#34;off&#34; for that provisioner in rollback</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// scenarios. Returns true if the annotations map was modified and false otherwise.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> <span style="color:#fabd2f">updateMigrationAnnotations</span>(cmpm CSIMigratedPluginManager, translator CSINameTranslator, ann <span style="color:#fe8019">map</span>[<span style="color:#fabd2f">string</span>]<span style="color:#fabd2f">string</span>, provisionerKey <span style="color:#fabd2f">string</span>) <span style="color:#fabd2f">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">var</span> csiDriverName <span style="color:#fabd2f">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">var</span> err <span style="color:#fabd2f">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// .metadata.Annotations为空，那就不知道 storage provisioner, 就不知道有没有被修改， 直接返回false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> ann <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// No annotations so we can&#39;t get the provisioner and don&#39;t know whether</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// this is migrated - no change</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 根据key：“volume.beta.kubernetes.io/storage-provisioner” 获取storage provisioner</span>
</span></span><span style="display:flex;"><span>    provisioner, ok <span style="color:#fe8019">:=</span> ann[provisionerKey]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !ok {<span style="color:#928374;font-style:italic">// 没有获取到，直接返回</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Volume not dynamically provisioned. Ignore</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 更新key：“pv.kubernetes.io/migrated-to”， 这个涉及到in-tree storage provisioner 和out-tree storage provisioner 之间的转换，这里不影响</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 后续另外开辟新的文章说in-tree storage provisioner 和out-tree storage provisioner 之间的转换</span>
</span></span><span style="display:flex;"><span>    migratedToDriver <span style="color:#fe8019">:=</span> ann[pvutil.AnnMigratedTo]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> cmpm.<span style="color:#fabd2f">IsMigrationEnabledForPlugin</span>(provisioner) {
</span></span><span style="display:flex;"><span>        csiDriverName, err = translator.<span style="color:#fabd2f">GetCSINameFromInTreeName</span>(provisioner)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Could not update volume migration annotations. Migration enabled for plugin %s but could not find corresponding driver name: %v&#34;</span>, provisioner, err)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> migratedToDriver <span style="color:#fe8019">!=</span> csiDriverName {
</span></span><span style="display:flex;"><span>            ann[pvutil.AnnMigratedTo] = csiDriverName
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> <span style="color:#fe8019">true</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> migratedToDriver <span style="color:#fe8019">!=</span> <span style="color:#b8bb26">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Migration annotation exists but the driver isn&#39;t migrated currently</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fabd2f">delete</span>(ann, pvutil.AnnMigratedTo)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> <span style="color:#fe8019">true</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h4 id="syncunboundclaim">syncUnboundClaim</h4>
<p>syncUnboundClaim 的流程如下：</p>
<ul>
<li>检查 VolumeName 是否为空，如果为空，检查是否设置了延迟绑定。
<ul>
<li>匹配符合 pvc 要求的 pv，如果没有可用的PV，检查是否是 dynamically provisioned，如果是的话，异步创建 pv 后设置 pvc 状态为 Binding，然后等待下次循环再查找匹配的pv进行绑定。</li>
<li>如果找到相匹配的 pv，那么调用 <a href="#bind">bind</a> 方法执行绑定。</li>
</ul>
</li>
<li>检查 VolumeName 是否为空，如果不为空。
<ul>
<li>找到对应的 pv，如果 ClaimRef 字段为空，那么调用<a href="#bind">bind</a>执行绑定操作。</li>
<li>如果 ClaimRef 不为空，校验一下 pv 是否已绑定了别的 pvc，如果没有的话，执行绑定。</li>
</ul>
</li>
</ul>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">syncUnboundClaim</span>(ctx context.Context, claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// This is a new PVC that has not completed binding</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// OBSERVATION: pvc is &#34;Pending&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> claim.Spec.VolumeName <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;&#34;</span> {<span style="color:#8ec07c">//目前还有绑定PV， 这个时候的PVC的状态是pending的</span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// User did not care which PV they get.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 先看是不是WaitForFirstConsumer模式</span>
</span></span><span style="display:flex;"><span>		delayBinding, err <span style="color:#fe8019">:=</span> storagehelpers.<span style="color:#fabd2f">IsDelayBindingMode</span>(claim, ctrl.classLister)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// [Unit test set 1]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">//  根据 pvc 匹配到最合适的pv </span>
</span></span><span style="display:flex;"><span>		volume, err <span style="color:#fe8019">:=</span> ctrl.volumes.<span style="color:#fabd2f">findBestMatchForClaim</span>(claim, delayBinding)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {<span style="color:#8ec07c">//出错了直接返回</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing unbound PersistentVolumeClaim[%s]: Error finding PV for claim: %v&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;error finding PV for claim %q: %w&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> volume <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {<span style="color:#8ec07c">//在目前此刻的系统中没有找到合适的PV</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing unbound PersistentVolumeClaim[%s]: no volume found&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// No PV could be found</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// OBSERVATION: pvc is &#34;Pending&#34;, will retry</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> utilfeature.DefaultFeatureGate.<span style="color:#fabd2f">Enabled</span>(features.RetroactiveDefaultStorageClass) {
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;FeatureGate[%s] is enabled, attempting to assign storage class to unbound PersistentVolumeClaim[%s]&#34;</span>, features.RetroactiveDefaultStorageClass, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> claim, err = ctrl.<span style="color:#fabd2f">assignDefaultStorageClass</span>(claim); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;can&#39;t update PersistentVolumeClaim[%q]: %w&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">switch</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 如果是 WaitForFirstConsumer 模式，且 pvc 的.metadata.ann[&#34;volume.kubernetes.io/selected-node&#34;]为空，说明还没有调度到pv和pvc绑定</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">//  这里会生成消息告知这个情况，并把可以调度的pv的name都列举出来</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">case</span> delayBinding <span style="color:#fe8019">&amp;&amp;</span> !storagehelpers.<span style="color:#fabd2f">IsDelayBindingProvisioning</span>(claim):
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">emitEventForUnboundDelayBindingClaim</span>(claim); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">case</span> storagehelpers.<span style="color:#fabd2f">GetPersistentVolumeClaimClass</span>(claim) <span style="color:#fe8019">!=</span> <span style="color:#b8bb26">&#34;&#34;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// pvc 中定义了storageClass，就需要让storage provisiioner来创建一块volume了</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">provisionClaim</span>(ctx, claim); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">default</span>:<span style="color:#928374;font-style:italic">// 没有合适的pv ，且pvc 也没有定义storageclass，只能发event信息了</span>
</span></span><span style="display:flex;"><span>				ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeNormal, events.FailedBinding, <span style="color:#b8bb26">&#34;no persistent volumes available for this claim and no storage class is set&#34;</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Mark the claim as Pending and try to find a match in the next</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// periodic syncClaim</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">//  更新pvc 的phase为pending， 并通过apiserver来更新ETCD，更新本地缓存，等待下次循环再匹配 pv 进行绑定</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> _, err = ctrl.<span style="color:#fabd2f">updateClaimStatus</span>(claim, v1.ClaimPending, <span style="color:#fe8019">nil</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> <span style="color:#928374;font-style:italic">/* pv != nil */</span> {<span style="color:#928374;font-style:italic">// 这里是找到了合适的PV了</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Found a PV for this claim</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// OBSERVATION: pvc is &#34;Pending&#34;, pv is &#34;Available&#34;</span>
</span></span><span style="display:flex;"><span>			claimKey <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">claimToClaimKey</span>(claim)
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing unbound PersistentVolumeClaim[%s]: volume %q found: %s&#34;</span>, claimKey, volume.Name, <span style="color:#fabd2f">getVolumeStatusForLogging</span>(volume))
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">bind</span>(volume, claim); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// On any error saving the volume or the claim, subsequent</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// syncClaim will finish the binding.</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// record count error for provision if exists</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// timestamp entry will remain in cache until a success binding has happened</span>
</span></span><span style="display:flex;"><span>				metrics.<span style="color:#fabd2f">RecordMetric</span>(claimKey, <span style="color:#fe8019">&amp;</span>ctrl.operationTimestamps, err)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// OBSERVATION: claim is &#34;Bound&#34;, pv is &#34;Bound&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// if exists a timestamp entry in cache, record end to end provision latency and clean up cache</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// End of the provision + binding operation lifecycle, cache will be cleaned by &#34;RecordMetric&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// [Unit test 12-1, 12-2, 12-4]</span>
</span></span><span style="display:flex;"><span>			metrics.<span style="color:#fabd2f">RecordMetric</span>(claimKey, <span style="color:#fe8019">&amp;</span>ctrl.operationTimestamps, <span style="color:#fe8019">nil</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#fe8019">else</span> <span style="color:#928374;font-style:italic">/* pvc.Spec.VolumeName != nil */</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// [Unit test set 2]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// User asked for a specific PV.</span>
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing unbound PersistentVolumeClaim[%s]: volume %q requested&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), claim.Spec.VolumeName)
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 先在本地缓存中找PV</span>
</span></span><span style="display:flex;"><span>		obj, found, err <span style="color:#fe8019">:=</span> ctrl.volumes.store.<span style="color:#fabd2f">GetByKey</span>(claim.Spec.VolumeName)
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 出错直接返回</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> !found {<span style="color:#928374;font-style:italic">// 本地缓存中没有</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// User asked for a PV that does not exist.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// OBSERVATION: pvc is &#34;Pending&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Retry later.</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing unbound PersistentVolumeClaim[%s]: volume %q requested and not found, will try again next time&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), claim.Spec.VolumeName)
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 更新PVC的phase为pending</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> _, err = ctrl.<span style="color:#fabd2f">updateClaimStatus</span>(claim, v1.ClaimPending, <span style="color:#fe8019">nil</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 返回nil表示稍后会重试</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>			volume, ok <span style="color:#fe8019">:=</span> obj.(<span style="color:#fe8019">*</span>v1.PersistentVolume)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> !ok {
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;cannot convert object from volume cache to volume %q!?: %+v&#34;</span>, claim.Spec.VolumeName, obj)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing unbound PersistentVolumeClaim[%s]: volume %q requested and found: %s&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), claim.Spec.VolumeName, <span style="color:#fabd2f">getVolumeStatusForLogging</span>(volume))
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> volume.Spec.ClaimRef <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {<span style="color:#928374;font-style:italic">// volume没有绑定其他的PVC，这不正好么</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// User asked for a PV that is not claimed</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// OBSERVATION: pvc is &#34;Pending&#34;, pv is &#34;Available&#34;</span>
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing unbound PersistentVolumeClaim[%s]: volume is unbound, binding&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// 再次检查PV是否满足PVC的描述要求如果不满足，PVC的phase还是pending，如果满足的话就调用bind把PVC和PV绑定起来</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> err = <span style="color:#fabd2f">checkVolumeSatisfyClaim</span>(volume, claim); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>					klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Can&#39;t bind the claim to volume %q: %v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// send an event</span>
</span></span><span style="display:flex;"><span>					msg <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Cannot bind to requested volume %q: %s&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>					ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.VolumeMismatch, msg)
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// volume does not satisfy the requirements of the claim</span>
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">if</span> _, err = ctrl.<span style="color:#fabd2f">updateClaimStatus</span>(claim, v1.ClaimPending, <span style="color:#fe8019">nil</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>				} <span style="color:#fe8019">else</span> <span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">bind</span>(volume, claim); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// On any error saving the volume or the claim, subsequent</span>
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// syncClaim will finish the binding.</span>
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// OBSERVATION: pvc is &#34;Bound&#34;, pv is &#34;Bound&#34;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>			} <span style="color:#fe8019">else</span> <span style="color:#fe8019">if</span> storagehelpers.<span style="color:#fabd2f">IsVolumeBoundToClaim</span>(volume, claim) {<span style="color:#928374;font-style:italic">// 看看PV是不是之前就绑定了该PVC</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// User asked for a PV that is claimed by this PVC</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// OBSERVATION: pvc is &#34;Pending&#34;, pv is &#34;Bound&#34;</span>
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing unbound PersistentVolumeClaim[%s]: volume already bound, finishing the binding&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Finish the volume binding by adding claim UID.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// 绑定了，那就在执行一次bind呗， 顶多更新点东西</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">bind</span>(volume, claim); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// OBSERVATION: pvc is &#34;Bound&#34;, pv is &#34;Bound&#34;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>			} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// User asked for a PV that is claimed by someone else</span>
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// OBSERVATION: pvc is &#34;Pending&#34;, pv is &#34;Bound&#34;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> !metav1.<span style="color:#fabd2f">HasAnnotation</span>(claim.ObjectMeta, storagehelpers.AnnBoundByController) {
</span></span><span style="display:flex;"><span>					klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing unbound PersistentVolumeClaim[%s]: volume already bound to different claim by user, will retry later&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>					claimMsg <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;volume %q already bound to a different claim.&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>					ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.FailedBinding, claimMsg)
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// User asked for a specific PV, retry later</span>
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">if</span> _, err = ctrl.<span style="color:#fabd2f">updateClaimStatus</span>(claim, v1.ClaimPending, <span style="color:#fe8019">nil</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>						<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>					}
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>				} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// This should never happen because someone had to remove</span>
</span></span><span style="display:flex;"><span>					<span style="color:#928374;font-style:italic">// AnnBindCompleted annotation on the claim.</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#928374;font-style:italic">// 到这里就是PV之前绑定的PVC和现在的PVC不一样，UID不一样的那种， 发信息，发日志</span>
</span></span><span style="display:flex;"><span>					klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing unbound PersistentVolumeClaim[%s]: volume already bound to different claim %q by controller, THIS SHOULD NEVER HAPPEN&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef))
</span></span><span style="display:flex;"><span>					claimMsg <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;volume %q already bound to a different claim.&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>					ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.FailedBinding, claimMsg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">return</span> fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;invalid binding of claim %q to volume %q: volume already claimed by %q&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), claim.Spec.VolumeName, <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef))
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h4 id="provisionclaim">provisionClaim</h4>
<p><del><strong>provisionClaim</strong>就是给PVC找到一个合适的<strong>storage provisioner</strong>，注意这个<strong>storage provisioner</strong>可能是in-tree，也可能是out-tree, <strong>PersistentVolumeController.findProvisionablePlugin</strong>就是找这个的，其返回值有三个</del></p>
<ul>
<li><del>err ！= nil， 说明出错了直接返回</del></li>
<li><del>plugin == nil， 说明目前in-tree的<strong>storage provisioner</strong>还没有找到，<strong>那就有可能是out-tree的，这个时候就是CSI Storage Driver的逻辑了</strong>， 走的是<a href="#PersistentVolumeController.provisionClaimOperationExternal">PersistentVolumeController.provisionClaimOperationExternal</a>逻辑</del></li>
<li><del>plugin ！= nil， 那就说明目前的in-tree的<strong>storage provisioner</strong>已经找到，走的是<a href="#PersistentVolumeController.provisionClaimOperation">PersistentVolumeController.provisionClaimOperation</a>逻辑</del></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// provisionClaim starts new asynchronous operation to provision a claim if</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// provisioning is enabled.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">provisionClaim</span>(claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !ctrl.enableDynamicProvisioning {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;provisionClaim[%s]: started&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// opName ==&gt; provision-&lt;claim.namespace&gt;/&lt;claim.name&gt;[&lt;claim.UID&gt;]</span>
</span></span><span style="display:flex;"><span>    opName <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;provision-%s[%s]&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), <span style="color:#fabd2f">string</span>(claim.UID))
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 这里是要找到ProvisionableVolumePlugin，对于in-tree这个没有问题，但是对于out-tree，由于csi plugin根本就没有实现ProvisionableVolumePlugin</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 就会返回错误，这个错误不需要处理，直接返回就可以了，创建PV的任务就交给external-provisioner来做</span>
</span></span><span style="display:flex;"><span>    plugin, storageClass, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">findProvisionablePlugin</span>(claim)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// findProvisionablePlugin does not return err for external provisioners</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.ProvisioningFailed, err.<span style="color:#fabd2f">Error</span>())
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;error finding provisioning plugin for claim %s: %v&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// failed to find the requested provisioning plugin, directly return err for now.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// controller will retry the provisioning in every syncUnboundClaim() call</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// retain the original behavior of returning nil from provisionClaim call</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ctrl.<span style="color:#fabd2f">scheduleOperation</span>(opName, <span style="color:#fe8019">func</span>() <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// create a start timestamp entry in cache for provision operation if no one exists with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// key = claimKey, pluginName = provisionerName, operation = &#34;provision&#34;</span>
</span></span><span style="display:flex;"><span>        claimKey <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">claimToClaimKey</span>(claim)
</span></span><span style="display:flex;"><span>        ctrl.operationTimestamps.<span style="color:#fabd2f">AddIfNotExist</span>(claimKey, ctrl.<span style="color:#fabd2f">getProvisionerName</span>(plugin, storageClass), <span style="color:#b8bb26">&#34;provision&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">var</span> err <span style="color:#fabd2f">error</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> plugin <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            _, err = ctrl.<span style="color:#fabd2f">provisionClaimOperationExternal</span>(claim, storageClass)
</span></span><span style="display:flex;"><span>        } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>            _, err = ctrl.<span style="color:#fabd2f">provisionClaimOperation</span>(claim, plugin, storageClass)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// if error happened, record an error count metric</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// timestamp entry will remain in cache until a success binding has happened</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            metrics.<span style="color:#fabd2f">RecordMetric</span>(claimKey, <span style="color:#fe8019">&amp;</span>ctrl.operationTimestamps, err)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="provisionclaimoperation">provisionClaimOperation</h4>
<p>这个是走的in-tree的<strong>storage provisioner</strong>的逻辑, 这就需要volume 插件实现了 <strong>ProvisionableVolumePlugin</strong>这个接口</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// provisionClaimOperation provisions a volume. This method is running in</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// standalone goroutine and already has all necessary locks.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">provisionClaimOperation</span>(
</span></span><span style="display:flex;"><span>    claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim,
</span></span><span style="display:flex;"><span>    plugin vol.ProvisionableVolumePlugin,
</span></span><span style="display:flex;"><span>    storageClass <span style="color:#fe8019">*</span>storage.StorageClass) (<span style="color:#fabd2f">string</span>, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    claimClass <span style="color:#fe8019">:=</span> storagehelpers.<span style="color:#fabd2f">GetPersistentVolumeClaimClass</span>(claim)
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;provisionClaimOperation [%s] started, class: %q&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), claimClass)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// called from provisionClaim(), in this case, plugin MUST NOT be nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// NOTE: checks on plugin/storageClass has been saved</span>
</span></span><span style="display:flex;"><span>    pluginName <span style="color:#fe8019">:=</span> plugin.<span style="color:#fabd2f">GetPluginName</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 注释写的很清楚了，就是说不是CSI storage插件，且DataSource不为空，就是错的，就是在刷流氓</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> pluginName <span style="color:#fe8019">!=</span> <span style="color:#b8bb26">&#34;kubernetes.io/csi&#34;</span> <span style="color:#fe8019">&amp;&amp;</span> claim.Spec.DataSource <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Only CSI plugin can have a DataSource. Fail the operation</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// if Datasource in Claim is not nil and it is not a CSI plugin,</span>
</span></span><span style="display:flex;"><span>        strerr <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;plugin %q is not a CSI plugin. Only CSI plugin can provision a claim with a datasource&#34;</span>, pluginName)
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(strerr)
</span></span><span style="display:flex;"><span>        ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.ProvisioningFailed, strerr)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, fmt.<span style="color:#fabd2f">Errorf</span>(strerr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    provisionerName <span style="color:#fe8019">:=</span> storageClass.Provisioner
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;provisionClaimOperation [%s]: plugin name: %s, provisioner name: %s&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), pluginName, provisionerName)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Add provisioner annotation to be consistent with external provisioner workflow</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 设置.metadata.annotations[&#34;volume.beta.kubernetes.io/storage-provisioner&#34;]的值，并更新本地数据库</span>
</span></span><span style="display:flex;"><span>    newClaim, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">setClaimProvisioner</span>(claim, provisionerName)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Save failed, the controller will retry in the next sync</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error saving claim %s: %v&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    claim = newClaim
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// internal provisioning</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">//  A previous provisionClaimOperation may just have finished while we were waiting for</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">//  the locks. Check that PV (with deterministic name) hasn&#39;t been provisioned</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">//  yet.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 获取pv的name， 其实就是pvc-&lt;claim.UID&gt;</span>
</span></span><span style="display:flex;"><span>    pvName <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">getProvisionedVolumeNameForClaim</span>(claim)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 先查找apiserver，看看该PV是否已经创建</span>
</span></span><span style="display:flex;"><span>    volume, err <span style="color:#fe8019">:=</span> ctrl.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">PersistentVolumes</span>().<span style="color:#fabd2f">Get</span>(context.<span style="color:#fabd2f">TODO</span>(), pvName, metav1.GetOptions{})
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">&amp;&amp;</span> !apierrors.<span style="color:#fabd2f">IsNotFound</span>(err) {<span style="color:#928374;font-style:italic">// 出错了且错误不是没有找到，则返回错误</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error reading persistent volume %q: %v&#34;</span>, pvName, err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">&amp;&amp;</span> volume <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {<span style="color:#928374;font-style:italic">// 找到了相应的PV， 直接返回</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Volume has been already provisioned, nothing to do.</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;provisionClaimOperation [%s]: volume already exists, skipping&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Prepare a claimRef to the claim early (to fail before a volume is</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// provisioned)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 不存在，那就要CSI stroage来参与了</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 先来创建claimRef</span>
</span></span><span style="display:flex;"><span>    claimRef, err <span style="color:#fe8019">:=</span> ref.<span style="color:#fabd2f">GetReference</span>(scheme.Scheme, claim)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;unexpected error getting claim reference: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Gather provisioning options</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8ec07c">//tags[&#34;&#34;kubernetes.io/created-for/pvc/namespace&#34;&#34;] = clain.Namespace</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8ec07c">//tags[&#34;kubernetes.io/created-for/pvc/name&#34;] = claim.Name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8ec07c">//tags[&#34;kubernetes.io/created-for/pv/name&#34;] = pvName</span>
</span></span><span style="display:flex;"><span>    tags <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">make</span>(<span style="color:#fe8019">map</span>[<span style="color:#fabd2f">string</span>]<span style="color:#fabd2f">string</span>)
</span></span><span style="display:flex;"><span>    tags[CloudVolumeCreatedForClaimNamespaceTag] = claim.Namespace
</span></span><span style="display:flex;"><span>    tags[CloudVolumeCreatedForClaimNameTag] = claim.Name
</span></span><span style="display:flex;"><span>    tags[CloudVolumeCreatedForVolumeNameTag] = pvName
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 构建options</span>
</span></span><span style="display:flex;"><span>    options <span style="color:#fe8019">:=</span> vol.VolumeOptions{
</span></span><span style="display:flex;"><span>        PersistentVolumeReclaimPolicy: <span style="color:#fe8019">*</span>storageClass.ReclaimPolicy,
</span></span><span style="display:flex;"><span>        MountOptions:                  storageClass.MountOptions,
</span></span><span style="display:flex;"><span>        CloudTags:                     <span style="color:#fe8019">&amp;</span>tags,
</span></span><span style="display:flex;"><span>        ClusterName:                   ctrl.clusterName,
</span></span><span style="display:flex;"><span>        PVName:                        pvName,
</span></span><span style="display:flex;"><span>        PVC:                           claim,
</span></span><span style="display:flex;"><span>        Parameters:                    storageClass.Parameters,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Refuse to provision if the plugin doesn&#39;t support mount options, creation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// of PV would be rejected by validation anyway</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 如果CSI Storage不支持挂载参数，单偏偏有挂载参数，那就出错了</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !plugin.<span style="color:#fabd2f">SupportsMountOption</span>() <span style="color:#fe8019">&amp;&amp;</span> <span style="color:#fabd2f">len</span>(options.MountOptions) &gt; <span style="color:#d3869b">0</span> {
</span></span><span style="display:flex;"><span>        strerr <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Mount options are not supported by the provisioner but StorageClass %q has mount options %v&#34;</span>, storageClass.Name, options.MountOptions)
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Mount options are not supported by the provisioner but claim %q&#39;s StorageClass %q has mount options %v&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), storageClass.Name, options.MountOptions)
</span></span><span style="display:flex;"><span>        ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.ProvisioningFailed, strerr)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;provisioner %q doesn&#39;t support mount options&#34;</span>, plugin.<span style="color:#fabd2f">GetPluginName</span>())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Provision the volume</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 根据配置option是生成storage provisioner</span>
</span></span><span style="display:flex;"><span>    provisioner, err <span style="color:#fe8019">:=</span> plugin.<span style="color:#fabd2f">NewProvisioner</span>(options)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        strerr <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Failed to create provisioner: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;failed to create provisioner for claim %q with StorageClass %q: %v&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), storageClass.Name, err)
</span></span><span style="display:flex;"><span>        ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.ProvisioningFailed, strerr)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">var</span> selectedNode <span style="color:#fe8019">*</span>v1.Node = <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> nodeName, ok <span style="color:#fe8019">:=</span> claim.Annotations[pvutil.AnnSelectedNode]; ok {
</span></span><span style="display:flex;"><span>        selectedNode, err = ctrl.NodeLister.<span style="color:#fabd2f">Get</span>(nodeName)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            strerr <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Failed to get target node: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;unexpected error getting target node %q for claim %q: %v&#34;</span>, nodeName, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>            ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.ProvisioningFailed, strerr)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> pluginName, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    allowedTopologies <span style="color:#fe8019">:=</span> storageClass.AllowedTopologies
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    opComplete <span style="color:#fe8019">:=</span> util.<span style="color:#fabd2f">OperationCompleteHook</span>(plugin.<span style="color:#fabd2f">GetPluginName</span>(), <span style="color:#b8bb26">&#34;volume_provision&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 创建PV, 可以参考k8s.io/kubernetes/pkg/volume/glusterfs/glusterfs.go对这个方法的实现</span>
</span></span><span style="display:flex;"><span>    volume, err = provisioner.<span style="color:#fabd2f">Provision</span>(selectedNode, allowedTopologies)
</span></span><span style="display:flex;"><span>    <span style="color:#fabd2f">opComplete</span>(volumetypes.CompleteFuncParam{Err: <span style="color:#fe8019">&amp;</span>err})
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Other places of failure have nothing to do with VolumeScheduling,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// so just let controller retry in the next sync. We&#39;ll only call func</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// rescheduleProvisioning here when the underlying provisioning actually failed.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#928374;font-style:italic">// 出错了，就更新(可能是删除操作)PVC的.meta.annotations[&#34;volume.kubernetes.io/selected-node&#34;]，等待重试</span>
</span></span><span style="display:flex;"><span>        ctrl.<span style="color:#fabd2f">rescheduleProvisioning</span>(claim)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        strerr <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Failed to provision volume with StorageClass %q: %v&#34;</span>, storageClass.Name, err)
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;failed to provision volume for claim %q with StorageClass %q: %v&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), storageClass.Name, err)
</span></span><span style="display:flex;"><span>        ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.ProvisioningFailed, strerr)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q for claim %q created&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Create Kubernetes PV object for the volume.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 把PV和PVC绑定起来</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> volume.Name <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        volume.Name = pvName
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Bind it to the claim</span>
</span></span><span style="display:flex;"><span>    volume.Spec.ClaimRef = claimRef
</span></span><span style="display:flex;"><span>    volume.Status.Phase = v1.VolumeBound
</span></span><span style="display:flex;"><span>    volume.Spec.StorageClassName = claimClass
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Add AnnBoundByController (used in deleting the volume)</span>
</span></span><span style="display:flex;"><span>    metav1.<span style="color:#fabd2f">SetMetaDataAnnotation</span>(<span style="color:#fe8019">&amp;</span>volume.ObjectMeta, pvutil.AnnBoundByController, <span style="color:#b8bb26">&#34;yes&#34;</span>)
</span></span><span style="display:flex;"><span>    metav1.<span style="color:#fabd2f">SetMetaDataAnnotation</span>(<span style="color:#fe8019">&amp;</span>volume.ObjectMeta, pvutil.AnnDynamicallyProvisioned, plugin.<span style="color:#fabd2f">GetPluginName</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Try to create the PV object several times</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 把PV通过apiserver刷到ETCD中， 并更新本地缓存</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">for</span> i <span style="color:#fe8019">:=</span> <span style="color:#d3869b">0</span>; i &lt; ctrl.createProvisionedPVRetryCount; i<span style="color:#fe8019">++</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;provisionClaimOperation [%s]: trying to save volume %s&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), volume.Name)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">var</span> newVol <span style="color:#fe8019">*</span>v1.PersistentVolume
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> newVol, err = ctrl.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">PersistentVolumes</span>().<span style="color:#fabd2f">Create</span>(context.<span style="color:#fabd2f">TODO</span>(), volume, metav1.CreateOptions{}); err <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">||</span> apierrors.<span style="color:#fabd2f">IsAlreadyExists</span>(err) {
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Save succeeded.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>                klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q for claim %q already exists, reusing&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>                err = <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>                klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q for claim %q saved&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                _, updateErr <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">storeVolumeUpdate</span>(newVol)
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">if</span> updateErr <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#928374;font-style:italic">// We will get an &#34;volume added&#34; event soon, this is not a big error</span>
</span></span><span style="display:flex;"><span>                    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;provisionClaimOperation [%s]: cannot update internal cache: %v&#34;</span>, volume.Name, updateErr)
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">break</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Save failed, try again after a while.</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;failed to save volume %q for claim %q: %v&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>        time.<span style="color:#fabd2f">Sleep</span>(ctrl.createProvisionedPVInterval)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {<span style="color:#8ec07c">//刷10次最终还是有错误发生， 需要把创建的PV删除了</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Save failed. Now we have a storage asset outside of Kubernetes,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// but we don&#39;t have appropriate PV object for it.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Emit some event here and try to delete the storage asset several</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// times.</span>
</span></span><span style="display:flex;"><span>        strerr <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Error creating provisioned PV object for claim %s: %v. Deleting the volume.&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Info</span>(strerr)
</span></span><span style="display:flex;"><span>        ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.ProvisioningFailed, strerr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">var</span> deleteErr <span style="color:#fabd2f">error</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">var</span> deleted <span style="color:#fabd2f">bool</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">for</span> i <span style="color:#fe8019">:=</span> <span style="color:#d3869b">0</span>; i &lt; ctrl.createProvisionedPVRetryCount; i<span style="color:#fe8019">++</span> {
</span></span><span style="display:flex;"><span>            _, deleted, deleteErr = ctrl.<span style="color:#fabd2f">doDeleteVolume</span>(volume)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> deleteErr <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">&amp;&amp;</span> deleted {
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// Delete succeeded</span>
</span></span><span style="display:flex;"><span>                klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;provisionClaimOperation [%s]: cleaning volume %s succeeded&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), volume.Name)
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">break</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> !deleted {
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// This is unreachable code, the volume was provisioned by an</span>
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// internal plugin and therefore there MUST be an internal</span>
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// plugin that deletes it.</span>
</span></span><span style="display:flex;"><span>                klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Error finding internal deleter for volume plugin %q&#34;</span>, plugin.<span style="color:#fabd2f">GetPluginName</span>())
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">break</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Delete failed, try again after a while.</span>
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;failed to delete volume %q: %v&#34;</span>, volume.Name, deleteErr)
</span></span><span style="display:flex;"><span>            time.<span style="color:#fabd2f">Sleep</span>(ctrl.createProvisionedPVInterval)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> deleteErr <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Delete failed several times. There is an orphaned volume and there</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// is nothing we can do about it.</span>
</span></span><span style="display:flex;"><span>            strerr <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Error cleaning provisioned volume for claim %s: %v. Please delete manually.&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), deleteErr)
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Info</span>(strerr)
</span></span><span style="display:flex;"><span>            ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.ProvisioningCleanupFailed, strerr)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q provisioned for claim %q&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>        msg <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Successfully provisioned volume %s using %s&#34;</span>, volume.Name, plugin.<span style="color:#fabd2f">GetPluginName</span>())
</span></span><span style="display:flex;"><span>        ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeNormal, events.ProvisioningSucceeded, msg)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> pluginName, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="provisionclaimoperationexternal">provisionClaimOperationExternal</h4>
<p><strong>PersistentVolumeController.provisionClaimOperationExternal</strong>的逻辑就是使用第三方的CSI Driver来创建PV的事情</p>
<ul>
<li>首先还是需要检查下<strong>in-tree storage provisioner</strong>， 因为历史的原因，在k8s中的<strong>in-tree storage provisioner</strong>可以通过转换成CSI storage provisioner， 所以第一步就通过逆向推，看看可不可以使用<strong>in-tree storage provisioner</strong></li>
<li>第一步不满足的话，就需要修改PVC的.metadata.annotations[&ldquo;volume.beta.kubernetes.io/storage-provisioner&rdquo;]为provisionerName，交给external-provisioner来处理</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// provisionClaimOperationExternal provisions a volume using external provisioner async-ly</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// This method will be running in a standalone go-routine scheduled in &#34;provisionClaim&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">provisionClaimOperationExternal</span>(
</span></span><span style="display:flex;"><span>    claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim,
</span></span><span style="display:flex;"><span>    storageClass <span style="color:#fe8019">*</span>storage.StorageClass) (<span style="color:#fabd2f">string</span>, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    claimClass <span style="color:#fe8019">:=</span> storagehelpers.<span style="color:#fabd2f">GetPersistentVolumeClaimClass</span>(claim)
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;provisionClaimOperationExternal [%s] started, class: %q&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), claimClass)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Set provisionerName to external provisioner name by setClaimProvisioner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">var</span> err <span style="color:#fabd2f">error</span>
</span></span><span style="display:flex;"><span>    provisionerName <span style="color:#fe8019">:=</span> storageClass.Provisioner
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 逆向推里，看看**in-tree storage provisioner**转换的正好是该CSI storage provisioner</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> ctrl.csiMigratedPluginManager.<span style="color:#fabd2f">IsMigrationEnabledForPlugin</span>(storageClass.Provisioner) {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// update the provisioner name to use the migrated CSI plugin name</span>
</span></span><span style="display:flex;"><span>        provisionerName, err = ctrl.translator.<span style="color:#fabd2f">GetCSINameFromInTreeName</span>(storageClass.Provisioner)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            strerr <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;error getting CSI name for In tree plugin %s: %v&#34;</span>, storageClass.Provisioner, err)
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;%s&#34;</span>, strerr)
</span></span><span style="display:flex;"><span>            ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeWarning, events.ProvisioningFailed, strerr)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> provisionerName, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Add provisioner annotation so external provisioners know when to start</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 需要修改PVC的.metadata.annotations[&#34;volume.beta.kubernetes.io/storage-provisioner&#34;]为provisionerName， 这个会交给external-provisioner来处理，这个后面会有讲到</span>
</span></span><span style="display:flex;"><span>    newClaim, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">setClaimProvisioner</span>(claim, provisionerName)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Save failed, the controller will retry in the next sync</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error saving claim %s: %v&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> provisionerName, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    claim = newClaim
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 然后就是该打日志的打日志，该发event的发event</span>
</span></span><span style="display:flex;"><span>    msg <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;waiting for a volume to be created, either by external provisioner %q or manually created by system administrator&#34;</span>, provisionerName)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// External provisioner has been requested for provisioning the volume</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Report an event and wait for external provisioner to finish</span>
</span></span><span style="display:flex;"><span>    ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(claim, v1.EventTypeNormal, events.ExternalProvisioning, msg)
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;provisionClaimOperationExternal provisioning claim %q: %s&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), msg)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// return provisioner name here for metric reporting</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> provisionerName, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="syncboundclaim">syncBoundClaim</h4>
<p>syncBoundClaim 主要是处理 pvc 已经绑定的各种异常情况，例如检查 VolumeName 字段是否为空，检查是否能找到对应的 pv，检查对应的 pv 是否已经绑定当前的 pvc，检查是否有多个 pvc 绑定到同一个 pv 上等等：
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">syncBoundClaim</span>(claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// HasAnnotation(pvc, storagehelpers.AnnBindCompleted)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// This PVC has previously been bound</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// OBSERVATION: pvc is not &#34;Pending&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// [Unit test set 3]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 如果.spec.volumeName是空的，但是根据.metadata.annotations[&#34;pv.kubernetes.io/bind-completed&#34;]已经绑定了， 说明出错了</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> claim.Spec.VolumeName <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// Claim was bound before but not any more.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 以前被绑定过，但现在已经找不到对应的PV了，即数据丢失，需要更新状态</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> _, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">updateClaimStatusWithEvent</span>(claim, v1.ClaimLost, <span style="color:#fe8019">nil</span>, v1.EventTypeWarning, <span style="color:#b8bb26">&#34;ClaimLost&#34;</span>, <span style="color:#b8bb26">&#34;Bound claim has lost reference to PersistentVolume. Data on the volume is lost!&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#8ec07c">//在本地caache中找到名字为claim.Spec.VolumeName的PV</span>
</span></span><span style="display:flex;"><span>	obj, found, err <span style="color:#fe8019">:=</span> ctrl.volumes.store.<span style="color:#fabd2f">GetByKey</span>(claim.Spec.VolumeName)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> !found {<span style="color:#928374;font-style:italic">// pvc绑定到了一个不存在的PV</span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// Claim is bound to a non-existing volume.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> _, err = ctrl.<span style="color:#fabd2f">updateClaimStatusWithEvent</span>(claim, v1.ClaimLost, <span style="color:#fe8019">nil</span>, v1.EventTypeWarning, <span style="color:#b8bb26">&#34;ClaimLost&#34;</span>, <span style="color:#b8bb26">&#34;Bound claim has lost its PersistentVolume. Data on the volume is lost!&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#8ec07c">//判断是不是v1.PersistentVolume类型的</span>
</span></span><span style="display:flex;"><span>		volume, ok <span style="color:#fe8019">:=</span> obj.(<span style="color:#fe8019">*</span>v1.PersistentVolume)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> !ok {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;cannot convert object from volume cache to volume %q!?: %#v&#34;</span>, claim.Spec.VolumeName, obj)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing bound PersistentVolumeClaim[%s]: volume %q found: %s&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), claim.Spec.VolumeName, <span style="color:#fabd2f">getVolumeStatusForLogging</span>(volume))
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> volume.Spec.ClaimRef <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Claim is bound but volume has come unbound.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Or, a claim was bound and the controller has not received updated</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// volume yet. We can&#39;t distinguish these cases.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Bind the volume again and set all states to Bound.</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing bound PersistentVolumeClaim[%s]: volume is unbound, fixing&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 在这里做PVC和PV的绑定逻辑</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">bind</span>(volume, claim); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Objects not saved, next syncPV or syncClaim will try again</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> <span style="color:#fe8019">if</span> volume.Spec.ClaimRef.UID <span style="color:#fe8019">==</span> claim.UID {<span style="color:#928374;font-style:italic">// pvc就是绑定的该pv</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// All is well</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// NOTE: syncPV can handle this so it can be left out.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// NOTE: bind() call here will do nothing in most cases as</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// everything should be already set.</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;synchronizing bound PersistentVolumeClaim[%s]: claim is already correctly bound&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 在这里还是要做以下绑定的逻辑，说不定可以更新点啥内容，顶多不更新呗</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">bind</span>(volume, claim); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Objects not saved, next syncPV or syncClaim will try again</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> {<span style="color:#928374;font-style:italic">// 绑定混乱</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Claim is bound but volume has a different claimant.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Set the claim phase to &#39;Lost&#39;, which is a terminal</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// phase.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> _, err = ctrl.<span style="color:#fabd2f">updateClaimStatusWithEvent</span>(claim, v1.ClaimLost, <span style="color:#fe8019">nil</span>, v1.EventTypeWarning, <span style="color:#b8bb26">&#34;ClaimMisbound&#34;</span>, <span style="color:#b8bb26">&#34;Two claims are bound to the same volume, this one is bound incorrectly&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>
</p>
<h4 id="bind">bind</h4>
<p>bind 更新 ClaimRef、status phase、VolumeName等。</p>
<p>把PVC和PV绑定起来：</p>
<ul>
<li>
<p>先更新PV，并通过apiserver写入到ETCD， 以及更新本地缓存</p>
<p>更新的内容有：</p>
<p>&lt;1&gt; .spec.ClaimRef为PVC</p>
<p>&lt;2&gt; 修改PV的.metadata.annotations[&ldquo;pv.kubernetes.io/bound-by-controller&rdquo;]=&ldquo;yes&rdquo;</p>
<p>&lt;3&gt; 修改phase为Bound</p>
</li>
<li>
<p>然后更新PVC， 并通过apiserver写入到ETCD， 以及更新本地缓存</p>
<p>更新的内容有：</p>
<p>&lt;1&gt; 更新PVC的.spec.volumeName为PV的name</p>
<p>&lt;2&gt;设置PVC的.metadata.annotations[&ldquo;pv.kubernetes.io/bound-by-controller&rdquo;] = &ldquo;yes&rdquo;, 设置 PVC的.metadata.annotations[&ldquo;pv.kubernetes.io/bind-completed&rdquo;] = &ldquo;yes&rdquo;</p>
<p>&lt;3&gt; 修改phase为Bound</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// bind saves binding information both to the volume and the claim and marks</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// both objects as Bound. Volume is saved first.</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// It returns on first error, it&#39;s up to the caller to implement some retry</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// mechanism.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">bind</span>(volume <span style="color:#fe8019">*</span>v1.PersistentVolume, claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">var</span> err <span style="color:#fabd2f">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// use updateClaim/updatedVolume to keep the original claim/volume for</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// logging in error cases.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">var</span> updatedClaim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">var</span> updatedVolume <span style="color:#fe8019">*</span>v1.PersistentVolume
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;binding volume %q to claim %q&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 把pvc和PV绑定起来，如果有必要需要通过APIserver更新ETCD，以及更新本地缓存</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> updatedVolume, err = ctrl.<span style="color:#fabd2f">bindVolumeToClaim</span>(volume, claim); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error binding volume %q to claim %q: failed saving the volume: %v&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    volume = updatedVolume
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 修改PV的phase为Bound, 如果有必要需要通过APIserver更新ETCD，以及更新本地缓存</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> updatedVolume, err = ctrl.<span style="color:#fabd2f">updateVolumePhase</span>(volume, v1.VolumeBound, <span style="color:#b8bb26">&#34;&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error binding volume %q to claim %q: failed saving the volume status: %v&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    volume = updatedVolume
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 把PVC和PV绑定起来， 更新PVC的资源描述， 然后通过apiserver更新ETCD，以及本地缓存</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> updatedClaim, err = ctrl.<span style="color:#fabd2f">bindClaimToVolume</span>(claim, volume); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error binding volume %q to claim %q: failed saving the claim: %v&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    claim = updatedClaim
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 修改PVC的phase为Bound, 如果有必要需要通过APIserver更新ETCD，以及更新本地缓存</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> updatedClaim, err = ctrl.<span style="color:#fabd2f">updateClaimStatus</span>(claim, v1.ClaimBound, volume); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error binding volume %q to claim %q: failed saving the claim status: %v&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    claim = updatedClaim
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q bound to claim %q&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q status after binding: %s&#34;</span>, volume.Name, <span style="color:#fabd2f">getVolumeStatusForLogging</span>(volume))
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;claim %q status after binding: %s&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), <span style="color:#fabd2f">getClaimStatusForLogging</span>(claim))
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="bindvolumetoclaim">bindVolumeToClaim</h4>
<p>把PV和PVC绑定起来，即把PVC的相关信息写入到PV中</p>
<ul>
<li>修改PV的.spec.claimRef为绑定的PVC，修改PV的.metadata.annotations[&ldquo;pv.kubernetes.io/bound-by-controller&rdquo;]=&ldquo;yes&rdquo;, 可以看可以看<a href="#util.GetBindVolumeToClaim">util.GetBindVolumeToClaim</a></li>
<li>如果上面2项有任意一项被修改了，就需要通过apiserver写入到etcd, 以及更新本地缓存</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// bindVolumeToClaim modifies given volume to be bound to a claim and saves it to</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// API server. The claim is not modified in this method!</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">bindVolumeToClaim</span>(volume <span style="color:#fe8019">*</span>v1.PersistentVolume, claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim) (<span style="color:#fe8019">*</span>v1.PersistentVolume, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;updating PersistentVolume[%s]: binding to %q&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>  <span style="color:#928374;font-style:italic">// 这里是把PVC和PV绑定起来，可以看[util.GetBindVolumeToClaim](#util.GetBindVolumeToClaim)</span>
</span></span><span style="display:flex;"><span>    volumeClone, dirty, err <span style="color:#fe8019">:=</span> pvutil.<span style="color:#fabd2f">GetBindVolumeToClaim</span>(volume, claim)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Save the volume only if something was changed</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> dirty {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> ctrl.<span style="color:#fabd2f">updateBindVolumeToClaim</span>(volumeClone, <span style="color:#fe8019">true</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;updating PersistentVolume[%s]: already bound to %q&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> volume, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="bindclaimtovolume">bindClaimToVolume</h4>
<p>把PV和PVC绑定起来，即把PV的相关信息写入到PVC中</p>
<ul>
<li>更新PVC的.spec.volumeName为PV的name</li>
<li>设置PVC的.metadata.annotations[&ldquo;pv.kubernetes.io/bound-by-controller&rdquo;] = &ldquo;yes&rdquo;</li>
<li>设置 PVC的.metadata.annotations[&ldquo;pv.kubernetes.io/bind-completed&rdquo;] = &ldquo;yes&rdquo;</li>
<li>如有必要通过apiserver更新ETCD，以及更新本地缓存</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// bindClaimToVolume modifies the given claim to be bound to a volume and</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// saves it to API server. The volume is not modified in this method!</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">bindClaimToVolume</span>(claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim, volume <span style="color:#fe8019">*</span>v1.PersistentVolume) (<span style="color:#fe8019">*</span>v1.PersistentVolumeClaim, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;updating PersistentVolumeClaim[%s]: binding to %q&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), volume.Name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    dirty <span style="color:#fe8019">:=</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 设置PVC的.spec.volumeName为PV的name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Check if the claim was already bound (either by controller or by user)</span>
</span></span><span style="display:flex;"><span>    shouldBind <span style="color:#fe8019">:=</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> volume.Name <span style="color:#fe8019">!=</span> claim.Spec.VolumeName {
</span></span><span style="display:flex;"><span>        shouldBind = <span style="color:#fe8019">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// The claim from method args can be pointing to watcher cache. We must not</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// modify these, therefore create a copy.</span>
</span></span><span style="display:flex;"><span>    claimClone <span style="color:#fe8019">:=</span> claim.<span style="color:#fabd2f">DeepCopy</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> shouldBind {
</span></span><span style="display:flex;"><span>        dirty = <span style="color:#fe8019">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Bind the claim to the volume</span>
</span></span><span style="display:flex;"><span>        claimClone.Spec.VolumeName = volume.Name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Set AnnBoundByController if it is not set yet</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 设置PVC的.metadata.annotations[&#34;pv.kubernetes.io/bound-by-controller&#34;] = &#34;yes&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> !metav1.<span style="color:#fabd2f">HasAnnotation</span>(claimClone.ObjectMeta, pvutil.AnnBoundByController) {
</span></span><span style="display:flex;"><span>            metav1.<span style="color:#fabd2f">SetMetaDataAnnotation</span>(<span style="color:#fe8019">&amp;</span>claimClone.ObjectMeta, pvutil.AnnBoundByController, <span style="color:#b8bb26">&#34;yes&#34;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Set AnnBindCompleted if it is not set yet</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 设置 PVC的.metadata.annotations[&#34;pv.kubernetes.io/bind-completed&#34;] = &#34;yes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !metav1.<span style="color:#fabd2f">HasAnnotation</span>(claimClone.ObjectMeta, pvutil.AnnBindCompleted) {
</span></span><span style="display:flex;"><span>        metav1.<span style="color:#fabd2f">SetMetaDataAnnotation</span>(<span style="color:#fe8019">&amp;</span>claimClone.ObjectMeta, pvutil.AnnBindCompleted, <span style="color:#b8bb26">&#34;yes&#34;</span>)
</span></span><span style="display:flex;"><span>        dirty = <span style="color:#fe8019">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 通过apiserver更新ETCD，以及更新本地缓存</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> dirty {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q bound to claim %q&#34;</span>, volume.Name, <span style="color:#fabd2f">claimToClaimKey</span>(claim))
</span></span><span style="display:flex;"><span>        newClaim, err <span style="color:#fe8019">:=</span> ctrl.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">PersistentVolumeClaims</span>(claim.Namespace).<span style="color:#fabd2f">Update</span>(context.<span style="color:#fabd2f">TODO</span>(), claimClone, metav1.UpdateOptions{})
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;updating PersistentVolumeClaim[%s]: binding to %q failed: %v&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), volume.Name, err)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> newClaim, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        _, err = ctrl.<span style="color:#fabd2f">storeClaimUpdate</span>(newClaim)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;updating PersistentVolumeClaim[%s]: cannot update internal cache: %v&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), err)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> newClaim, err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;updating PersistentVolumeClaim[%s]: bound to %q&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), volume.Name)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> newClaim, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;updating PersistentVolumeClaim[%s]: already bound to %q&#34;</span>, <span style="color:#fabd2f">claimToClaimKey</span>(claim), volume.Name)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> claim, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="deleteclaim">deleteClaim</h3>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// Unit test [5-5] [5-6] [5-7]</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// deleteClaim runs in worker thread and handles &#34;claim deleted&#34; event.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">deleteClaim</span>(claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim) {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">//  本地缓存删除PVC的记录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">:=</span> ctrl.claims.<span style="color:#fabd2f">Delete</span>(claim); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;claim %q deletion encountered : %v&#34;</span>, claim.Name, err)
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>    claimKey <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">claimToClaimKey</span>(claim)
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;claim %q deleted&#34;</span>, claimKey)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// clean any possible unfinished provision start timestamp from cache</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Unit test [5-8] [5-9]</span>
</span></span><span style="display:flex;"><span>    ctrl.operationTimestamps.<span style="color:#fabd2f">Delete</span>(claimKey)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    volumeName <span style="color:#fe8019">:=</span> claim.Spec.VolumeName
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 如果PVC没有绑定PV，直接返回</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> volumeName <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;deleteClaim[%q]: volume not bound&#34;</span>, claimKey)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// sync the volume when its claim is deleted.  Explicitly sync&#39;ing the</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// volume here in response to claim deletion prevents the volume from</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// waiting until the next sync period for its Release.</span>
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;deleteClaim[%q]: scheduling sync of volume %s&#34;</span>, claimKey, volumeName)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 把绑定的PV加入到volumeQ中，交给volumeWorker去消费</span>
</span></span><span style="display:flex;"><span>    ctrl.volumeQueue.<span style="color:#fabd2f">Add</span>(volumeName)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="pv-的三种回收策略">PV 的三种回收策略</h2>
<p>PV的回收是在 PV Controller 中完成的：</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// reclaimVolume implements volume.Spec.PersistentVolumeReclaimPolicy and</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// starts appropriate reclaim action.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">reclaimVolume</span>(volume <span style="color:#fe8019">*</span>v1.PersistentVolume) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// CSI Driver migration相关，可以转化为CSIDriver，那就交给CSIDriver来操作，直接返回</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 注意了，这里比较有趣的点是</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 1. 如果PV的 provisioner是In-Tree volume plugin的化， 这里分2种情况</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">//    a） 这个provisioner实现了CSI Driver migration特性，就是接下来判断的逻辑，直接返回就可以了，不需要PV Controller去做这些操作，虽然PV Controller是可以的，毕竟是In-Tree olume plugin，肯定实现了PV的创建和删除的逻辑</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">//    b） 这个provisioner没有实现CSI Driver migration特性，那就继续逻辑往下走，需要PV Controller去操刀volums plugins调用其实现的PV的创建和删除的逻辑</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 2. 如果PV的provisioner是 第三方，那下面的CSIDriver migration判断肯定是不成立，那就要往下走逻辑了，如果你要是注意的化，CSI volume plugin是没有实现这2个</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 接口的：DeletableVolumePlugin(删除PV)，和rovisionableVolumePlugin这两个接口的，可以结合FindProvisionablePluginByName和   FindDeletablePluginBySpec这两个方法来看，但是In-tree volume plugin 肯定是实现的的，这个后续的处理就比较好理解了，可以接着看后续的分析</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> migrated <span style="color:#fe8019">:=</span> volume.Annotations[pvutil.AnnMigratedTo]; <span style="color:#fabd2f">len</span>(migrated) &gt; <span style="color:#d3869b">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// PV is Migrated. The PV controller should stand down and the external</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// provisioner will handle this PV</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>    }    
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">switch</span> volume.Spec.PersistentVolumeReclaimPolicy {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">case</span> v1.PersistentVolumeReclaimRetain: <span style="color:#8ec07c">//保留策略，直接什么都不做</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;reclaimVolume[%s]: policy is Retain, nothing to do&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">case</span> v1.PersistentVolumeReclaimRecycle: <span style="color:#928374;font-style:italic">// 回收在利用</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;reclaimVolume[%s]: policy is Recycle&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>        opName <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;recycle-%s[%s]&#34;</span>, volume.Name, <span style="color:#fabd2f">string</span>(volume.UID))
</span></span><span style="display:flex;"><span>        ctrl.<span style="color:#fabd2f">scheduleOperation</span>(opName, <span style="color:#fe8019">func</span>() <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>            ctrl.<span style="color:#fabd2f">recycleVolumeOperation</span>(volume)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">case</span> v1.PersistentVolumeReclaimDelete: <span style="color:#928374;font-style:italic">// 直接删除</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;reclaimVolume[%s]: policy is Delete&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>        opName <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;delete-%s[%s]&#34;</span>, volume.Name, <span style="color:#fabd2f">string</span>(volume.UID))
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// create a start timestamp entry in cache for deletion operation if no one exists with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// key = volume.Name, pluginName = provisionerName, operation = &#34;delete&#34;</span>
</span></span><span style="display:flex;"><span>        ctrl.operationTimestamps.<span style="color:#fabd2f">AddIfNotExist</span>(volume.Name, ctrl.<span style="color:#fabd2f">getProvisionerNameFromVolume</span>(volume), <span style="color:#b8bb26">&#34;delete&#34;</span>)
</span></span><span style="display:flex;"><span>        ctrl.<span style="color:#fabd2f">scheduleOperation</span>(opName, <span style="color:#fe8019">func</span>() <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>            _, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">deleteVolumeOperation</span>(volume)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// only report error count to &#34;volume_operation_total_errors&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// latency reporting will happen when the volume get finally</span>
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// deleted and a volume deleted event is captured</span>
</span></span><span style="display:flex;"><span>                metrics.<span style="color:#fabd2f">RecordMetric</span>(volume.Name, <span style="color:#fe8019">&amp;</span>ctrl.operationTimestamps, err) 
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">default</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Unknown PersistentVolumeReclaimPolicy</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 更新状态, 即不认识的回收策略</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> _, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">updateVolumePhaseWithEvent</span>(volume, v1.VolumeFailed, v1.EventTypeWarning, <span style="color:#b8bb26">&#34;VolumeUnknownReclaimPolicy&#34;</span>, <span style="color:#b8bb26">&#34;Volume has unrecognized PersistentVolumeReclaimPolicy&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }    
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="retain-保留策略">Retain： 保留策略</h3>
<p>保留策略最好理解，即保留PV资源，所以什么都不需要做即可</p>
<h3 id="recycle-重新利用策略">Recycle： 重新利用策略</h3>
<ul>
<li>
<p>首先判断是否PV已经处于 released 的状态，如果不是，则不能进行 recycle</p>
</li>
<li>
<p>其次判断该 PV 是否有 pod 正在使用，如果有也不能进行 recycle</p>
</li>
<li>
<p>然后交给 volume plugins manager 去执行 recycle 操作，这里对应的是 In-tree</p>
<ul>
<li>上一个步骤执行完成且无错误，就需要更新PV
<ul>
<li>清除PV .metadata.annotations[&ldquo;pv.kubernetes.io/bound-by-controller&rdquo;]</li>
<li>重置pv .spec.clamiRef = nil</li>
<li>修改ETCD， 更新本地缓存， 修改状态为Avaliable</li>
</ul>
</li>
</ul>
<p>使PV再度Avaliable。</p>
</li>
<li>
<p>如果是 out-tree 的化，volume plugins manager 肯定找不到合适的 volume plugin 来做这件事情，这件事情是由 external-provisioner 来做的</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// recycleVolumeOperation recycles a volume. This method is running in</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// standalone goroutine and already has all necessary locks.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">recycleVolumeOperation</span>(volume <span style="color:#fe8019">*</span>v1.PersistentVolume) {
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;recycleVolumeOperation [%s] started&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// This method may have been waiting for a volume lock for some time.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Previous recycleVolumeOperation might just have saved an updated version,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// so read current volume state now.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 直接从APIServer获取该PV的最新资源状态</span>
</span></span><span style="display:flex;"><span>    newVolume, err <span style="color:#fe8019">:=</span> ctrl.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">PersistentVolumes</span>().<span style="color:#fabd2f">Get</span>(context.<span style="color:#fabd2f">TODO</span>(), volume.Name, metav1.GetOptions{})
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error reading persistent volume %q: %v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 是否已经处于解绑released的状态</span>
</span></span><span style="display:flex;"><span>    needsReclaim, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">isVolumeReleased</span>(newVolume)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error reading claim for volume %q: %v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !needsReclaim { <span style="color:#8ec07c">//不是，直接返回</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q no longer needs recycling, skipping&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 通过pv.claimref找到正在使用该PV的pods集合</span>
</span></span><span style="display:flex;"><span>    pods, used, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">isVolumeUsed</span>(newVolume)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;can&#39;t recycle volume %q: %v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Verify the claim is in cache: if so, then it is a different PVC with the same name</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// since the volume is known to be released at this moment. The new (cached) PVC must use</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// a different PV -- we checked that the PV is unused in isVolumeReleased.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// So the old PV is safe to be recycled.</span>
</span></span><span style="display:flex;"><span>    claimName <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef)
</span></span><span style="display:flex;"><span>    _, claimCached, err <span style="color:#fe8019">:=</span> ctrl.claims.<span style="color:#fabd2f">GetByKey</span>(claimName)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error getting the claim %s from cache&#34;</span>, claimName)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// pv正在被pod使用，并且pvc在本地缓存中已经没有记录了，说明pvc已经从集群中删除了， 但是pod还在使用pv，不能被回收</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> used <span style="color:#fe8019">&amp;&amp;</span> !claimCached {
</span></span><span style="display:flex;"><span>        msg <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Volume is used by pods: %s&#34;</span>, strings.<span style="color:#fabd2f">Join</span>(pods, <span style="color:#b8bb26">&#34;,&#34;</span>))
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;can&#39;t recycle volume %q: %s&#34;</span>, volume.Name, msg)
</span></span><span style="display:flex;"><span>        ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(volume, v1.EventTypeNormal, events.VolumeFailedRecycle, msg)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Use the newest volume copy, this will save us from version conflicts on</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// saving.</span>
</span></span><span style="display:flex;"><span>    volume = newVolume
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Find a plugin.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 找到合适的有回收能力的volume plugin</span>
</span></span><span style="display:flex;"><span>    spec <span style="color:#fe8019">:=</span> vol.<span style="color:#fabd2f">NewSpecFromPersistentVolume</span>(volume, <span style="color:#fe8019">false</span>)
</span></span><span style="display:flex;"><span>    plugin, err <span style="color:#fe8019">:=</span> ctrl.volumePluginMgr.<span style="color:#fabd2f">FindRecyclablePluginBySpec</span>(spec)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> { <span style="color:#928374;font-style:italic">// 找不到合适的olume plugin, 直接返回，对于Out-tree 的，这个会由external-provisioner来去做这件事情</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// No recycler found. Emit an event and mark the volume Failed.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> _, err = ctrl.<span style="color:#fabd2f">updateVolumePhaseWithEvent</span>(volume, v1.VolumeFailed, v1.EventTypeWarning, events.VolumeFailedRecycle, <span style="color:#b8bb26">&#34;No recycler plugin found for the volume!&#34;</span>); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;recycleVolumeOperation [%s]: failed to mark volume as failed: %v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Save failed, retry on the next deletion attempt</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Despite the volume being Failed, the controller will retry recycling</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// the volume in every syncVolume() call.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Plugin found</span>
</span></span><span style="display:flex;"><span>    recorder <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">newRecyclerEventRecorder</span>(volume)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 执行回收操作</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err = plugin.<span style="color:#fabd2f">Recycle</span>(volume.Name, spec, recorder); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Recycler failed</span>
</span></span><span style="display:flex;"><span>        strerr <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;Recycle failed: %s&#34;</span>, err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> _, err = ctrl.<span style="color:#fabd2f">updateVolumePhaseWithEvent</span>(volume, v1.VolumeFailed, v1.EventTypeWarning, events.VolumeFailedRecycle, strerr); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;recycleVolumeOperation [%s]: failed to mark volume as failed: %v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Save failed, retry on the next deletion attempt</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Despite the volume being Failed, the controller will retry recycling</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// the volume in every syncVolume() call.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q recycled&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Send an event</span>
</span></span><span style="display:flex;"><span>    ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(volume, v1.EventTypeNormal, events.VolumeRecycled, <span style="color:#b8bb26">&#34;Volume recycled&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Make the volume available again</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 清除PV .metadata.annotations[&#34;pv.kubernetes.io/bound-by-controller&#34;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 重置pv .spec.clamiRef = nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 修改ETCD， 更新本地缓存， 修改状态为Avaliable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err = ctrl.<span style="color:#fabd2f">unbindVolume</span>(volume); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Oops, could not save the volume and therefore the controller will</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// recycle the volume again on next update. We _could_ maintain a cache</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// of &#34;recently recycled volumes&#34; and avoid unnecessary recycling, this</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// is left out as future optimization.</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;recycleVolumeOperation [%s]: failed to make recycled volume &#39;Available&#39; (%v), we will recycle the volume again&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// isVolumeReleased returns true if given volume is released and can be recycled</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// or deleted, based on its retain policy. I.e. the volume is bound to a claim</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// and the claim does not exist or exists and is bound to different volume.</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// 判断PV是否和PVC解绑了，也就是released</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// pv.claimRef != nil , 并且pv.claimRef.UID != nil, 且在pvc的informer cache中找不到记录， 或者找到记录了但pvc已经绑定到了别人，这样PV才算是解绑了的状态</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">isVolumeReleased</span>(volume <span style="color:#fe8019">*</span>v1.PersistentVolume) (<span style="color:#fabd2f">bool</span>, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// A volume needs reclaim if it has ClaimRef and appropriate claim does not</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// exist.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> volume.Spec.ClaimRef <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;isVolumeReleased[%s]: ClaimRef is nil&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> volume.Spec.ClaimRef.UID <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// This is a volume bound by user and the controller has not finished</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// binding to the real claim yet.</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;isVolumeReleased[%s]: ClaimRef is not bound&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">var</span> claim <span style="color:#fe8019">*</span>v1.PersistentVolumeClaim
</span></span><span style="display:flex;"><span>    claimName <span style="color:#fe8019">:=</span> <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef)
</span></span><span style="display:flex;"><span>    obj, found, err <span style="color:#fe8019">:=</span> ctrl.claims.<span style="color:#fabd2f">GetByKey</span>(claimName)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !found {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Fall through with claim = nil</span>
</span></span><span style="display:flex;"><span>    } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">var</span> ok <span style="color:#fabd2f">bool</span>
</span></span><span style="display:flex;"><span>        claim, ok = obj.(<span style="color:#fe8019">*</span>v1.PersistentVolumeClaim)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> !ok {
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Cannot convert object from claim cache to claim!?: %#v&#34;</span>, obj)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> claim <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">&amp;&amp;</span> claim.UID <span style="color:#fe8019">==</span> volume.Spec.ClaimRef.UID {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// the claim still exists and has the right UID</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> <span style="color:#fabd2f">len</span>(claim.Spec.VolumeName) &gt; <span style="color:#d3869b">0</span> <span style="color:#fe8019">&amp;&amp;</span> claim.Spec.VolumeName <span style="color:#fe8019">!=</span> volume.Name {
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// the claim is bound to another PV, this PV *is* released</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> <span style="color:#fe8019">true</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;isVolumeReleased[%s]: ClaimRef is still valid, volume is not released&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">false</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;isVolumeReleased[%s]: volume is released&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> <span style="color:#fe8019">true</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// isVolumeUsed returns list of active pods that use given PV.</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// 通过PVC来查找正在使用PV的pods集合</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">isVolumeUsed</span>(pv <span style="color:#fe8019">*</span>v1.PersistentVolume) ([]<span style="color:#fabd2f">string</span>, <span style="color:#fabd2f">bool</span>, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> pv.Spec.ClaimRef <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>, <span style="color:#fe8019">false</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>    }                
</span></span><span style="display:flex;"><span>    podNames <span style="color:#fe8019">:=</span> sets.<span style="color:#fabd2f">NewString</span>()
</span></span><span style="display:flex;"><span>    pvcKey <span style="color:#fe8019">:=</span> fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;%s/%s&#34;</span>, pv.Spec.ClaimRef.Namespace, pv.Spec.ClaimRef.Name)
</span></span><span style="display:flex;"><span>    pods, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">findPodsByPVCKey</span>(pvcKey)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>, <span style="color:#fe8019">false</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;error finding pods by pvc %q: %s&#34;</span>, pvcKey, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">for</span> _, pod <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> pods {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> util.<span style="color:#fabd2f">IsPodTerminated</span>(pod, pod.Status) {
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        podNames.<span style="color:#fabd2f">Insert</span>(pod.Namespace <span style="color:#fe8019">+</span> <span style="color:#b8bb26">&#34;/&#34;</span> <span style="color:#fe8019">+</span> pod.Name)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> podNames.<span style="color:#fabd2f">List</span>(), podNames.<span style="color:#fabd2f">Len</span>() <span style="color:#fe8019">!=</span> <span style="color:#d3869b">0</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// unbindVolume rolls back previous binding of the volume. This may be necessary</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// when two controllers bound two volumes to single claim - when we detect this,</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// only one binding succeeds and the second one must be rolled back.</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// This method updates both Spec and Status.</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// It returns on first error, it&#39;s up to the caller to implement some retry</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// mechanism.</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// 清除PV .metadata.annotations[&#34;pv.kubernetes.io/bound-by-controller&#34;]</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// 重置pv .spec.clamiRef = nil</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// 修改ETCD， 更新本地缓存， 修改状态为Avaliable</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">unbindVolume</span>(volume <span style="color:#fe8019">*</span>v1.PersistentVolume) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;updating PersistentVolume[%s]: rolling back binding from %q&#34;</span>, volume.Name, <span style="color:#fabd2f">claimrefToClaimKey</span>(volume.Spec.ClaimRef))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Save the PV only when any modification is necessary.</span>
</span></span><span style="display:flex;"><span>    volumeClone <span style="color:#fe8019">:=</span> volume.<span style="color:#fabd2f">DeepCopy</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> metav1.<span style="color:#fabd2f">HasAnnotation</span>(volume.ObjectMeta, pvutil.AnnBoundByController) {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// The volume was bound by the controller.</span>
</span></span><span style="display:flex;"><span>        volumeClone.Spec.ClaimRef = <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fabd2f">delete</span>(volumeClone.Annotations, pvutil.AnnBoundByController)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> <span style="color:#fabd2f">len</span>(volumeClone.Annotations) <span style="color:#fe8019">==</span> <span style="color:#d3869b">0</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// No annotations look better than empty annotation map (and it&#39;s easier</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// to test).</span>
</span></span><span style="display:flex;"><span>            volumeClone.Annotations = <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// The volume was pre-bound by user. Clear only the binding UID.</span>
</span></span><span style="display:flex;"><span>        volumeClone.Spec.ClaimRef.UID = <span style="color:#b8bb26">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    newVol, err <span style="color:#fe8019">:=</span> ctrl.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">PersistentVolumes</span>().<span style="color:#fabd2f">Update</span>(context.<span style="color:#fabd2f">TODO</span>(), volumeClone, metav1.UpdateOptions{})
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;updating PersistentVolume[%s]: rollback failed: %v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    _, err = ctrl.<span style="color:#fabd2f">storeVolumeUpdate</span>(newVol)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;updating PersistentVolume[%s]: cannot update internal cache: %v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;updating PersistentVolume[%s]: rolled back&#34;</span>, newVol.Name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Update the status</span>
</span></span><span style="display:flex;"><span>    _, err = ctrl.<span style="color:#fabd2f">updateVolumePhase</span>(newVol, v1.VolumeAvailable, <span style="color:#b8bb26">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="delete删除策略">Delete：删除策略</h3>
<p>删除策略和上面的[Recycle： 重新利用策略](#Recycle： 重新利用策略)实现大同小异</p>
<ul>
<li>如果是in-tree的，肯定是可以找到<strong>DeletableVolumePlugin</strong>，然后删除</li>
<li>如果是out-tree的，肯定是找不到<strong>DeletableVolumePlugin</strong>， 这个还是要借助<strong>external-provisioner</strong>来做</li>
<li>删除成功后，需要更新ETCD中的记录</li>
<li>这个过程中也伴随着PV的Status.Phase的变化</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>                                     
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// deleteVolumeOperation deletes a volume. This method is running in standalone                                      </span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// goroutine and already has all necessary locks.                                      </span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">deleteVolumeOperation</span>(volume <span style="color:#fe8019">*</span>v1.PersistentVolume) (<span style="color:#fabd2f">string</span>, <span style="color:#fabd2f">error</span>) {                                      
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;deleteVolumeOperation [%s] started&#34;</span>, volume.Name)                                      
</span></span><span style="display:flex;"><span>                                     
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// This method may have been waiting for a volume lock for some time.                                      </span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Previous deleteVolumeOperation might just have saved an updated version, so                                      </span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// read current volume state now.                                      </span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 获取最新的PV资源信息                                      </span>
</span></span><span style="display:flex;"><span>    newVolume, err <span style="color:#fe8019">:=</span> ctrl.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">PersistentVolumes</span>().<span style="color:#fabd2f">Get</span>(context.<span style="color:#fabd2f">TODO</span>(), volume.Name, metav1.GetOptions{})                                      
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {                                      
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error reading persistent volume %q: %v&#34;</span>, volume.Name, err)                                      
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#b8bb26">&#34;&#34;</span>, <span style="color:#fe8019">nil</span>                                      
</span></span><span style="display:flex;"><span>    }                                      
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 判断是否正在删除                                                                                                                                                               </span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> newVolume.<span style="color:#fabd2f">GetDeletionTimestamp</span>() <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {                                                                                                                                      
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Volume %q is already being deleted&#34;</span>, volume.Name)                                                                                                             
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#b8bb26">&#34;&#34;</span>, <span style="color:#fe8019">nil</span>                                                                                                                                                                
</span></span><span style="display:flex;"><span>    }                                                                                                                                                                                 
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// PV是否已经released，如果不是则不能删除                                      </span>
</span></span><span style="display:flex;"><span>    needsReclaim, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">isVolumeReleased</span>(newVolume)                                      
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {                                      
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error reading claim for volume %q: %v&#34;</span>, volume.Name, err)                                      
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#b8bb26">&#34;&#34;</span>, <span style="color:#fe8019">nil</span>                                      
</span></span><span style="display:flex;"><span>    }                                      
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !needsReclaim {                     
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q no longer needs deletion, skipping&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#b8bb26">&#34;&#34;</span>, <span style="color:#fe8019">nil</span>               
</span></span><span style="display:flex;"><span>    }                                      
</span></span><span style="display:flex;"><span>                                     
</span></span><span style="display:flex;"><span>    pluginName, deleted, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">doDeleteVolume</span>(volume)                                      
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {                                      
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Delete failed, update the volume and emit an event.                                      </span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;deletion of volume %q failed: %v&#34;</span>, volume.Name, err)                                      
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> volerr.<span style="color:#fabd2f">IsDeletedVolumeInUse</span>(err) {                                      
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// The plugin needs more time, don&#39;t mark the volume as Failed                                      </span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// and send Normal event only                                      </span>
</span></span><span style="display:flex;"><span>            ctrl.eventRecorder.<span style="color:#fabd2f">Event</span>(volume, v1.EventTypeNormal, events.VolumeDelete, err.<span style="color:#fabd2f">Error</span>())                                      
</span></span><span style="display:flex;"><span>        } <span style="color:#fe8019">else</span> {                                      
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// The plugin failed, mark the volume as Failed and send Warning                                      </span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// event                                      </span>
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> _, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">updateVolumePhaseWithEvent</span>(volume, v1.VolumeFailed, v1.EventTypeWarning, events.VolumeFailedDelete, err.<span style="color:#fabd2f">Error</span>()); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {                                      
</span></span><span style="display:flex;"><span>                klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;deleteVolumeOperation [%s]: failed to mark volume as failed: %v&#34;</span>, volume.Name, err)                                      
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// Save failed, retry on the next deletion attempt                                      </span>
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">return</span> pluginName, err                                     
</span></span><span style="display:flex;"><span>            }                                      
</span></span><span style="display:flex;"><span>        }                                      
</span></span><span style="display:flex;"><span>                                     
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Despite the volume being Failed, the controller will retry deleting                                      </span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// the volume in every syncVolume() call.                                      </span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, err                                     
</span></span><span style="display:flex;"><span>    }                                      
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !deleted {                                      
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// The volume waits for deletion by an external plugin. Do nothing.                                      </span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, <span style="color:#fe8019">nil</span>                                      
</span></span><span style="display:flex;"><span>    }                                      
</span></span><span style="display:flex;"><span>                                     
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;deleteVolumeOperation [%s]: success&#34;</span>, volume.Name)                                      
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Delete the volume                                      </span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 把ETCD中的该PV记录删除                                      </span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err = ctrl.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">PersistentVolumes</span>().<span style="color:#fabd2f">Delete</span>(context.<span style="color:#fabd2f">TODO</span>(), volume.Name, metav1.DeleteOptions{}); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {                                      
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Oops, could not delete the volume and therefore the controller will                                      </span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// try to delete the volume again on next update. We _could_ maintain a                                      </span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// cache of &#34;recently deleted volumes&#34; and avoid unnecessary deletion,                                      </span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// this is left out as future optimization.                                      </span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;failed to delete volume %q from database: %v&#34;</span>, volume.Name, err)                                      
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, <span style="color:#fe8019">nil</span>                                      
</span></span><span style="display:flex;"><span>    }                                      
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> pluginName, <span style="color:#fe8019">nil</span>                                      
</span></span><span style="display:flex;"><span>}                                      
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// doDeleteVolume finds appropriate delete plugin and deletes given volume, returning</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// the volume plugin name. Also, it returns &#39;true&#39;, when the volume was deleted and</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// &#39;false&#39; when the volume cannot be deleted because the deleter is external. No</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// error should be reported in this case.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (ctrl <span style="color:#fe8019">*</span>PersistentVolumeController) <span style="color:#fabd2f">doDeleteVolume</span>(volume <span style="color:#fe8019">*</span>v1.PersistentVolume) (<span style="color:#fabd2f">string</span>, <span style="color:#fabd2f">bool</span>, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;doDeleteVolume [%s]&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">var</span> err <span style="color:#fabd2f">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    plugin, err <span style="color:#fe8019">:=</span> ctrl.<span style="color:#fabd2f">findDeletablePlugin</span>(volume)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#b8bb26">&#34;&#34;</span>, <span style="color:#fe8019">false</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> plugin <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// External deleter is requested, do nothing</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">3</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;external deleter for volume %q requested, ignoring&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#b8bb26">&#34;&#34;</span>, <span style="color:#fe8019">false</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Plugin found</span>
</span></span><span style="display:flex;"><span>    pluginName <span style="color:#fe8019">:=</span> plugin.<span style="color:#fabd2f">GetPluginName</span>()
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;found a deleter plugin %q for volume %q&#34;</span>, pluginName, volume.Name)
</span></span><span style="display:flex;"><span>    spec <span style="color:#fe8019">:=</span> vol.<span style="color:#fabd2f">NewSpecFromPersistentVolume</span>(volume, <span style="color:#fe8019">false</span>)
</span></span><span style="display:flex;"><span>    deleter, err <span style="color:#fe8019">:=</span> plugin.<span style="color:#fabd2f">NewDeleter</span>(spec)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Cannot create deleter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, <span style="color:#fe8019">false</span>, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Failed to create deleter for volume %q: %v&#34;</span>, volume.Name, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    opComplete <span style="color:#fe8019">:=</span> util.<span style="color:#fabd2f">OperationCompleteHook</span>(pluginName, <span style="color:#b8bb26">&#34;volume_delete&#34;</span>)
</span></span><span style="display:flex;"><span>    err = deleter.<span style="color:#fabd2f">Delete</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#fabd2f">opComplete</span>(volumetypes.CompleteFuncParam{Err: <span style="color:#fe8019">&amp;</span>err})
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Deleter failed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> pluginName, <span style="color:#fe8019">false</span>, err
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;volume %q deleted&#34;</span>, volume.Name)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> pluginName, <span style="color:#fe8019">true</span>, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
  </div>


  
<div>
  <ul class="tags">
  <li>
    <a href="https://www.zhangzewen.net/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="tag-link">源码分析</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/kubernetes/" class="tag-link">Kubernetes</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/kubelet/" class="tag-link">Kubelet</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/csi/" class="tag-link">Csi</a>
  </li>
  </ul>
</div>



  <div class="share-buttons">
    
  
<script src="https://utteranc.es/client.js"
        repo="zhangzewen/zhangzewen.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>


  
</div>
  </main>

  <footer>
  <div>
    <p>
      &copy; Zhang Zewen 2025

      &middot; <a href="https://creativecommons.org/licenses/by-sa/4.0" target="_blank">CC BY-SA 4.0</a>

      
    </p>
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
    integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin="anonymous"></script>


  <script src="/js/jquery.min.js"></script>
  <script src="/js/soho.js"></script>

  

  
  
  
</body>

</html>
