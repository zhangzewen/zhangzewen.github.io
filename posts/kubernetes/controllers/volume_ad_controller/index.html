<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xml:lang="zh-cn" lang="zh-cn" >

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.149.0">

  <title>kubernetes 源码分析之 AttachDetach Controller  &middot; What a Life!</title>

  <meta name="description" content="" />

  
  <meta itemprop="name" content="kubernetes 源码分析之 AttachDetach Controller ">
  <meta itemprop="description" content="本篇文章基于 Kubernetes v1.25.1
AttachDetach Controller 是 kubernetes controller-manager 的组件之一， 通过监听 AttchDetachment 资源的状态来进行 Attach 和 Detach 操作，并且维护和谐调(进行 Attach 和 Detach，以及修改 Node 资源的状态)实际状态和期望状态。">
  <meta itemprop="datePublished" content="2025-08-29T02:43:31+08:00">
  <meta itemprop="dateModified" content="2025-08-29T02:43:31+08:00">
  <meta itemprop="wordCount" content="3763">
  <meta itemprop="image" content="https://www.zhangzewen.net/images/profile.png">
  <meta itemprop="keywords" content="源码分析,Kubernetes,Kubelet,Csi">


  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://www.zhangzewen.net/images/profile.png">
  <meta name="twitter:title" content="kubernetes 源码分析之 AttachDetach Controller ">
  <meta name="twitter:description" content="本篇文章基于 Kubernetes v1.25.1
AttachDetach Controller 是 kubernetes controller-manager 的组件之一， 通过监听 AttchDetachment 资源的状态来进行 Attach 和 Detach 操作，并且维护和谐调(进行 Attach 和 Detach，以及修改 Node 资源的状态)实际状态和期望状态。">


<meta property="og:url" content="https://www.zhangzewen.net/posts/kubernetes/controllers/volume_ad_controller/">
  <meta property="og:site_name" content="What a Life!">
  <meta property="og:title" content="kubernetes 源码分析之 AttachDetach Controller ">
  <meta property="og:description" content="本篇文章基于 Kubernetes v1.25.1
AttachDetach Controller 是 kubernetes controller-manager 的组件之一， 通过监听 AttchDetachment 资源的状态来进行 Attach 和 Detach 操作，并且维护和谐调(进行 Attach 和 Detach，以及修改 Node 资源的状态)实际状态和期望状态。">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-29T02:43:31+08:00">
    <meta property="article:modified_time" content="2025-08-29T02:43:31+08:00">
    <meta property="article:tag" content="源码分析">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Kubelet">
    <meta property="article:tag" content="Csi">
    <meta property="og:image" content="https://www.zhangzewen.net/images/profile.png">



<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type":"Person",
      "@id": "https://www.zhangzewen.net/#author",
      "name": "Zhang Zewen",
      "image": {
        "@type":"ImageObject",
        
        "url": "https://www.zhangzewen.net/images/android-chrome-512x512.png"
        
      },
      "description": "Software Engineer"
    },
    {
      "@type": "WebSite",
      "@id": "https://www.zhangzewen.net/#website",
      "url": "https://www.zhangzewen.net/",
      "name": "What a Life!",
      "description": "Software Engineer",
      "publisher": {
        "@id": "https://www.zhangzewen.net/#author"
      },
      "inLanguage": "zh-cn"
    },
    {
      "@type": "ImageObject",
      "url": "https://www.zhangzewen.net/images/profile.png",
      "caption": "What a Life!"
    },
    {
      "@type": "WebPage",
      "@id": "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_ad_controller/#webpage",
      "url": "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_ad_controller/",
      "name": "kubernetes 源码分析之 AttachDetach Controller ",
      "isPartOf": {
        "@id": "https://www.zhangzewen.net/#website"
      },
      "about": {
         "@id": "https://www.zhangzewen.net/#author"
      },
      "datePublished": "2025-08-29T02:43:31+08:00",
      "dateModified": "2025-08-29T02:43:31+08:00",
      "description": "\u003cblockquote\u003e\n\u003cp\u003e本篇文章基于 Kubernetes v1.25.1\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eAttachDetach Controller 是 kubernetes controller-manager 的组件之一， 通过监听 AttchDetachment 资源的状态来进行 Attach 和 Detach 操作，并且维护和谐调(进行 Attach 和 Detach，以及修改 Node 资源的状态)实际状态和期望状态。\u003c/p\u003e",
      "inLanguage": "zh-cn",
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_ad_controller/"
          ]
        }
      ]
    },
    {
      "@type": "Article",
      "isPartOf": {
        "@id": "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_ad_controller/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_ad_controller/#webpage"
      },
      "headline": "kubernetes 源码分析之 AttachDetach Controller ",
      "datePublished": "2025-08-29T02:43:31+08:00",
      "dateModified": "2025-08-29T02:43:31+08:00",
      "publisher": {
        "@id": "https://www.zhangzewen.net/#author"
      },
      "keywords": [
        "源码分析",
        "Kubernetes",
        "Kubelet",
        "Csi"
      ],
      "articleSection": [
      ],
      "inLanguage": "zh-cn",
      "author": {
        "@type": "Person",
        "name":  null 
      },
      "potentialAction": [
        {
          "@type": "CommentAction",
          "name": "Comment",
          "target": [
            "https://www.zhangzewen.net/posts/kubernetes/controllers/volume_ad_controller/#comments"
          ]
        }
      ]
    }
  ]
}
</script>



  <link type="text/css" rel="stylesheet" href="/css/print.css" media="print">

  <link type="text/css" rel="stylesheet" href="/css/poole.css">

  <link type="text/css" rel="stylesheet" href="/css/hyde.css">

  


  

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
    integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>

<body>
  <aside class="toc">
  
  
  <h3>目录</h3>
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#期望状态管理">期望状态管理</a>
          <ul>
            <li><a href="#添加node">添加Node</a></li>
            <li><a href="#删除node">删除Node</a></li>
            <li><a href="#添加pod">添加Pod</a></li>
            <li><a href="#删除pod">删除Pod</a></li>
          </ul>
        </li>
        <li><a href="#实际状态管理">实际状态管理</a>
          <ul>
            <li><a href="#addvolumenode">AddVolumeNode</a></li>
            <li><a href="#deletevolumenode">DeleteVolumeNode</a></li>
          </ul>
        </li>
        <li><a href="#协调器">协调器</a></li>
        <li><a href="#attachdetach-controller">AttachDetach Controller</a>
          <ul>
            <li><a href="#启动">启动</a></li>
            <li><a href="#初始化实际状态">初始化实际状态</a></li>
            <li><a href="#注册的事件handler">注册的事件Handler</a>
              <ul>
                <li><a href="#pod变更事件">Pod变更事件</a></li>
                <li><a href="#node变更事件">Node变更事件</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
  </ul>
</nav>
  
  
</aside>

  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <a href="https://www.zhangzewen.net/">
            <img src="/images/android-chrome-512x512.png" class="img-circle img-headshot center" alt="Profile Picture">
          </a>
        </div>
        
      

      <h1>What a Life!</h1>

      
      <p class="lead">Software Engineer</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="https://www.zhangzewen.net/">Home</a>
        </li>
        <li>
          <a href="/tags/">Tags</a>
        </li><li>
          <a href="/archive/">Archives</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
    </section>
  </div>
</aside>


  <main class="content container">
    <div class="post">
  <h1 class="title">kubernetes 源码分析之 AttachDetach Controller </h1>
  
  

  <div class="post-date">
    <time datetime=" 2025-08-29T02:43:31&#43;0800">Created: Aug 29, 2025</time>
    <span class="readtime">&middot; 18 min read</span>
  </div>

  <div>
    <blockquote>
<p>本篇文章基于 Kubernetes v1.25.1</p></blockquote>
<p>AttachDetach Controller 是 kubernetes controller-manager 的组件之一， 通过监听 AttchDetachment 资源的状态来进行 Attach 和 Detach 操作，并且维护和谐调(进行 Attach 和 Detach，以及修改 Node 资源的状态)实际状态和期望状态。</p>
<p>AttachDetach Controller 维护着2份 Cache，一份是<a href="#%E6%9C%9F%E6%9C%9B%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">期望状态的Cache</a>, 其维护了 <code>node-&gt;volume-&gt;pod</code> 的信息。一份是<a href="#%E5%AE%9E%E9%99%85%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">实际状态Cache</a>，其维护着是 volume-&gt;node 的 attached 状态信息，以及是否 mount 的信息。实现来说， <a href="#%E6%9C%9F%E6%9C%9B%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">期望状态的 Cache</a> 要比<a href="#%E5%AE%9E%E9%99%85%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">实际状态 Cache</a>简单的多。</p>
<h2 id="期望状态管理">期望状态管理</h2>
<p>desiredStateOfWorld 有以下几个字段：</p>
<ul>
<li>nodesManaged 是一个 map 类型的数据，( NodeName，nodeManaged)是一条记录，nodeManaged维护着 node 的期望状态的信息，这个信息里面包括一个 map 类型的字段 volumesToAttach，这是一个 map 类型的数据，(volumeName，volumeToAttach)是一条记录，也就是说 DSW 维护着 node 上期望 attached 的所有 volume 的信息。还有就是 volumeToAttach 也维护着(volumeName, []Pod)的信息，也就是说可以通过 <code>node-&gt;volume-&gt;pod</code> 找到自己想要的信息</li>
</ul>
<h3 id="添加node">添加Node</h3>
<p>DSW 添加一条 Node 的记录的逻辑很简单，如果记录已经存在什么也不做，否着就添加一条记录：</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (dsw <span style="color:#fe8019">*</span>desiredStateOfWorld) <span style="color:#fabd2f">AddNode</span>(nodeName k8stypes.NodeName, keepTerminatedPodVolumes <span style="color:#fabd2f">bool</span>) {
</span></span><span style="display:flex;"><span>    dsw.<span style="color:#fabd2f">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">defer</span> dsw.<span style="color:#fabd2f">Unlock</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> _, nodeExists <span style="color:#fe8019">:=</span> dsw.nodesManaged[nodeName]; !nodeExists {
</span></span><span style="display:flex;"><span>        dsw.nodesManaged[nodeName] = nodeManaged{
</span></span><span style="display:flex;"><span>            nodeName:                 nodeName,
</span></span><span style="display:flex;"><span>            volumesToAttach:          <span style="color:#fabd2f">make</span>(<span style="color:#fe8019">map</span>[v1.UniqueVolumeName]volumeToAttach),
</span></span><span style="display:flex;"><span>            keepTerminatedPodVolumes: keepTerminatedPodVolumes,
</span></span><span style="display:flex;"><span>        }   
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>}   
</span></span></code></pre></div><h3 id="删除node">删除Node</h3>
<ul>
<li>当Node的记录不存在的时候直接返回</li>
<li>如果Node的记录存在，且其期望要 attach 的 volume 列表不为空的时候直接返回错误</li>
<li>最后删除该 Node 记录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (dsw <span style="color:#fe8019">*</span>desiredStateOfWorld) <span style="color:#fabd2f">DeleteNode</span>(nodeName k8stypes.NodeName) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>    dsw.<span style="color:#fabd2f">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">defer</span> dsw.<span style="color:#fabd2f">Unlock</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    nodeObj, nodeExists <span style="color:#fe8019">:=</span> dsw.nodesManaged[nodeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !nodeExists {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span> 
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> <span style="color:#fabd2f">len</span>(nodeObj.volumesToAttach) &gt; <span style="color:#d3869b">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> fmt.<span style="color:#fabd2f">Errorf</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#b8bb26">&#34;failed to delete node %q from list of nodes managed by attach/detach controller--the node still contains %v volumes in its list of volumes to attach&#34;</span>,
</span></span><span style="display:flex;"><span>            nodeName,
</span></span><span style="display:flex;"><span>            <span style="color:#fabd2f">len</span>(nodeObj.volumesToAttach))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fabd2f">delete</span>(
</span></span><span style="display:flex;"><span>        dsw.nodesManaged,
</span></span><span style="display:flex;"><span>        nodeName)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="添加pod">添加Pod</h3>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (dsw <span style="color:#fe8019">*</span>desiredStateOfWorld) <span style="color:#fabd2f">AddPod</span>(
</span></span><span style="display:flex;"><span>    podName types.UniquePodName,
</span></span><span style="display:flex;"><span>    podToAdd <span style="color:#fe8019">*</span>v1.Pod,
</span></span><span style="display:flex;"><span>    volumeSpec <span style="color:#fe8019">*</span>volume.Spec,
</span></span><span style="display:flex;"><span>    nodeName k8stypes.NodeName) (v1.UniqueVolumeName, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    dsw.<span style="color:#fabd2f">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">defer</span> dsw.<span style="color:#fabd2f">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    nodeObj, nodeExists <span style="color:#fe8019">:=</span> dsw.nodesManaged[nodeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !nodeExists {<span style="color:#928374;font-style:italic">// Node记录不存在，返回错误</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#b8bb26">&#34;&#34;</span>, fmt.<span style="color:#fabd2f">Errorf</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#b8bb26">&#34;no node with the name %q exists in the list of managed nodes&#34;</span>,
</span></span><span style="display:flex;"><span>            nodeName)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 如果volume找不到合适的volume plugin来进行挂载，也返回错误</span>
</span></span><span style="display:flex;"><span>    attachableVolumePlugin, err <span style="color:#fe8019">:=</span> dsw.volumePluginMgr.<span style="color:#fabd2f">FindAttachablePluginBySpec</span>(volumeSpec)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">||</span> attachableVolumePlugin <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> attachableVolumePlugin <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            err = fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;plugin do not support attachment&#34;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#b8bb26">&#34;&#34;</span>, fmt.<span style="color:#fabd2f">Errorf</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#b8bb26">&#34;failed to get AttachablePlugin from volumeSpec for volume %q err=%v&#34;</span>,
</span></span><span style="display:flex;"><span>            volumeSpec.<span style="color:#fabd2f">Name</span>(),
</span></span><span style="display:flex;"><span>            err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>   <span style="color:#928374;font-style:italic">// volumeName ==&gt; &lt;pluginName&gt;/&lt;volumeName&gt;</span>
</span></span><span style="display:flex;"><span>    volumeName, err <span style="color:#fe8019">:=</span> util.<span style="color:#fabd2f">GetUniqueVolumeNameFromSpec</span>(
</span></span><span style="display:flex;"><span>        attachableVolumePlugin, volumeSpec)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#b8bb26">&#34;&#34;</span>, fmt.<span style="color:#fabd2f">Errorf</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#b8bb26">&#34;failed to get UniqueVolumeName from volumeSpec for plugin=%q and volume=%q err=%v&#34;</span>,
</span></span><span style="display:flex;"><span>            attachableVolumePlugin.<span style="color:#fabd2f">GetPluginName</span>(),
</span></span><span style="display:flex;"><span>            volumeSpec.<span style="color:#fabd2f">Name</span>(),
</span></span><span style="display:flex;"><span>            err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    volumeObj, volumeExists <span style="color:#fe8019">:=</span> nodeObj.volumesToAttach[volumeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !volumeExists {<span style="color:#928374;font-style:italic">// 记录不存在，创建一条记录</span>
</span></span><span style="display:flex;"><span>        volumeObj = volumeToAttach{
</span></span><span style="display:flex;"><span>            multiAttachErrorReported: <span style="color:#fe8019">false</span>,
</span></span><span style="display:flex;"><span>            volumeName:               volumeName,
</span></span><span style="display:flex;"><span>            spec:                     volumeSpec,
</span></span><span style="display:flex;"><span>            scheduledPods:            <span style="color:#fabd2f">make</span>(<span style="color:#fe8019">map</span>[types.UniquePodName]pod),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 写入记录</span>
</span></span><span style="display:flex;"><span>        dsw.nodesManaged[nodeName].volumesToAttach[volumeName] = volumeObj
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> _, podExists <span style="color:#fe8019">:=</span> volumeObj.scheduledPods[podName]; !podExists {<span style="color:#8ec07c">//记录不存在就创建</span>
</span></span><span style="display:flex;"><span>        dsw.nodesManaged[nodeName].volumesToAttach[volumeName].scheduledPods[podName] =
</span></span><span style="display:flex;"><span>            pod{
</span></span><span style="display:flex;"><span>                podName: podName,
</span></span><span style="display:flex;"><span>                podObj:  podToAdd,
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> volumeName, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="删除pod">删除Pod</h3>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (dsw <span style="color:#fe8019">*</span>desiredStateOfWorld) <span style="color:#fabd2f">DeletePod</span>(
</span></span><span style="display:flex;"><span>    podName types.UniquePodName,
</span></span><span style="display:flex;"><span>    volumeName v1.UniqueVolumeName,
</span></span><span style="display:flex;"><span>    nodeName k8stypes.NodeName) {
</span></span><span style="display:flex;"><span>    dsw.<span style="color:#fabd2f">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">defer</span> dsw.<span style="color:#fabd2f">Unlock</span>()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    nodeObj, nodeExists <span style="color:#fe8019">:=</span> dsw.nodesManaged[nodeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !nodeExists {<span style="color:#928374;font-style:italic">// Node记录不存在直接返回</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    volumeObj, volumeExists <span style="color:#fe8019">:=</span> nodeObj.volumesToAttach[volumeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !volumeExists {<span style="color:#928374;font-style:italic">// volume记录不存在直接返回</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> _, podExists <span style="color:#fe8019">:=</span> volumeObj.scheduledPods[podName]; !podExists {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> <span style="color:#928374;font-style:italic">// pods记录不存在直接返回</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 删除相关记录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fabd2f">delete</span>(
</span></span><span style="display:flex;"><span>        dsw.nodesManaged[nodeName].volumesToAttach[volumeName].scheduledPods,
</span></span><span style="display:flex;"><span>        podName)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> <span style="color:#fabd2f">len</span>(volumeObj.scheduledPods) <span style="color:#fe8019">==</span> <span style="color:#d3869b">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fabd2f">delete</span>(
</span></span><span style="display:flex;"><span>            dsw.nodesManaged[nodeName].volumesToAttach,
</span></span><span style="display:flex;"><span>            volumeName)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><h2 id="实际状态管理">实际状态管理</h2>
<p>attachDetachController 有如下几个字段：</p>
<ul>
<li>attachedVolumes 这是一个 map 类型的数据, <code>(volumeName， attachedVolume)</code>是一条记录，这里的 attachedVolume 维护着 volume 自身的信息，以及一个nodeName 到 nodeAttachedTo 的映射表。总而言之，就是 attachedVolumes 维护着 volume 绑定到所有node节点的信息。</li>
<li>nodesToUpdateStatusFor 这个也是一个map类型的数据, (nodeName, nodeToUpdateStatusFor)也是一条记录，其维护着需要更新 <code>node.Status.VolumeAttached</code>(Node API Object)的node的信息</li>
</ul>
<p>Attach的三个状态</p>
<ul>
<li>Attached：volume 已经 attach 到 node 上了</li>
<li>Uncertain：volume 的 attach 或者 detach 状态未知</li>
<li>Detached：volume 已经从 node 上 detached</li>
</ul>
<p>和这三个状态相关的函数有三个，如下图：</p>
<p><img src="/images/k8s/csi/volume_ad_controller/attach_detach_controller_02.svg" alt="node_driver_registrar_02"></p>
<p>下面来看看这几个函数的逻辑，从中理解实际状态管理的实现逻辑</p>
<h3 id="addvolumenode">AddVolumeNode</h3>
<p>该函数的逻辑主要是更新 attachedVolumes 和 nodesToUpdateStatusFor 这两个字段中的记录</p>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (asw <span style="color:#fe8019">*</span>actualStateOfWorld) <span style="color:#fabd2f">AddVolumeNode</span>(
</span></span><span style="display:flex;"><span>    uniqueName v1.UniqueVolumeName, volumeSpec <span style="color:#fe8019">*</span>volume.Spec, nodeName types.NodeName, devicePath <span style="color:#fabd2f">string</span>, isAttached <span style="color:#fabd2f">bool</span>) (v1.UniqueVolumeName, <span style="color:#fabd2f">error</span>) {
</span></span><span style="display:flex;"><span>    volumeName <span style="color:#fe8019">:=</span> uniqueName
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> volumeName <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;&#34;</span> { <span style="color:#928374;font-style:italic">// 如果volumeName不存在，就需要获取volumeName</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// volumeName和olumeSpec不能都为nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> volumeSpec <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> volumeName, fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;volumeSpec cannot be nil if volumeName is empty&#34;</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 在volumes plugins中找到和是的AttachableVolumePlugin</span>
</span></span><span style="display:flex;"><span>        attachableVolumePlugin, err <span style="color:#fe8019">:=</span> asw.volumePluginMgr.<span style="color:#fabd2f">FindAttachablePluginBySpec</span>(volumeSpec)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">||</span> attachableVolumePlugin <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> { <span style="color:#928374;font-style:italic">// 出错了或者找不到AttachableVolumePlugin, 直接返回错误</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> attachableVolumePlugin <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>                err = fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;plugin do not support attachment&#34;</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> <span style="color:#b8bb26">&#34;&#34;</span>, fmt.<span style="color:#fabd2f">Errorf</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#b8bb26">&#34;failed to get AttachablePlugin from volumeSpec for volume %q err=%v&#34;</span>,                                                                        
</span></span><span style="display:flex;"><span>                volumeSpec.<span style="color:#fabd2f">Name</span>(),                                                                                                                            
</span></span><span style="display:flex;"><span>                err)                                                                                                                                          
</span></span><span style="display:flex;"><span>        }                                                                                                                                                     
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 这个olumeName的格式是&lt;pluginName&gt;/&lt;volumeName&gt;                                                                                                     </span>
</span></span><span style="display:flex;"><span>        volumeName, err = util.<span style="color:#fabd2f">GetUniqueVolumeNameFromSpec</span>(
</span></span><span style="display:flex;"><span>            attachableVolumePlugin, volumeSpec)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> <span style="color:#b8bb26">&#34;&#34;</span>, fmt.<span style="color:#fabd2f">Errorf</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#b8bb26">&#34;failed to GetUniqueVolumeNameFromSpec for volumeSpec %q err=%v&#34;</span>,
</span></span><span style="display:flex;"><span>                volumeSpec.<span style="color:#fabd2f">Name</span>(),
</span></span><span style="display:flex;"><span>                err)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 上锁</span>
</span></span><span style="display:flex;"><span>    asw.<span style="color:#fabd2f">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">defer</span> asw.<span style="color:#fabd2f">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    volumeObj, volumeExists <span style="color:#fe8019">:=</span> asw.attachedVolumes[volumeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !volumeExists { <span style="color:#8ec07c">//记录不存在，初始化的时候记录的确是不存在的</span>
</span></span><span style="display:flex;"><span>        volumeObj = attachedVolume{
</span></span><span style="display:flex;"><span>            volumeName:      volumeName,
</span></span><span style="display:flex;"><span>            spec:            volumeSpec,
</span></span><span style="display:flex;"><span>            nodesAttachedTo: <span style="color:#fabd2f">make</span>(<span style="color:#fe8019">map</span>[types.NodeName]nodeAttachedTo),
</span></span><span style="display:flex;"><span>            devicePath:      devicePath,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fe8019">else</span> { <span style="color:#928374;font-style:italic">// 记录存在，更新记录</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// If volume object already exists, it indicates that the information would be out of date.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Update the fields for volume object except the nodes attached to the volumes.</span>
</span></span><span style="display:flex;"><span>        volumeObj.devicePath = devicePath
</span></span><span style="display:flex;"><span>        volumeObj.spec = volumeSpec
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">2</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Volume %q is already added to attachedVolume list to node %q, update device path %q&#34;</span>,
</span></span><span style="display:flex;"><span>            volumeName,
</span></span><span style="display:flex;"><span>            nodeName,
</span></span><span style="display:flex;"><span>            devicePath)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    node, nodeExists <span style="color:#fe8019">:=</span> volumeObj.nodesAttachedTo[nodeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !nodeExists { <span style="color:#8ec07c">//记录不存在，初始化的时候记录的确是不存在的</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Create object if it doesn&#39;t exist.</span>
</span></span><span style="display:flex;"><span>        node = nodeAttachedTo{
</span></span><span style="display:flex;"><span>            nodeName: nodeName,
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">//  现假定已经mount了</span>
</span></span><span style="display:flex;"><span>            mountedByNode:       <span style="color:#fe8019">true</span>, <span style="color:#928374;font-style:italic">// Assume mounted, until proven otherwise</span>
</span></span><span style="display:flex;"><span>            attachedConfirmed:   isAttached,
</span></span><span style="display:flex;"><span>            detachRequestedTime: time.Time{},
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#fe8019">else</span> { <span style="color:#8ec07c">//记录存在，只修改是否attached标志位</span>
</span></span><span style="display:flex;"><span>        node.attachedConfirmed = isAttached
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Volume %q is already added to attachedVolume list to the node %q, the current attach state is %t&#34;</span>,
</span></span><span style="display:flex;"><span>            volumeName,
</span></span><span style="display:flex;"><span>            nodeName,
</span></span><span style="display:flex;"><span>            isAttached)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 创建记录</span>
</span></span><span style="display:flex;"><span>    volumeObj.nodesAttachedTo[nodeName] = node
</span></span><span style="display:flex;"><span>    asw.attachedVolumes[volumeName] = volumeObj
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> isAttached { <span style="color:#928374;font-style:italic">// attached标志位为true</span>
</span></span><span style="display:flex;"><span>        asw.<span style="color:#fabd2f">addVolumeToReportAsAttached</span>(volumeName, nodeName)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> volumeName, <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// Add the volumeName to the node&#39;s volumesToReportAsAttached list</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// This is an internal function and caller should acquire and release the lock</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (asw <span style="color:#fe8019">*</span>actualStateOfWorld) <span style="color:#fabd2f">addVolumeToReportAsAttached</span>(
</span></span><span style="display:flex;"><span>    volumeName v1.UniqueVolumeName, nodeName types.NodeName) {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// In case the volume/node entry is no longer in attachedVolume list, skip the rest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 现查看volume和node在ASW中是否存在记录，因为这个是被AddVolumeNode所调用，记录肯定是存在的</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> _, _, err <span style="color:#fe8019">:=</span> asw.<span style="color:#fabd2f">getNodeAndVolume</span>(volumeName, nodeName); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Volume %q is no longer attached to node %q&#34;</span>, volumeName, nodeName)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    nodeToUpdate, nodeToUpdateExists <span style="color:#fe8019">:=</span> asw.nodesToUpdateStatusFor[nodeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !nodeToUpdateExists {<span style="color:#928374;font-style:italic">// 记录不存在，创建记录</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Create object if it doesn&#39;t exist</span>
</span></span><span style="display:flex;"><span>        nodeToUpdate = nodeToUpdateStatusFor{
</span></span><span style="display:flex;"><span>            nodeName:                  nodeName,
</span></span><span style="display:flex;"><span>            statusUpdateNeeded:        <span style="color:#fe8019">true</span>,
</span></span><span style="display:flex;"><span>            volumesToReportAsAttached: <span style="color:#fabd2f">make</span>(<span style="color:#fe8019">map</span>[v1.UniqueVolumeName]v1.UniqueVolumeName),
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        asw.nodesToUpdateStatusFor[nodeName] = nodeToUpdate
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Add new node %q to nodesToUpdateStatusFor&#34;</span>, nodeName)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    _, nodeToUpdateVolumeExists <span style="color:#fe8019">:=</span>
</span></span><span style="display:flex;"><span>        nodeToUpdate.volumesToReportAsAttached[volumeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !nodeToUpdateVolumeExists {<span style="color:#928374;font-style:italic">// 不存在就需要创建记录</span>
</span></span><span style="display:flex;"><span>        nodeToUpdate.statusUpdateNeeded = <span style="color:#fe8019">true</span>
</span></span><span style="display:flex;"><span>        nodeToUpdate.volumesToReportAsAttached[volumeName] = volumeName
</span></span><span style="display:flex;"><span>        asw.nodesToUpdateStatusFor[nodeName] = nodeToUpdate
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Report volume %q as attached to node %q&#34;</span>, volumeName, nodeName)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h3 id="deletevolumenode">DeleteVolumeNode</h3>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (asw <span style="color:#fe8019">*</span>actualStateOfWorld) <span style="color:#fabd2f">DeleteVolumeNode</span>(
</span></span><span style="display:flex;"><span>    volumeName v1.UniqueVolumeName, nodeName types.NodeName) {
</span></span><span style="display:flex;"><span>    asw.<span style="color:#fabd2f">Lock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">defer</span> asw.<span style="color:#fabd2f">Unlock</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 获取volume信息</span>
</span></span><span style="display:flex;"><span>    volumeObj, volumeExists <span style="color:#fe8019">:=</span> asw.attachedVolumes[volumeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> !volumeExists { <span style="color:#8ec07c">//不存在直接返回</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>   <span style="color:#928374;font-style:italic">// 找到node</span>
</span></span><span style="display:flex;"><span>    _, nodeExists <span style="color:#fe8019">:=</span> volumeObj.nodesAttachedTo[nodeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> nodeExists {<span style="color:#928374;font-style:italic">// 存在就删除记录</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fabd2f">delete</span>(asw.attachedVolumes[volumeName].nodesAttachedTo, nodeName)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">//  如果这个olume没有attach到node的信息，即都删除完了，就删除这条olume的记录</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> <span style="color:#fabd2f">len</span>(volumeObj.nodesAttachedTo) <span style="color:#fe8019">==</span> <span style="color:#d3869b">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fabd2f">delete</span>(asw.attachedVolumes, volumeName)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Remove volume from volumes to report as attached</span>
</span></span><span style="display:flex;"><span>    asw.<span style="color:#fabd2f">removeVolumeFromReportAsAttached</span>(volumeName, nodeName)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// Remove the volumeName from the node&#39;s volumesToReportAsAttached list</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// This is an internal function and caller should acquire and release the lock</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (asw <span style="color:#fe8019">*</span>actualStateOfWorld) <span style="color:#fabd2f">removeVolumeFromReportAsAttached</span>(
</span></span><span style="display:flex;"><span>    volumeName v1.UniqueVolumeName, nodeName types.NodeName) <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    nodeToUpdate, nodeToUpdateExists <span style="color:#fe8019">:=</span> asw.nodesToUpdateStatusFor[nodeName]
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> nodeToUpdateExists {
</span></span><span style="display:flex;"><span>        _, nodeToUpdateVolumeExists <span style="color:#fe8019">:=</span>
</span></span><span style="display:flex;"><span>            nodeToUpdate.volumesToReportAsAttached[volumeName]
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> nodeToUpdateVolumeExists {
</span></span><span style="display:flex;"><span>            nodeToUpdate.statusUpdateNeeded = <span style="color:#fe8019">true</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fabd2f">delete</span>(nodeToUpdate.volumesToReportAsAttached, volumeName)
</span></span><span style="display:flex;"><span>            asw.nodesToUpdateStatusFor[nodeName] = nodeToUpdate
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span> 
</span></span><span style="display:flex;"><span>        }   
</span></span><span style="display:flex;"><span>    }   
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">return</span> fmt.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;volume %q does not exist in volumesToReportAsAttached list or node %q does not exist in nodesToUpdateStatusFor list&#34;</span>,
</span></span><span style="display:flex;"><span>        volumeName,
</span></span><span style="display:flex;"><span>        nodeName)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h2 id="协调器">协调器</h2>
<p>reconciler 有如下几个字段:</p>
<ul>
<li>desiredStateOfWorld：<a href="#%E6%9C%9F%E6%9C%9B%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">期望状态管理</a></li>
<li>actualStateOfWorld：<a href="#%E5%AE%9E%E9%99%85%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">实际状态管理</a></li>
<li>attacherDetacher：在协调实际状态和期望状态时候需要进行 Attach 或者 Detach 操作。</li>
</ul>
<p>协调器 reconciler 会启动协程运行 reconciliationLoopFunc：</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (rc <span style="color:#fe8019">*</span>reconciler) <span style="color:#fabd2f">Run</span>(stopCh <span style="color:#fe8019">&lt;-</span><span style="color:#fe8019">chan</span> <span style="color:#fe8019">struct</span>{}) {
</span></span><span style="display:flex;"><span>	wait.<span style="color:#fabd2f">Until</span>(rc.<span style="color:#fabd2f">reconciliationLoopFunc</span>(), rc.loopPeriod, stopCh)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// reconciliationLoopFunc this can be disabled via cli option disableReconciliation.</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// It periodically checks whether the attached volumes from actual state</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// are still attached to the node and update the status if they are not.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (rc <span style="color:#fe8019">*</span>reconciler) <span style="color:#fabd2f">reconciliationLoopFunc</span>() <span style="color:#fe8019">func</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> <span style="color:#fe8019">func</span>() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		rc.<span style="color:#fabd2f">reconcile</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> rc.disableReconciliationSync {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Info</span>(<span style="color:#b8bb26">&#34;Skipping reconciling attached volumes still attached since it is disabled via the command line.&#34;</span>)
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> <span style="color:#fe8019">if</span> rc.syncDuration &lt; time.Second {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Info</span>(<span style="color:#b8bb26">&#34;Skipping reconciling attached volumes still attached since it is set to less than one second via the command line.&#34;</span>)
</span></span><span style="display:flex;"><span>		} <span style="color:#fe8019">else</span> <span style="color:#fe8019">if</span> time.<span style="color:#fabd2f">Since</span>(rc.timeOfLastSync) &gt; rc.syncDuration {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Info</span>(<span style="color:#b8bb26">&#34;Starting reconciling attached volumes still attached&#34;</span>)
</span></span><span style="display:flex;"><span>			rc.<span style="color:#fabd2f">sync</span>()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>从上面的代码可以看出，最终调用的是 reconcile 方法，该方法还调用了 attachDesiredVolumes 方法，二者是协调器的核心逻辑：</p>
<ul>
<li>reconcile 是从 ASW 到 DSW 靠拢，可能需要 detach 操作。</li>
<li>attachDesiredVolumes 是从 DSW 到 ASW 靠拢，可能需要 attach 操作。</li>
<li>不管是 reconcile 还是 attachDesiredVolumes 在操作之前需要判断的 attach/detach 操作是否有正在 pending 的操作，如果有，需要忽略本次操作，以及在每次操作完成后需要更新 <code>node.Status.AttachedVolumes</code> 的状态。</li>
<li>需要知道的是 attach/detach 的操作，是由 <a href="https://www.zhangzewen.net/posts/kubernetes/kubelet/csi-volume-plugin/">csi volume plugin</a> 创建/删除 VolumeAttachment 资源来间接进行 attach/detach 操作。</li>
</ul>
<p>如下是 reconcile 的代码，有详细的注释：</p>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (rc <span style="color:#fe8019">*</span>reconciler) <span style="color:#fabd2f">reconcile</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Detaches are triggered before attaches so that volumes referenced by</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// pods that are rescheduled to a different node are detached first.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Ensure volumes that should be detached are detached.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">for</span> _, attachedVolume <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> rc.actualStateOfWorld.<span style="color:#fabd2f">GetAttachedVolumes</span>() { <span style="color:#928374;font-style:italic">// 从ASW中取出已经attached的volume+node集合</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> !rc.desiredStateOfWorld.<span style="color:#fabd2f">VolumeExists</span>(
</span></span><span style="display:flex;"><span>            attachedVolume.VolumeName, attachedVolume.NodeName) { <span style="color:#8ec07c">//在DSW中不存在</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Check whether there already exist an operation pending, and don&#39;t even</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// try to start an operation if there is already one running.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// This check must be done before we do any other checks, as otherwise the other checks</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// may pass while at the same time the volume leaves the pending state, resulting in</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// double detach attempts</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// The operation key format is different depending on whether the volume</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// allows multi attach across different nodes.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 是否可以attach到多个node节点上， RWX 和ROX 是返回true的</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> util.<span style="color:#fabd2f">IsMultiAttachAllowed</span>(attachedVolume.VolumeSpec) {
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">if</span> rc.attacherDetacher.<span style="color:#fabd2f">IsOperationPending</span>(attachedVolume.VolumeName, <span style="color:#b8bb26">&#34;&#34;</span> <span style="color:#928374;font-style:italic">/* podName */</span>, attachedVolume.NodeName) {
</span></span><span style="display:flex;"><span>                    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">10</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Operation for volume %q is already running for node %q. Can&#39;t start detach&#34;</span>, attachedVolume.VolumeName, attachedVolume.NodeName)
</span></span><span style="display:flex;"><span>                    <span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">if</span> rc.attacherDetacher.<span style="color:#fabd2f">IsOperationPending</span>(attachedVolume.VolumeName, <span style="color:#b8bb26">&#34;&#34;</span> <span style="color:#928374;font-style:italic">/* podName */</span>, <span style="color:#b8bb26">&#34;&#34;</span> <span style="color:#928374;font-style:italic">/* nodeName */</span>) {
</span></span><span style="display:flex;"><span>                    klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">10</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Operation for volume %q is already running in the cluster. Can&#39;t start detach for %q&#34;</span>, attachedVolume.VolumeName, attachedVolume.NodeName)
</span></span><span style="display:flex;"><span>                    <span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Because the detach operation updates the ActualStateOfWorld before</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// marking itself complete, it&#39;s possible for the volume to be removed</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// from the ActualStateOfWorld between the GetAttachedVolumes() check</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// and the IsOperationPending() check above.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Check the ActualStateOfWorld again to avoid issuing an unnecessary</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// detach.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// See https://github.com/kubernetes/kubernetes/issues/93902</span>
</span></span><span style="display:flex;"><span>            attachState <span style="color:#fe8019">:=</span> rc.actualStateOfWorld.<span style="color:#fabd2f">GetAttachState</span>(attachedVolume.VolumeName, attachedVolume.NodeName)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> attachState <span style="color:#fe8019">==</span> cache.AttachStateDetached { <span style="color:#928374;font-style:italic">// 在ASW中的记录显示 volume和node已经Detached了，忽略后续动作</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">if</span> klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Enabled</span>() {
</span></span><span style="display:flex;"><span>                    klog.<span style="color:#fabd2f">Infof</span>(attachedVolume.<span style="color:#fabd2f">GenerateMsgDetailed</span>(<span style="color:#b8bb26">&#34;Volume detached--skipping&#34;</span>, <span style="color:#b8bb26">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Set the detach request time</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 更新ASW 中detach的时间，注意这个函数返回的时间是上一次(如果有)detach操作到现在的时间，如果本次是首次进行detach，则elapsedTime是0</span>
</span></span><span style="display:flex;"><span>            elapsedTime, err <span style="color:#fe8019">:=</span> rc.actualStateOfWorld.<span style="color:#fabd2f">SetDetachRequestTime</span>(attachedVolume.VolumeName, attachedVolume.NodeName)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>                klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Cannot trigger detach because it fails to set detach request time with error %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Check whether timeout has reached the maximum waiting time</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// rc.maxWaitForUnmountDuration  取的是 k8s.io/kubernetes/cmd/kube-controller-manager/app/core.go#ReconcilerMaxWaitForUnmountDuration， 这个值是6min</span>
</span></span><span style="display:flex;"><span>            timeout <span style="color:#fe8019">:=</span> elapsedTime &gt; rc.maxWaitForUnmountDuration
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Check whether volume is still mounted. Skip detach if it is still mounted unless timeout</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 如果volume还在mount状态，就忽略后续动作，否则，校验是否上次detach动作到现在已经timeout了，如果还没有，也忽略</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> attachedVolume.MountedByNode <span style="color:#fe8019">&amp;&amp;</span> !timeout {
</span></span><span style="display:flex;"><span>                klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(attachedVolume.<span style="color:#fabd2f">GenerateMsgDetailed</span>(<span style="color:#b8bb26">&#34;Cannot detach volume because it is still mounted&#34;</span>, <span style="color:#b8bb26">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Before triggering volume detach, mark volume as detached and update the node status</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// If it fails to update node status, skip detach volume</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 移除ASW中 volume + node的attached记录</span>
</span></span><span style="display:flex;"><span>            err = rc.actualStateOfWorld.<span style="color:#fabd2f">RemoveVolumeFromReportAsAttached</span>(attachedVolume.VolumeName, attachedVolume.NodeName)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>                klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;RemoveVolumeFromReportAsAttached failed while removing volume %q from node %q with: %v&#34;</span>,
</span></span><span style="display:flex;"><span>                    attachedVolume.VolumeName,
</span></span><span style="display:flex;"><span>                    attachedVolume.NodeName,
</span></span><span style="display:flex;"><span>                    err)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Update Node Status to indicate volume is no longer safe to mount.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 通过patch操作来更新node.status.attachedVolumes</span>
</span></span><span style="display:flex;"><span>            err = rc.nodeStatusUpdater.<span style="color:#fabd2f">UpdateNodeStatuses</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// Skip detaching this volume if unable to update node status</span>
</span></span><span style="display:flex;"><span>                klog.<span style="color:#fabd2f">Errorf</span>(attachedVolume.<span style="color:#fabd2f">GenerateErrorDetailed</span>(<span style="color:#b8bb26">&#34;UpdateNodeStatuses failed while attempting to report volume as attached&#34;</span>, err).<span style="color:#fabd2f">Error</span>())
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Trigger detach volume which requires verifying safe to detach step</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// If timeout is true, skip verifySafeToDetach check</span>
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(attachedVolume.<span style="color:#fabd2f">GenerateMsgDetailed</span>(<span style="color:#b8bb26">&#34;Starting attacherDetacher.DetachVolume&#34;</span>, <span style="color:#b8bb26">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>            verifySafeToDetach <span style="color:#fe8019">:=</span> !timeout
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 执行detach操作</span>
</span></span><span style="display:flex;"><span>            err = rc.attacherDetacher.<span style="color:#fabd2f">DetachVolume</span>(attachedVolume.AttachedVolume, verifySafeToDetach, rc.actualStateOfWorld)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> err <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">if</span> !timeout {
</span></span><span style="display:flex;"><span>                    klog.<span style="color:#fabd2f">Infof</span>(attachedVolume.<span style="color:#fabd2f">GenerateMsgDetailed</span>(<span style="color:#b8bb26">&#34;attacherDetacher.DetachVolume started&#34;</span>, <span style="color:#b8bb26">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>                } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>                    metrics.<span style="color:#fabd2f">RecordForcedDetachMetric</span>()
</span></span><span style="display:flex;"><span>                    klog.<span style="color:#fabd2f">Warningf</span>(attachedVolume.<span style="color:#fabd2f">GenerateMsgDetailed</span>(<span style="color:#b8bb26">&#34;attacherDetacher.DetachVolume started&#34;</span>, fmt.<span style="color:#fabd2f">Sprintf</span>(<span style="color:#b8bb26">&#34;This volume is not safe to detach, but maxWaitForUnmountDuration %v expired, force detaching&#34;</span>, rc.maxWaitForUnmountDuration)))
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">&amp;&amp;</span> !exponentialbackoff.<span style="color:#fabd2f">IsExponentialBackoff</span>(err) {
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// Ignore exponentialbackoff.IsExponentialBackoff errors, they are expected.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#928374;font-style:italic">// Log all other errors.</span>
</span></span><span style="display:flex;"><span>                klog.<span style="color:#fabd2f">Errorf</span>(attachedVolume.<span style="color:#fabd2f">GenerateErrorDetailed</span>(<span style="color:#b8bb26">&#34;attacherDetacher.DetachVolume failed to start&#34;</span>, err).<span style="color:#fabd2f">Error</span>())
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 通过DSW来对比ASW，来进行attach操作，让ASW靠近DSW</span>
</span></span><span style="display:flex;"><span>    rc.<span style="color:#fabd2f">attachDesiredVolumes</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Update Node Status</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 通过patch操作来更新node.status.AttachedVolumes</span>
</span></span><span style="display:flex;"><span>    err <span style="color:#fe8019">:=</span> rc.nodeStatusUpdater.<span style="color:#fabd2f">UpdateNodeStatuses</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">Warningf</span>(<span style="color:#b8bb26">&#34;UpdateNodeStatuses failed with: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (rc <span style="color:#fe8019">*</span>reconciler) <span style="color:#fabd2f">attachDesiredVolumes</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// Ensure volumes that should be attached are attached.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">for</span> _, volumeToAttach <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> rc.desiredStateOfWorld.<span style="color:#fabd2f">GetVolumesToAttach</span>() { <span style="color:#928374;font-style:italic">// 获取需要进行attach的volume + node信息</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 是否可以attach到多个node节点上， RWX 和ROX 是返回true的</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 这里是判断如果有上一个attach操作正在进行的化，就忽略这次的操作</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> util.<span style="color:#fabd2f">IsMultiAttachAllowed</span>(volumeToAttach.VolumeSpec) {
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Don&#39;t even try to start an operation if there is already one running for the given volume and node.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> rc.attacherDetacher.<span style="color:#fabd2f">IsOperationPending</span>(volumeToAttach.VolumeName, <span style="color:#b8bb26">&#34;&#34;</span> <span style="color:#928374;font-style:italic">/* podName */</span>, volumeToAttach.NodeName) {
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">if</span> klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">10</span>).<span style="color:#fabd2f">Enabled</span>() {
</span></span><span style="display:flex;"><span>                    klog.<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Operation for volume %q is already running for node %q. Can&#39;t start attach&#34;</span>, volumeToAttach.VolumeName, volumeToAttach.NodeName)
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#fe8019">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Don&#39;t even try to start an operation if there is already one running for the given volume</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> rc.attacherDetacher.<span style="color:#fabd2f">IsOperationPending</span>(volumeToAttach.VolumeName, <span style="color:#b8bb26">&#34;&#34;</span> <span style="color:#928374;font-style:italic">/* podName */</span>, <span style="color:#b8bb26">&#34;&#34;</span> <span style="color:#928374;font-style:italic">/* nodeName */</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">if</span> klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">10</span>).<span style="color:#fabd2f">Enabled</span>() {
</span></span><span style="display:flex;"><span>                    klog.<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Operation for volume %q is already running. Can&#39;t start attach for %q&#34;</span>, volumeToAttach.VolumeName, volumeToAttach.NodeName)
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Because the attach operation updates the ActualStateOfWorld before</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// marking itself complete, IsOperationPending() must be checked before</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// GetAttachState() to guarantee the ActualStateOfWorld is</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// up-to-date when it&#39;s read.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// See https://github.com/kubernetes/kubernetes/issues/93902</span>
</span></span><span style="display:flex;"><span>        attachState <span style="color:#fe8019">:=</span> rc.actualStateOfWorld.<span style="color:#fabd2f">GetAttachState</span>(volumeToAttach.VolumeName, volumeToAttach.NodeName)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> attachState <span style="color:#fe8019">==</span> cache.AttachStateAttached { <span style="color:#8ec07c">//如果 在ASW中的记录 volume + node已经是attached状态了，重置下detach事件(清零操作),然后忽略后续操作</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Volume/Node exists, touch it to reset detachRequestedTime</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Enabled</span>() {
</span></span><span style="display:flex;"><span>                klog.<span style="color:#fabd2f">Infof</span>(volumeToAttach.<span style="color:#fabd2f">GenerateMsgDetailed</span>(<span style="color:#b8bb26">&#34;Volume attached--touching&#34;</span>, <span style="color:#b8bb26">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            rc.actualStateOfWorld.<span style="color:#fabd2f">ResetDetachRequestTime</span>(volumeToAttach.VolumeName, volumeToAttach.NodeName)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 是否可以attach到多个node节点上， RWX 和ROX 是返回true的</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> !util.<span style="color:#fabd2f">IsMultiAttachAllowed</span>(volumeToAttach.VolumeSpec) { <span style="color:#928374;font-style:italic">// 不支持</span>
</span></span><span style="display:flex;"><span>            nodes <span style="color:#fe8019">:=</span> rc.actualStateOfWorld.<span style="color:#fabd2f">GetNodesForAttachedVolume</span>(volumeToAttach.VolumeName)
</span></span><span style="display:flex;"><span>            <span style="color:#fe8019">if</span> <span style="color:#fabd2f">len</span>(nodes) &gt; <span style="color:#d3869b">0</span> { <span style="color:#928374;font-style:italic">// 但是从ASW中以及存在 node + volume 已经attached的记录，这就冲突了，直接忽略后续操作</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">if</span> !volumeToAttach.MultiAttachErrorReported {
</span></span><span style="display:flex;"><span>                    rc.<span style="color:#fabd2f">reportMultiAttachError</span>(volumeToAttach, nodes)
</span></span><span style="display:flex;"><span>                    rc.desiredStateOfWorld.<span style="color:#fabd2f">SetMultiAttachError</span>(volumeToAttach.VolumeName, volumeToAttach.NodeName)
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Volume/Node doesn&#39;t exist, spawn a goroutine to attach it</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Enabled</span>() {
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">Infof</span>(volumeToAttach.<span style="color:#fabd2f">GenerateMsgDetailed</span>(<span style="color:#b8bb26">&#34;Starting attacherDetacher.AttachVolume&#34;</span>, <span style="color:#b8bb26">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 执行attach操作</span>
</span></span><span style="display:flex;"><span>        err <span style="color:#fe8019">:=</span> rc.attacherDetacher.<span style="color:#fabd2f">AttachVolume</span>(volumeToAttach.VolumeToAttach, rc.actualStateOfWorld)
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> err <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">Infof</span>(volumeToAttach.<span style="color:#fabd2f">GenerateMsgDetailed</span>(<span style="color:#b8bb26">&#34;attacherDetacher.AttachVolume started&#34;</span>, <span style="color:#b8bb26">&#34;&#34;</span>))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">&amp;&amp;</span> !exponentialbackoff.<span style="color:#fabd2f">IsExponentialBackoff</span>(err) {
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Ignore exponentialbackoff.IsExponentialBackoff errors, they are expected.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// Log all other errors.</span>
</span></span><span style="display:flex;"><span>            klog.<span style="color:#fabd2f">Errorf</span>(volumeToAttach.<span style="color:#fabd2f">GenerateErrorDetailed</span>(<span style="color:#b8bb26">&#34;attacherDetacher.AttachVolume failed to start&#34;</span>, err).<span style="color:#fabd2f">Error</span>())
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h2 id="attachdetach-controller">AttachDetach Controller</h2>
<p>在完成<a href="#%E6%9C%9B%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">望状态管理</a>、<a href="#%E5%AE%9E%E9%99%85%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">实际状态管理</a>和<a href="#%E5%8D%8F%E8%B0%83%E5%99%A8">协调器</a> 的研究后，AttachDetach Controller 的实现逻辑就变的很清晰明了了。</p>
<p>结构体 attachDetachController 实现了接口 AttachDetachController：</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">type</span> AttachDetachController <span style="color:#fe8019">interface</span> {                                                                                                       
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// AttacheDetach Controller  运行起来</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fabd2f">Run</span>(stopCh <span style="color:#fe8019">&lt;-</span><span style="color:#fe8019">chan</span> <span style="color:#fe8019">struct</span>{})                                                                                            
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 返回期望的状态。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fabd2f">GetDesiredStateOfWorld</span>() cache.DesiredStateOfWorld                  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>结构体 attachDetachController 字段繁多，但很多字段都和 List-Watch 相关资源有关，如：PVC，CSINode，Node，PV，AttachDetachment，Pod。以及<a href="#%E5%AE%9E%E9%99%85%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">实际状态</a>，<a href="#%E6%9C%9F%E6%9C%9B%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">期望状态</a> 和二者的<a href="#%E5%8D%8F%E8%B0%83%E5%99%A8">协调器</a>，如下代码是创建 attachDetachController 实例：</p>
<p>通过方法 NewAttachDetachController 来创建 attachDetachController 时，List-Watch 相关的字段都是通过参数传递进去的，毕竟是 kubernetes 众多控制器中的一个，需要状态一致。 attachDetachController 还实现了接口 VolumeHost，也就是简单的实现(方法没有实现函数逻辑，简单的返回)。</p>
<h3 id="启动">启动</h3>
<p>attachDetachController 通过调用 Run 启动：</p>
<ul>
<li>设置了在程序退出时候的函数调用链，优雅退出</li>
<li>例行同步缓存，缓存的资源有Pod，Node，PVC，PV，CSINode，CSiDriver，VolumeAttachment。</li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%9E%E9%99%85%E7%8A%B6%E6%80%81">遍历Node，生成此时实际状态。</a></li>
<li><a href="#%E6%9C%9F%E6%9C%9B%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">遍历Pod，根据 Pod 以及 spec 得到期望状态</a></li>
<li><a href="#%E5%8D%8F%E8%B0%83%E5%99%A8">后台周期性协调实际检测的状态和期望的状态</a></li>
<li>启动协程在后台周期性的更新 DSW，这个是根据 pod 的添加和删除以及 pod 的状态为依据来更新的，具体逻辑可以看
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>k8s.io/kubernetes/pkg/controller/volume/attachdetach/populator/desired_state_of_world_populator.go
</span></span></code></pre></div>代码实现很简单，这里不再过多赘述。</li>
<li>协程 pvcWorker 同步PVC，根据PVC和Pod的关系决定是否需要处理。</li>
</ul>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">Run</span>(stopCh <span style="color:#fe8019">&lt;-</span><span style="color:#fe8019">chan</span> <span style="color:#fe8019">struct</span>{}) {
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">defer</span> runtime.<span style="color:#fabd2f">HandleCrash</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">defer</span> adc.pvcQueue.<span style="color:#fabd2f">ShutDown</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#928374;font-style:italic">// Start events processing pipeline.</span>
</span></span><span style="display:flex;"><span>	adc.broadcaster.<span style="color:#fabd2f">StartStructuredLogging</span>(<span style="color:#d3869b">0</span>)
</span></span><span style="display:flex;"><span>	adc.broadcaster.<span style="color:#fabd2f">StartRecordingToSink</span>(<span style="color:#fe8019">&amp;</span>v1core.EventSinkImpl{Interface: adc.kubeClient.<span style="color:#fabd2f">CoreV1</span>().<span style="color:#fabd2f">Events</span>(<span style="color:#b8bb26">&#34;&#34;</span>)})
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">defer</span> adc.broadcaster.<span style="color:#fabd2f">Shutdown</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	klog.<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Starting attach detach controller&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">defer</span> klog.<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Shutting down attach detach controller&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 各种资源缓存的同步 </span>
</span></span><span style="display:flex;"><span>	synced <span style="color:#fe8019">:=</span> []kcache.InformerSynced{adc.podsSynced, adc.nodesSynced, adc.pvcsSynced, adc.pvsSynced}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> adc.csiNodeSynced <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		synced = <span style="color:#fabd2f">append</span>(synced, adc.csiNodeSynced)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> adc.csiDriversSynced <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		synced = <span style="color:#fabd2f">append</span>(synced, adc.csiDriversSynced)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> adc.volumeAttachmentSynced <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		synced = <span style="color:#fabd2f">append</span>(synced, adc.volumeAttachmentSynced)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> !kcache.<span style="color:#fabd2f">WaitForNamedCacheSync</span>(<span style="color:#b8bb26">&#34;attach detach&#34;</span>, stopCh, synced<span style="color:#fe8019">...</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 初始化实际状态Cache</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#fe8019">:=</span> adc.<span style="color:#fabd2f">populateActualStateOfWorld</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Error populating the actual state of world: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 初始化期望状态cache</span>
</span></span><span style="display:flex;"><span>	err = adc.<span style="color:#fabd2f">populateDesiredStateOfWorld</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Error populating the desired state of world: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 拉起来一个goroutine来运行协调器</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">go</span> adc.reconciler.<span style="color:#fabd2f">Run</span>(stopCh)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 周期性更新DSW</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">go</span> adc.desiredStateOfWorldPopulator.<span style="color:#fabd2f">Run</span>(stopCh)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 周期性运行pvcWorker</span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">go</span> wait.<span style="color:#fabd2f">Until</span>(adc.pvcWorker, time.Second, stopCh)
</span></span><span style="display:flex;"><span>	metrics.<span style="color:#fabd2f">Register</span>(adc.pvcLister,
</span></span><span style="display:flex;"><span>		adc.pvLister,
</span></span><span style="display:flex;"><span>		adc.podLister,
</span></span><span style="display:flex;"><span>		adc.actualStateOfWorld,
</span></span><span style="display:flex;"><span>		adc.desiredStateOfWorld,
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">&amp;</span>adc.volumePluginMgr,
</span></span><span style="display:flex;"><span>		adc.csiMigratedPluginManager,
</span></span><span style="display:flex;"><span>		adc.intreeToCSITranslator)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">&lt;-</span>stopCh
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<h3 id="初始化实际状态">初始化实际状态</h3>
<p>populateActualStateOfWorld 主要是初始化了ASW的各种数据状态：</p>
<ul>
<li>拉取所有的Node资源信息</li>
<li>把 <code>node.Status.VolumesAttached</code>信息更新到 AWS 中， 这里的 <code>node.Status.VolumeAttached</code>是该 node 上已经 attached 的 volume 信息，详细可看实际状态管理中 <a href="#AddVolumeNode">AddVolumeNode</a> 的实现。</li>
<li>根据 <code>node.Status.VolumesInUse</code> 来更新 ASW，主要是设置 `nodeAttachedTo.mountedByNode的值为 ture 或者false，详细看下面 processVolumesInUse 的分析。</li>
<li>根据集群中的 VolumeAttachment 资源来更新ASW，详细看下面 processVolumeAttachments 的分析。</li>
</ul>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">populateActualStateOfWorld</span>() <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>	klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Populating ActualStateOfworld&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 拉取所有的Node资源信息</span>
</span></span><span style="display:flex;"><span>	nodes, err <span style="color:#fe8019">:=</span> adc.nodeLister.<span style="color:#fabd2f">List</span>(labels.<span style="color:#fabd2f">Everything</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">for</span> _, node <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> nodes {
</span></span><span style="display:flex;"><span>		nodeName <span style="color:#fe8019">:=</span> types.<span style="color:#fabd2f">NodeName</span>(node.Name)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">for</span> _, attachedVolume <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> node.Status.VolumesAttached {
</span></span><span style="display:flex;"><span>			uniqueName <span style="color:#fe8019">:=</span> attachedVolume.Name
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// The nil VolumeSpec is safe only in the case the volume is not in use by any pod.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// In such a case it should be detached in the first reconciliation cycle and the</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// volume spec is not needed to detach a volume. If the volume is used by a pod, it</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// its spec can be: this would happen during in the populateDesiredStateOfWorld which</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// scans the pods and updates their volumes in the ActualStateOfWorld too.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 把node.Status.VolumesAttached信息更新到AWS中， 这里的node.Status.VolumeAttached是该node上已经attached的volume信息</span>
</span></span><span style="display:flex;"><span>			err = adc.actualStateOfWorld.<span style="color:#fabd2f">MarkVolumeAsAttached</span>(uniqueName, <span style="color:#fe8019">nil</span> <span style="color:#928374;font-style:italic">/* VolumeSpec */</span>, nodeName, attachedVolume.DevicePath)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Failed to mark the volume as attached: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 根据node.Status.VolumesInUse来更新ASW, 这里的node.Status.VolumesInUse是表示已经attached的volume中已经被mounted的volume集合</span>
</span></span><span style="display:flex;"><span>			adc.<span style="color:#fabd2f">processVolumesInUse</span>(nodeName, node.Status.VolumesInUse)
</span></span><span style="display:flex;"><span>			adc.<span style="color:#fabd2f">addNodeToDswp</span>(node, types.<span style="color:#fabd2f">NodeName</span>(node.Name))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	err = adc.<span style="color:#fabd2f">processVolumeAttachments</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Failed to process volume attachments: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<p>processVolumesInUse 根据 <code>node.Status.VolumesInUse</code> 来更新 ASW, 这里的 <code>node.Status.VolumesInUse</code> 是表示已经 attached 的 volume 中已经被 mounted 的 volume 集合，顺着代码跟踪过去的话，其实就是更新。</p>
<p>volume 和 node在attached之后的是否mount的信息, 可以看 <code>actualStateOfWorld.SetVolumeMountedByNode</code> 的实现，其实现很简单，这里就不再过多赘述。</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// processVolumesInUse processes the list of volumes marked as &#34;in-use&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// according to the specified Node&#39;s Status.VolumesInUse and updates the</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// corresponding volume in the actual state of the world to indicate that it is</span>
</span></span><span style="display:flex;"><span><span style="color:#928374;font-style:italic">// mounted.</span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">processVolumesInUse</span>(
</span></span><span style="display:flex;"><span>	nodeName types.NodeName, volumesInUse []v1.UniqueVolumeName) {
</span></span><span style="display:flex;"><span>	klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">4</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;processVolumesInUse for node %q&#34;</span>, nodeName)
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">for</span> _, attachedVolume <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> adc.actualStateOfWorld.<span style="color:#fabd2f">GetAttachedVolumesForNode</span>(nodeName) {
</span></span><span style="display:flex;"><span>		mounted <span style="color:#fe8019">:=</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">for</span> _, volumeInUse <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> volumesInUse {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> attachedVolume.VolumeName <span style="color:#fe8019">==</span> volumeInUse {
</span></span><span style="display:flex;"><span>				mounted = <span style="color:#fe8019">true</span>
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">break</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		err <span style="color:#fe8019">:=</span> adc.actualStateOfWorld.<span style="color:#fabd2f">SetVolumeMountedByNode</span>(attachedVolume.VolumeName, nodeName, mounted)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Warningf</span>(
</span></span><span style="display:flex;"><span>				<span style="color:#b8bb26">&#34;SetVolumeMountedByNode(%q, %q, %v) returned an error: %v&#34;</span>,
</span></span><span style="display:flex;"><span>				attachedVolume.VolumeName, nodeName, mounted, err)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>addNodeToDswp 的流程如下：</p>
<ul>
<li>
<p>检查 Node 资源的注释项 <code>volumes.kubernetes.io/controller-managed-attach-detach</code> 是否存在，现在都是由AD Controller来控制 Attach/Detach，即都是存在的，且值是ture。</p>
</li>
<li>
<p>然后检查 Node 资源的注释项 <code>volumes.kubernetes.io/keep-terminated-pod-volumes</code>是否存在且其值是否是true，当 pod terminated 保留其 volume 的 mount，这个看源码后续是要废弃了，可以看<a href="https://github.com/kubernetes/kubernetes/issues/45191">issues#45191</a>。</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜  kubernetes.codedump git:<span style="color:#fe8019">(</span>5e58841cce7<span style="color:#fe8019">)</span> ✗ ag keep-terminated-pod-volumes   
</span></span><span style="display:flex;"><span>cmd/kubelet/app/options/options.go
</span></span><span style="display:flex;"><span>366:	fs.BoolVar<span style="color:#fe8019">(</span>&amp;f.KeepTerminatedPodVolumes, <span style="color:#b8bb26">&#34;keep-terminated-pod-volumes&#34;</span>, f.KeepTerminatedPodVolumes, <span style="color:#b8bb26">&#34;Keep terminated pod volumes mounted to the node after the pod terminates.  Can be useful for debugging volume related issues.&#34;</span><span style="color:#fe8019">)</span>
</span></span><span style="display:flex;"><span>367:	fs.MarkDeprecated<span style="color:#fe8019">(</span><span style="color:#b8bb26">&#34;keep-terminated-pod-volumes&#34;</span>, <span style="color:#b8bb26">&#34;will be removed in a future version&#34;</span><span style="color:#fe8019">)</span>
</span></span></code></pre></div></li>
<li>
<p>调用 DSW 的 AddNode 方法添加Node记录，详细请看<a href="#%E6%B7%BB%E5%8A%A0Node">添加Node</a>。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">addNodeToDswp</span>(node <span style="color:#fe8019">*</span>v1.Node, nodeName types.NodeName) {
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> _, exists <span style="color:#fe8019">:=</span> node.Annotations[volumeutil.ControllerManagedAttachAnnotation]; exists {
</span></span><span style="display:flex;"><span>		keepTerminatedPodVolumes <span style="color:#fe8019">:=</span> <span style="color:#fe8019">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> t, ok <span style="color:#fe8019">:=</span> node.Annotations[volumeutil.KeepTerminatedPodVolumesAnnotation]; ok {
</span></span><span style="display:flex;"><span>			keepTerminatedPodVolumes = (t <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;true&#34;</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// Node specifies annotation indicating it should be managed by attach</span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// detach controller. Add it to desired state of world.</span>
</span></span><span style="display:flex;"><span>		adc.desiredStateOfWorld.<span style="color:#fabd2f">AddNode</span>(nodeName, keepTerminatedPodVolumes)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>processVolumeAttachments 根据集群中的 VolumeAttachment 资源来更新 ASW：</p>
<ul>
<li>从集群中获取所有的VolumeAttachment资源。</li>
<li><a href="#AddVolumeNode">获取目前node和volume之间的attached状态，并更新ASW</a>。</li>
</ul>
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">processVolumeAttachments</span>() <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// 从集群中获取所有的VolumeAttachment资源</span>
</span></span><span style="display:flex;"><span>	vas, err <span style="color:#fe8019">:=</span> adc.volumeAttachmentLister.<span style="color:#fabd2f">List</span>(labels.<span style="color:#fabd2f">Everything</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;failed to list VolumeAttachment objects: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">for</span> _, va <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> vas {
</span></span><span style="display:flex;"><span>		nodeName <span style="color:#fe8019">:=</span> types.<span style="color:#fabd2f">NodeName</span>(va.Spec.NodeName)
</span></span><span style="display:flex;"><span>		pvName <span style="color:#fe8019">:=</span> va.Spec.Source.PersistentVolumeName
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> pvName <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// Currently VA objects are created for CSI volumes only. nil pvName is unexpected, generate a warning</span>
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Warningf</span>(<span style="color:#b8bb26">&#34;Skipping the va as its pvName is nil, va.Name: %q, nodeName: %q&#34;</span>,
</span></span><span style="display:flex;"><span>				va.Name, nodeName)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>        <span style="color:#8ec07c">//获取对应的pv资源</span>
</span></span><span style="display:flex;"><span>		pv, err <span style="color:#fe8019">:=</span> adc.pvLister.<span style="color:#fabd2f">Get</span>(<span style="color:#fe8019">*</span>pvName)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Unable to lookup pv object for: %q, err: %v&#34;</span>, <span style="color:#fe8019">*</span>pvName, err)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">var</span> plugin volume.AttachableVolumePlugin
</span></span><span style="display:flex;"><span>		volumeSpec <span style="color:#fe8019">:=</span> volume.<span style="color:#fabd2f">NewSpecFromPersistentVolume</span>(pv, <span style="color:#fe8019">false</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 找到合适的volume plugin</span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// Consult csiMigratedPluginManager first before querying the plugins registered during runtime in volumePluginMgr.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// In-tree plugins that provisioned PVs will not be registered anymore after migration to CSI, once the respective</span>
</span></span><span style="display:flex;"><span>		<span style="color:#928374;font-style:italic">// feature gate is enabled.</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> inTreePluginName, err <span style="color:#fe8019">:=</span> adc.csiMigratedPluginManager.<span style="color:#fabd2f">GetInTreePluginNameFromSpec</span>(pv, <span style="color:#fe8019">nil</span>); err <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> adc.csiMigratedPluginManager.<span style="color:#fabd2f">IsMigrationEnabledForPlugin</span>(inTreePluginName) {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// PV is migrated and should be handled by the CSI plugin instead of the in-tree one</span>
</span></span><span style="display:flex;"><span>				plugin, _ = adc.volumePluginMgr.<span style="color:#fabd2f">FindAttachablePluginByName</span>(csi.CSIPluginName)
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// podNamespace is not needed here for Azurefile as the volumeName generated will be the same with or without podNamespace</span>
</span></span><span style="display:flex;"><span>				volumeSpec, err = csimigration.<span style="color:#fabd2f">TranslateInTreeSpecToCSI</span>(volumeSpec, <span style="color:#b8bb26">&#34;&#34;</span> <span style="color:#928374;font-style:italic">/* podNamespace */</span>, adc.intreeToCSITranslator)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>					klog.<span style="color:#fabd2f">Errorf</span>(
</span></span><span style="display:flex;"><span>						<span style="color:#b8bb26">&#34;Failed to translate intree volumeSpec to CSI volumeSpec for volume:%q, va.Name:%q, nodeName:%q: %s. Error: %v&#34;</span>,
</span></span><span style="display:flex;"><span>						<span style="color:#fe8019">*</span>pvName,
</span></span><span style="display:flex;"><span>						va.Name,
</span></span><span style="display:flex;"><span>						nodeName,
</span></span><span style="display:flex;"><span>						inTreePluginName,
</span></span><span style="display:flex;"><span>						err)
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> plugin <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			plugin, err = adc.volumePluginMgr.<span style="color:#fabd2f">FindAttachablePluginBySpec</span>(volumeSpec)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">||</span> plugin <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#928374;font-style:italic">// Currently VA objects are created for CSI volumes only. nil plugin is unexpected, generate a warning</span>
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">Warningf</span>(
</span></span><span style="display:flex;"><span>					<span style="color:#b8bb26">&#34;Skipping processing the volume %q on nodeName: %q, no attacher interface found. err=%v&#34;</span>,
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">*</span>pvName,
</span></span><span style="display:flex;"><span>					nodeName,
</span></span><span style="display:flex;"><span>					err)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// volumeName ==&gt; &lt;pluginName&gt;/&lt;volumeName&gt;</span>
</span></span><span style="display:flex;"><span>		volumeName, err <span style="color:#fe8019">:=</span> volumeutil.<span style="color:#fabd2f">GetUniqueVolumeNameFromSpec</span>(plugin, volumeSpec)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">Errorf</span>(
</span></span><span style="display:flex;"><span>				<span style="color:#b8bb26">&#34;Failed to find unique name for volume:%q, va.Name:%q, nodeName:%q: %v&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">*</span>pvName,
</span></span><span style="display:flex;"><span>				va.Name,
</span></span><span style="display:flex;"><span>				nodeName,
</span></span><span style="display:flex;"><span>				err)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 获取目前node和volume之间的关系</span>
</span></span><span style="display:flex;"><span>		attachState <span style="color:#fe8019">:=</span> adc.actualStateOfWorld.<span style="color:#fabd2f">GetAttachState</span>(volumeName, nodeName)
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// 当前状态为detached</span>
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">if</span> attachState <span style="color:#fe8019">==</span> cache.AttachStateDetached {
</span></span><span style="display:flex;"><span>			klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">1</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Marking volume attachment as uncertain as volume:%q (%q) is not attached (%v)&#34;</span>,
</span></span><span style="display:flex;"><span>				volumeName, nodeName, attachState)
</span></span><span style="display:flex;"><span>            <span style="color:#928374;font-style:italic">// 添加volume 和node的attach状态的记录</span>
</span></span><span style="display:flex;"><span>			err = adc.actualStateOfWorld.<span style="color:#fabd2f">MarkVolumeAsUncertain</span>(volumeName, volumeSpec, nodeName)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;MarkVolumeAsUncertain fail to add the volume %q (%q) to ASW. err: %s&#34;</span>, volumeName, nodeName, err)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>

<p>populateDesiredStateOfWorld 调用[desiredStateOfWorld.AddPod](#添加 POD)向DSW中添加记录以及一些其他的记录，也可能会修改ASW的记录信息，这里不再过多赘述，好多函数在本片文章的中都注解了。
<details>
    <summary>CLICK ME</summary>
    <div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">populateDesiredStateOfWorld</span>() <span style="color:#fabd2f">error</span> {
</span></span><span style="display:flex;"><span>	klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">5</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Populating DesiredStateOfworld&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	pods, err <span style="color:#fe8019">:=</span> adc.podLister.<span style="color:#fabd2f">List</span>(labels.<span style="color:#fabd2f">Everything</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">return</span> err
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">for</span> _, pod <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> pods {
</span></span><span style="display:flex;"><span>		podToAdd <span style="color:#fe8019">:=</span> pod
</span></span><span style="display:flex;"><span>		adc.<span style="color:#fabd2f">podAdd</span>(podToAdd)
</span></span><span style="display:flex;"><span>		<span style="color:#fe8019">for</span> _, podVolume <span style="color:#fe8019">:=</span> <span style="color:#fe8019">range</span> podToAdd.Spec.Volumes {
</span></span><span style="display:flex;"><span>			nodeName <span style="color:#fe8019">:=</span> types.<span style="color:#fabd2f">NodeName</span>(podToAdd.Spec.NodeName)
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// The volume specs present in the ActualStateOfWorld are nil, let&#39;s replace those</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// with the correct ones found on pods. The present in the ASW with no corresponding</span>
</span></span><span style="display:flex;"><span>			<span style="color:#928374;font-style:italic">// pod will be detached and the spec is irrelevant.</span>
</span></span><span style="display:flex;"><span>			volumeSpec, err <span style="color:#fe8019">:=</span> util.<span style="color:#fabd2f">CreateVolumeSpec</span>(podVolume, podToAdd, nodeName, <span style="color:#fe8019">&amp;</span>adc.volumePluginMgr, adc.pvcLister, adc.pvLister, adc.csiMigratedPluginManager, adc.intreeToCSITranslator)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">Errorf</span>(
</span></span><span style="display:flex;"><span>					<span style="color:#b8bb26">&#34;Error creating spec for volume %q, pod %q/%q: %v&#34;</span>,
</span></span><span style="display:flex;"><span>					podVolume.Name,
</span></span><span style="display:flex;"><span>					podToAdd.Namespace,
</span></span><span style="display:flex;"><span>					podToAdd.Name,
</span></span><span style="display:flex;"><span>					err)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			plugin, err <span style="color:#fe8019">:=</span> adc.volumePluginMgr.<span style="color:#fabd2f">FindAttachablePluginBySpec</span>(volumeSpec)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">||</span> plugin <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">10</span>).<span style="color:#fabd2f">Infof</span>(
</span></span><span style="display:flex;"><span>					<span style="color:#b8bb26">&#34;Skipping volume %q for pod %q/%q: it does not implement attacher interface. err=%v&#34;</span>,
</span></span><span style="display:flex;"><span>					podVolume.Name,
</span></span><span style="display:flex;"><span>					podToAdd.Namespace,
</span></span><span style="display:flex;"><span>					podToAdd.Name,
</span></span><span style="display:flex;"><span>					err)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			volumeName, err <span style="color:#fe8019">:=</span> volumeutil.<span style="color:#fabd2f">GetUniqueVolumeNameFromSpec</span>(plugin, volumeSpec)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">Errorf</span>(
</span></span><span style="display:flex;"><span>					<span style="color:#b8bb26">&#34;Failed to find unique name for volume %q, pod %q/%q: %v&#34;</span>,
</span></span><span style="display:flex;"><span>					podVolume.Name,
</span></span><span style="display:flex;"><span>					podToAdd.Namespace,
</span></span><span style="display:flex;"><span>					podToAdd.Name,
</span></span><span style="display:flex;"><span>					err)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			attachState <span style="color:#fe8019">:=</span> adc.actualStateOfWorld.<span style="color:#fabd2f">GetAttachState</span>(volumeName, nodeName)
</span></span><span style="display:flex;"><span>			<span style="color:#fe8019">if</span> attachState <span style="color:#fe8019">==</span> cache.AttachStateAttached {
</span></span><span style="display:flex;"><span>				klog.<span style="color:#fabd2f">V</span>(<span style="color:#d3869b">10</span>).<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;Volume %q is attached to node %q. Marking as attached in ActualStateOfWorld&#34;</span>,
</span></span><span style="display:flex;"><span>					volumeName,
</span></span><span style="display:flex;"><span>					nodeName,
</span></span><span style="display:flex;"><span>				)
</span></span><span style="display:flex;"><span>				devicePath, err <span style="color:#fe8019">:=</span> adc.<span style="color:#fabd2f">getNodeVolumeDevicePath</span>(volumeName, nodeName)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>					klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Failed to find device path: %v&#34;</span>, err)
</span></span><span style="display:flex;"><span>					<span style="color:#fe8019">continue</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				err = adc.actualStateOfWorld.<span style="color:#fabd2f">MarkVolumeAsAttached</span>(volumeName, volumeSpec, nodeName, devicePath)
</span></span><span style="display:flex;"><span>				<span style="color:#fe8019">if</span> err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>					klog.<span style="color:#fabd2f">Errorf</span>(<span style="color:#b8bb26">&#34;Failed to update volume spec for node %s: %v&#34;</span>, nodeName, err)
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fe8019">return</span> <span style="color:#fe8019">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</details>
</p>
<h3 id="注册的事件handler">注册的事件Handler</h3>
<p>attachDetachController 在 List-Watch Pod 和 Node 资源变化的时候注册了回调函数，随着 Pod 和 Node 资源的变化，attachDetachController 管理的实际状态和期望状态肯定是有变化的</p>
<h4 id="pod变更事件">Pod变更事件</h4>
<p>代码逻辑很简单，主要是<a href="#util/util.go#ProcessPodVolumes">util.ProcessPodVolumes的调用</a>, 逻辑简单，这里就不再过多赘述了</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">podAdd</span>(obj <span style="color:#fe8019">interface</span>{}) {
</span></span><span style="display:flex;"><span>    pod, ok <span style="color:#fe8019">:=</span> obj.(<span style="color:#fe8019">*</span>v1.Pod)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> pod <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">||</span> !ok {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> pod.Spec.NodeName <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Ignore pods without NodeName, indicating they are not scheduled.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> 
</span></span><span style="display:flex;"><span>    }           
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>    volumeActionFlag <span style="color:#fe8019">:=</span> util.<span style="color:#fabd2f">DetermineVolumeAction</span>(
</span></span><span style="display:flex;"><span>        pod,        
</span></span><span style="display:flex;"><span>        adc.desiredStateOfWorld,
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">true</span> <span style="color:#928374;font-style:italic">/* default volume action */</span>)
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>    util.<span style="color:#fabd2f">ProcessPodVolumes</span>(pod, volumeActionFlag, <span style="color:#928374;font-style:italic">/* addVolumes */</span>
</span></span><span style="display:flex;"><span>        adc.desiredStateOfWorld, <span style="color:#fe8019">&amp;</span>adc.volumePluginMgr, adc.pvcLister, adc.pvLister, adc.csiMigratedPluginManager, adc.intreeToCSITranslator)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">podDelete</span>(obj <span style="color:#fe8019">interface</span>{}) {
</span></span><span style="display:flex;"><span>    pod, ok <span style="color:#fe8019">:=</span> obj.(<span style="color:#fe8019">*</span>v1.Pod)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> pod <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">||</span> !ok {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    util.<span style="color:#fabd2f">ProcessPodVolumes</span>(pod, <span style="color:#fe8019">false</span>, <span style="color:#928374;font-style:italic">/* addVolumes */</span>
</span></span><span style="display:flex;"><span>        adc.desiredStateOfWorld, <span style="color:#fe8019">&amp;</span>adc.volumePluginMgr, adc.pvcLister, adc.pvLister, adc.csiMigratedPluginManager, adc.intreeToCSITranslator)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>          
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">podUpdate</span>(oldObj, newObj <span style="color:#fe8019">interface</span>{}) {
</span></span><span style="display:flex;"><span>    pod, ok <span style="color:#fe8019">:=</span> newObj.(<span style="color:#fe8019">*</span>v1.Pod)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> pod <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">||</span> !ok {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> pod.Spec.NodeName <span style="color:#fe8019">==</span> <span style="color:#b8bb26">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// Ignore pods without NodeName, indicating they are not scheduled.</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    volumeActionFlag <span style="color:#fe8019">:=</span> util.<span style="color:#fabd2f">DetermineVolumeAction</span>(
</span></span><span style="display:flex;"><span>        pod,
</span></span><span style="display:flex;"><span>        adc.desiredStateOfWorld,
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">true</span> <span style="color:#928374;font-style:italic">/* default volume action */</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    util.<span style="color:#fabd2f">ProcessPodVolumes</span>(pod, volumeActionFlag, <span style="color:#928374;font-style:italic">/* addVolumes */</span>
</span></span><span style="display:flex;"><span>        adc.desiredStateOfWorld, <span style="color:#fe8019">&amp;</span>adc.volumePluginMgr, adc.pvcLister, adc.pvLister, adc.csiMigratedPluginManager, adc.intreeToCSITranslator)
</span></span></code></pre></div><h4 id="node变更事件">Node变更事件</h4>
<p>好多方法的调用前面都有详述，直接看源码，逻辑简单，这里不再赘述。</p>
<div class="highlight"><pre tabindex="0" style="color:#ebdbb2;background-color:#282828;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">nodeAdd</span>(obj <span style="color:#fe8019">interface</span>{}) {
</span></span><span style="display:flex;"><span>    node, ok <span style="color:#fe8019">:=</span> obj.(<span style="color:#fe8019">*</span>v1.Node)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// TODO: investigate if nodeName is empty then if we can return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// kubernetes/kubernetes/issues/37777</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> node <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">||</span> !ok {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span> 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    nodeName <span style="color:#fe8019">:=</span> types.<span style="color:#fabd2f">NodeName</span>(node.Name)
</span></span><span style="display:flex;"><span>    adc.<span style="color:#fabd2f">nodeUpdate</span>(<span style="color:#fe8019">nil</span>, obj)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// kubernetes/kubernetes/issues/37586</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// This is to workaround the case when a node add causes to wipe out</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// the attached volumes field. This function ensures that we sync with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// the actual status.</span>
</span></span><span style="display:flex;"><span>    adc.actualStateOfWorld.<span style="color:#fabd2f">SetNodeStatusUpdateNeeded</span>(nodeName)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">nodeUpdate</span>(oldObj, newObj <span style="color:#fe8019">interface</span>{}) {
</span></span><span style="display:flex;"><span>    node, ok <span style="color:#fe8019">:=</span> newObj.(<span style="color:#fe8019">*</span>v1.Node)
</span></span><span style="display:flex;"><span>    <span style="color:#928374;font-style:italic">// TODO: investigate if nodeName is empty then if we can return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> node <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">||</span> !ok {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    nodeName <span style="color:#fe8019">:=</span> types.<span style="color:#fabd2f">NodeName</span>(node.Name)
</span></span><span style="display:flex;"><span>    adc.<span style="color:#fabd2f">addNodeToDswp</span>(node, nodeName)
</span></span><span style="display:flex;"><span>    adc.<span style="color:#fabd2f">processVolumesInUse</span>(nodeName, node.Status.VolumesInUse)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fe8019">func</span> (adc <span style="color:#fe8019">*</span>attachDetachController) <span style="color:#fabd2f">nodeDelete</span>(obj <span style="color:#fe8019">interface</span>{}) {
</span></span><span style="display:flex;"><span>    node, ok <span style="color:#fe8019">:=</span> obj.(<span style="color:#fe8019">*</span>v1.Node)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> node <span style="color:#fe8019">==</span> <span style="color:#fe8019">nil</span> <span style="color:#fe8019">||</span> !ok {
</span></span><span style="display:flex;"><span>        <span style="color:#fe8019">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    nodeName <span style="color:#fe8019">:=</span> types.<span style="color:#fabd2f">NodeName</span>(node.Name)
</span></span><span style="display:flex;"><span>    <span style="color:#fe8019">if</span> err <span style="color:#fe8019">:=</span> adc.desiredStateOfWorld.<span style="color:#fabd2f">DeleteNode</span>(nodeName); err <span style="color:#fe8019">!=</span> <span style="color:#fe8019">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#928374;font-style:italic">// This might happen during drain, but we still want it to appear in our logs</span>
</span></span><span style="display:flex;"><span>        klog.<span style="color:#fabd2f">Infof</span>(<span style="color:#b8bb26">&#34;error removing node %q from desired-state-of-world: %v&#34;</span>, nodeName, err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    adc.<span style="color:#fabd2f">processVolumesInUse</span>(nodeName, node.Status.VolumesInUse)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="总结">总结</h2>
<ol>
<li>AD Controller 对 volume 和 node 的 attach 维护了2个状态集合：实际状态和期望状态，并通过协调器进行 attach/detach 操作来完成实际状态和期望状态的协调。</li>
<li>AD Controller 在运行初始通过 <code>node.Status.VolumesAttached</code> 和 <code>node.Status.VolumesInUse</code>，以及集群 VolumeAttachment 资源来初始化实际状态。</li>
<li>AD Controller在运行初始通过遍历集群 Pod 资源来初始化期望状态，并通过 List-Watch Pod 和 Node 资源为其注册相应的事件回调函数来进一步在运行的过程中修正期望状态。</li>
</ol>

  </div>


  
<div>
  <ul class="tags">
  <li>
    <a href="https://www.zhangzewen.net/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="tag-link">源码分析</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/kubernetes/" class="tag-link">Kubernetes</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/kubelet/" class="tag-link">Kubelet</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/csi/" class="tag-link">Csi</a>
  </li>
  </ul>
</div>



  <div class="share-buttons">
    
  
<script src="https://utteranc.es/client.js"
        repo="zhangzewen/zhangzewen.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>


  
</div>
  </main>

  <footer>
  <div>
    <p>
      &copy; Zhang Zewen 2025

      &middot; <a href="https://creativecommons.org/licenses/by-sa/4.0" target="_blank">CC BY-SA 4.0</a>

      
    </p>
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
    integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin="anonymous"></script>


  <script src="/js/jquery.min.js"></script>
  <script src="/js/soho.js"></script>

  

  
  
  
</body>

</html>
