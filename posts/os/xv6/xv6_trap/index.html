<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  xml:lang="zh-cn" lang="zh-cn" >

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.149.0">

  <title>xv6 之 trap 机制 &middot; What a Life!</title>

  <meta name="description" content="" />

  
  <meta itemprop="name" content="xv6 之 trap 机制">
  <meta itemprop="description" content="本片文章结合 xv6 的代码、配套 xv6-book 和 RISC-V 的文档，根据自己理解总结，权当笔记，以便日后翻阅，如果阅读起来很跳跃，请见谅。如果错误，望不吝赐教。
trap 机制 根据 xv6 book 所述，以下三种状况会导致从用户态到内核态的切换：">
  <meta itemprop="datePublished" content="2025-08-05T09:43:31+08:00">
  <meta itemprop="dateModified" content="2025-08-05T09:43:31+08:00">
  <meta itemprop="wordCount" content="1750">
  <meta itemprop="image" content="https://www.zhangzewen.net/images/profile.png">
  <meta itemprop="keywords" content="公开课,操作系统,Linux,Mit,Xv6">


  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://www.zhangzewen.net/images/profile.png">
  <meta name="twitter:title" content="xv6 之 trap 机制">
  <meta name="twitter:description" content="本片文章结合 xv6 的代码、配套 xv6-book 和 RISC-V 的文档，根据自己理解总结，权当笔记，以便日后翻阅，如果阅读起来很跳跃，请见谅。如果错误，望不吝赐教。
trap 机制 根据 xv6 book 所述，以下三种状况会导致从用户态到内核态的切换：">


<meta property="og:url" content="https://www.zhangzewen.net/posts/os/xv6/xv6_trap/">
  <meta property="og:site_name" content="What a Life!">
  <meta property="og:title" content="xv6 之 trap 机制">
  <meta property="og:description" content="本片文章结合 xv6 的代码、配套 xv6-book 和 RISC-V 的文档，根据自己理解总结，权当笔记，以便日后翻阅，如果阅读起来很跳跃，请见谅。如果错误，望不吝赐教。
trap 机制 根据 xv6 book 所述，以下三种状况会导致从用户态到内核态的切换：">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-05T09:43:31+08:00">
    <meta property="article:modified_time" content="2025-08-05T09:43:31+08:00">
    <meta property="article:tag" content="公开课">
    <meta property="article:tag" content="操作系统">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Mit">
    <meta property="article:tag" content="Xv6">
    <meta property="og:image" content="https://www.zhangzewen.net/images/profile.png">



<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type":"Person",
      "@id": "https://www.zhangzewen.net/#author",
      "name": "Zhang Zewen",
      "image": {
        "@type":"ImageObject",
        
        "url": "https://www.zhangzewen.net/images/android-chrome-512x512.png"
        
      },
      "description": "Software Engineer"
    },
    {
      "@type": "WebSite",
      "@id": "https://www.zhangzewen.net/#website",
      "url": "https://www.zhangzewen.net/",
      "name": "What a Life!",
      "description": "Software Engineer",
      "publisher": {
        "@id": "https://www.zhangzewen.net/#author"
      },
      "inLanguage": "zh-cn"
    },
    {
      "@type": "ImageObject",
      "url": "https://www.zhangzewen.net/images/profile.png",
      "caption": "What a Life!"
    },
    {
      "@type": "WebPage",
      "@id": "https://www.zhangzewen.net/posts/os/xv6/xv6_trap/#webpage",
      "url": "https://www.zhangzewen.net/posts/os/xv6/xv6_trap/",
      "name": "xv6 之 trap 机制",
      "isPartOf": {
        "@id": "https://www.zhangzewen.net/#website"
      },
      "about": {
         "@id": "https://www.zhangzewen.net/#author"
      },
      "datePublished": "2025-08-05T09:43:31+08:00",
      "dateModified": "2025-08-05T09:43:31+08:00",
      "description": "\u003cp\u003e本片文章结合 xv6 的代码、配套 xv6-book 和 RISC-V 的文档，根据自己理解总结，权当笔记，以便日后翻阅，如果阅读起来很跳跃，请见谅。如果错误，望不吝赐教。\u003c/p\u003e\n\u003ch2 id=\"trap-机制\"\u003etrap 机制\u003c/h2\u003e\n\u003cp\u003e根据 xv6 book 所述，以下三种状况会导致从用户态到内核态的切换：\u003c/p\u003e",
      "inLanguage": "zh-cn",
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "https://www.zhangzewen.net/posts/os/xv6/xv6_trap/"
          ]
        }
      ]
    },
    {
      "@type": "Article",
      "isPartOf": {
        "@id": "https://www.zhangzewen.net/posts/os/xv6/xv6_trap/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "https://www.zhangzewen.net/posts/os/xv6/xv6_trap/#webpage"
      },
      "headline": "xv6 之 trap 机制",
      "datePublished": "2025-08-05T09:43:31+08:00",
      "dateModified": "2025-08-05T09:43:31+08:00",
      "publisher": {
        "@id": "https://www.zhangzewen.net/#author"
      },
      "keywords": [
        "公开课",
        "操作系统",
        "Linux",
        "Mit",
        "Xv6"
      ],
      "articleSection": [
      ],
      "inLanguage": "zh-cn",
      "author": {
        "@type": "Person",
        "name":  null 
      },
      "potentialAction": [
        {
          "@type": "CommentAction",
          "name": "Comment",
          "target": [
            "https://www.zhangzewen.net/posts/os/xv6/xv6_trap/#comments"
          ]
        }
      ]
    }
  ]
}
</script>



  <link type="text/css" rel="stylesheet" href="/css/print.css" media="print">

  <link type="text/css" rel="stylesheet" href="/css/poole.css">

  <link type="text/css" rel="stylesheet" href="/css/hyde.css">

  


  

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
    integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>

<body>
  <aside class="toc">
  
  
  <h3>目录</h3>
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#trap-机制">trap 机制</a></li>
        <li><a href="#risc-v-特权级别">RISC-V 特权级别</a></li>
        <li><a href="#控制和状态寄存器">控制和状态寄存器</a>
          <ul>
            <li><a href="#mstatussstatus">mstatus/sstatus</a></li>
            <li><a href="#stvec">stvec</a></li>
            <li><a href="#sepc">sepc</a></li>
            <li><a href="#scause">scause</a></li>
            <li><a href="#sscratch">sscratch</a></li>
          </ul>
        </li>
        <li><a href="#trap-处理流程">trap 处理流程</a></li>
        <li><a href="#xv6-用户态触发-trap-处理流程">xv6 用户态触发 trap 处理流程</a>
          <ul>
            <li><a href="#uservec">uservec</a></li>
            <li><a href="#usertrap">usertrap</a></li>
            <li><a href="#usertrapret">usertrapret</a></li>
            <li><a href="#userret">userret</a></li>
          </ul>
        </li>
        <li><a href="#xv6-内核态触发-trap-处理流程">xv6 内核态触发 trap 处理流程</a>
          <ul>
            <li><a href="#kernelvec">kernelvec</a></li>
            <li><a href="#kerneltrap">kerneltrap</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  
  
</aside>

  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <a href="https://www.zhangzewen.net/">
            <img src="/images/android-chrome-512x512.png" class="img-circle img-headshot center" alt="Profile Picture">
          </a>
        </div>
        
      

      <h1>What a Life!</h1>

      
      <p class="lead">Software Engineer</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="https://www.zhangzewen.net/">Home</a>
        </li>
        <li>
          <a href="/tags/">Tags</a>
        </li><li>
          <a href="/archive/">Archives</a>
        </li><li>
          <a href="/about-me/">About Me</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
      <a href="https://github.com/zhangzewen" rel="me" title="GitHub" target="_blank">
        <i class="fab fa-github" aria-hidden="true"></i>
      </a>
      
    </section>
  </div>
</aside>


  <main class="content container">
    <div class="post">
  <h1 class="title">xv6 之 trap 机制</h1>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
</script>


  <div class="post-date">
    <time datetime=" 2025-08-05T09:43:31&#43;0800">Created: Aug 5, 2025</time>
    <span class="readtime">&middot; 9 min read</span>
  </div>

  <div>
    <p>本片文章结合 xv6 的代码、配套 xv6-book 和 RISC-V 的文档，根据自己理解总结，权当笔记，以便日后翻阅，如果阅读起来很跳跃，请见谅。如果错误，望不吝赐教。</p>
<h2 id="trap-机制">trap 机制</h2>
<p>根据 xv6 book 所述，以下三种状况会导致从用户态到内核态的切换：</p>
<ul>
<li>系统调用，例如调用 <code>write/open</code> 等系统函数，更进一步就是调用 <code>ecall</code> 指令。</li>
<li>异常，例如除以零或使用了无效的虚拟地址。</li>
<li>设备中断，当设备发出需要处理的信号时，例如磁盘硬件完成读或写请求，该中断无论发生在用户态或者是内核态，回调函数的处理都是在内核态下处理。</li>
</ul>
<p>这里使用 &ldquo;trap&rdquo; 作为以上这些情况的通用词。</p>
<h2 id="risc-v-特权级别">RISC-V 特权级别</h2>
<p>任何时候一个 RISC-V 硬件线程（hart）都在某个特权级别上运行，该特权级别存储在一个或多个控制和状态寄存器中。尝试执行当前权限级别不允许的操作将导致引发异常，这些异常通常会导致陷入底层执行环境。</p>
<table>
  <thead>
      <tr>
          <th>特权名称</th>
          <th>级别</th>
          <th>编码</th>
          <th>简称</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>User/Application</td>
          <td>0</td>
          <td>00</td>
          <td>U</td>
      </tr>
      <tr>
          <td>Supervisor</td>
          <td>1</td>
          <td>01</td>
          <td>S</td>
      </tr>
      <tr>
          <td>Reserved</td>
          <td>2</td>
          <td>10</td>
          <td></td>
      </tr>
      <tr>
          <td>Machine</td>
          <td>3</td>
          <td>11</td>
          <td>M</td>
      </tr>
  </tbody>
</table>
<p>Machine Mode（ M 模式）具有最高的特权，User Mode（用户模式，即 U 模式）和 Supervisor Mode（监督模式，即 S 模式，更常用的称呼为 内核模式）分别用于常规应用程序和操作系统使用。</p>
<h2 id="控制和状态寄存器">控制和状态寄存器</h2>
<p>控制和状态寄存器即 CSRs，是存储CPU中各种信息的寄存器。标准的 RISC-V ISA 保留了一个12位的编码空间，因此最多可以有 4096 个 CSR。 在这 12 位的编码空间中，其中最高两位指示寄存器是读/写（00、01或10）还是只读（11）。接下来的两位确定可以访问该寄存器的最低权限级别。 RISC-V 只分配了部分地址空间，以便在未使用的地址中添加自定义的 CSR。</p>
<h3 id="mstatussstatus">mstatus/sstatus</h3>
<p>寄存器 mstatus/sstatus 跟踪并控制 CPU 当前的运行状态（机器模式/监督模式），sstatus 继承自 mstatus：
<img src="/images/os/xv6/xv6_trap_mstatus_layout.png" alt="mstatus"></p>
<ul>
<li>MPP，指示 hart 在进入机器模式之前执行的特权级别。当执行一个 mret 指令从 trap 处理程序返回时，特权等级会被设置为 MPP 所存储的值所对应的特权级别。</li>
<li>MIE，启用或禁用机器模式下的所有中断。</li>
<li>MPIE，指示在陷入机器模式之前是否启用了中断。当陷入机器模式时，MPIE 的值设置为 MIE 的值，然后 MIE 设置为0。当执行 mret 指令时，MIE 的值设置为 MPIE 的值，然后 MPIE 设置为1。</li>
</ul>
<p><img src="/images/os/xv6/xv6_trap_sstatus_layout.png" alt="sstatus"></p>
<ul>
<li>SPP，指示 hart 在进入监督模式之前执行的特权级别。当执行一个 sret 指令从 trap 处理程序返回时，特权等级会被设置为 SPP 所存储的值所对应的特权级别。</li>
<li>SIE，启用或禁用监督模式下的所有中断。</li>
<li>SPIE，指示在陷入监督模式之前是否启用了中断。当陷入监督模式时，SPIE 的值设置为 SIE 的值，然后 SIE 设置为0。当执行 sret 指令时，SIE 的值设置为 SPIE 的值，然后 SPIE 设置为1。</li>
</ul>
<p>在 <code>kernel/start.c</code>，在机器模式下，设置前一个特权级别为监督模式，可以类比上面的SSP， 这个是给 mret 使用，即执行 mret 时候 返回到监督模式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#6272a4">// set M Previous Privilege mode to Supervisor, for mret.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> x <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">r_mstatus</span>();
</span></span><span style="display:flex;"><span>  x <span style="color:#ff79c6">&amp;=</span> <span style="color:#ff79c6">~</span>MSTATUS_MPP_MASK;
</span></span><span style="display:flex;"><span>  x <span style="color:#ff79c6">|=</span> MSTATUS_MPP_S;
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">w_mstatus</span>(x);
</span></span></code></pre></div><h3 id="stvec">stvec</h3>
<p>内核将它的异常处理程序地址写入寄存器 stvec，RISC-V 跳转到 stvec 中的地址来处理异常，即把寄存器 stvec 的值赋值给寄存器 pc。在 xv6 中，kernelvec（kernelvec.S）负责处理发生在内核态的 trap， uservec（trampoline.S）负责发生在用户态的 trap。</p>
<h3 id="sepc">sepc</h3>
<p>当 trap 触发时，寄存器 pc 的值保存于此（因为此时 pc 被 stvec 中的值覆盖）。sret（从 trap 返回）指令将 sepc 的值复制到pc。</p>
<h3 id="scause">scause</h3>
<p>寄存器 scause 存储的是 trap 产生的原因：</p>
<p><img src="/images/os/xv6/xv6_trap_scause.png" alt="scause"></p>
<h3 id="sscratch">sscratch</h3>
<p>寄存器 sscratch 主要用于在用户态和内核态切换时临时保存数据，特别是在 trap 处理过程中。它的核心作用是<strong>提供一个安全的临时存储空间</strong>，避免关键寄存器的值被破坏。</p>
<h2 id="trap-处理流程">trap 处理流程</h2>
<p>在 <code>kernel/start.c</code> 中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#6272a4">// delegate all interrupts and exceptions to supervisor mode.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#50fa7b">w_medeleg</span>(<span style="color:#bd93f9">0xffff</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">w_mideleg</span>(<span style="color:#bd93f9">0xffff</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">w_sie</span>(<span style="color:#50fa7b">r_sie</span>() <span style="color:#ff79c6">|</span> SIE_SEIE <span style="color:#ff79c6">|</span> SIE_STIE <span style="color:#ff79c6">|</span> SIE_SSIE);
</span></span></code></pre></div><p>即当 trap 发生时候，不管处在何种特权模式下，统一都是在监督模式下处理。</p>
<p>总体来说，在监督模式下，当 trap 发生时候，硬件的处理流程如下：</p>
<ul>
<li>关闭中断</li>
<li>寄存器 pc 的值赋值给寄存器 sepc。</li>
<li>寄存器 stvec 的值赋值给寄存器 pc。</li>
<li>设置寄存器 scause ，告知触发 trap 的原因。</li>
<li>设置寄存器 stval，保存额外的信息，例如发生page fault 时候，保存的是<strong>虚拟地址</strong>。</li>
<li>设置寄存器标志位 sstatus.SPP，即保存进入监督模式之前执行的特权级别。</li>
<li>设置寄存器标志位 sstatus.SPIE，即保存进入监督模式之前中断开关情况。</li>
<li>执行处理 trap 异常逻辑，即回调函数。</li>
<li>处理异常完毕后调用 sret 返回：
<ul>
<li>把标志位 sstatus.SPIE 的值赋值给标志位 sstatus.SIE。</li>
<li>根据标志位 sstatus.SPP 的值来设置当前特权级别。</li>
<li>把寄存器 sepc 的值赋值给寄存器 pc。</li>
</ul>
</li>
</ul>
<p>机器模式下 trap 的处理可以类比上述流程。</p>
<h2 id="xv6-用户态触发-trap-处理流程">xv6 用户态触发 trap 处理流程</h2>
<h3 id="uservec">uservec</h3>
<p>根据 上述 trap 的处理流程，用户态处理 trap 的回调逻辑地址是 uservec，其实现在 <code>kernel/trampoline.S</code> 下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>        <span style="color:#6272a4">#
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># low-level code to handle traps from user space into
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># the kernel, and returns from kernel to user.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">#
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># the kernel maps the page holding this code
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># at the same virtual address (TRAMPOLINE)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># in user and kernel space so that it continues
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># to work when it switches page tables.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># kernel.ld causes this code to start at 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># a page boundary.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">#
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#include &#34;riscv.h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">#include &#34;memlayout.h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">.section</span> trampsec
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">.globl</span> trampoline
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">.globl</span> usertrap
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">trampoline:</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">.align</span> <span style="color:#bd93f9">4</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">.globl</span> uservec
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">uservec:</span>    
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4">#
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># trap.c sets stvec to point here, so
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># traps from user space start here,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># in supervisor mode, but with a
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># user page table.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">#
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># save user a0 in sscratch so
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># a0 can be used to get at TRAPFRAME.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">csrw</span> sscratch, a0   <span style="color:#6272a4"># 保存 函数返回值 存储寄存器 a0 到 sscratch中
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># each process has a separate p-&gt;trapframe memory area,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># but it&#39;s mapped to the same virtual address
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># (TRAPFRAME) in every process&#39;s user page table.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">li</span> a0, TRAPFRAME <span style="color:#6272a4">#把 p-&gt;trapframe 的地址保存到a0中 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># save the user registers in TRAPFRAME 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># 存储各个寄存器到 p-&gt;trapframe, 即保存进程的状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">sd</span> ra, <span style="color:#bd93f9">40</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> sp, <span style="color:#bd93f9">48</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> gp, <span style="color:#bd93f9">56</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> tp, <span style="color:#bd93f9">64</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t0, <span style="color:#bd93f9">72</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t1, <span style="color:#bd93f9">80</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t2, <span style="color:#bd93f9">88</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s0, <span style="color:#bd93f9">96</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s1, <span style="color:#bd93f9">104</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a1, <span style="color:#bd93f9">120</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a2, <span style="color:#bd93f9">128</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a3, <span style="color:#bd93f9">136</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a4, <span style="color:#bd93f9">144</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a5, <span style="color:#bd93f9">152</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a6, <span style="color:#bd93f9">160</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a7, <span style="color:#bd93f9">168</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s2, <span style="color:#bd93f9">176</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s3, <span style="color:#bd93f9">184</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s4, <span style="color:#bd93f9">192</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s5, <span style="color:#bd93f9">200</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s6, <span style="color:#bd93f9">208</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s7, <span style="color:#bd93f9">216</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s8, <span style="color:#bd93f9">224</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s9, <span style="color:#bd93f9">232</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s10, <span style="color:#bd93f9">240</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> s11, <span style="color:#bd93f9">248</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t3, <span style="color:#bd93f9">256</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t4, <span style="color:#bd93f9">264</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t5, <span style="color:#bd93f9">272</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t6, <span style="color:#bd93f9">280</span>(a0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4"># save the user a0 in p-&gt;trapframe-&gt;a0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">csrr</span> t0, sscratch
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t0, <span style="color:#bd93f9">112</span>(a0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># initialize kernel stack pointer, from p-&gt;trapframe-&gt;kernel_sp
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># 将 kernel栈帧的栈顶存储到寄存器sp中
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">ld</span> sp, <span style="color:#bd93f9">8</span>(a0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># make tp hold the current hartid, from p-&gt;trapframe-&gt;kernel_hartid
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># 将 hartid 储存到寄存器 tp 中
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">ld</span> tp, <span style="color:#bd93f9">32</span>(a0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># load the address of usertrap(), from p-&gt;trapframe-&gt;kernel_trap
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># 将 函数 usertrap() 的地址存储到寄存器 t0 中
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">ld</span> t0, <span style="color:#bd93f9">16</span>(a0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># fetch the kernel page table address, from p-&gt;trapframe-&gt;kernel_satp.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># 将 kernel 的 page table 的地址 kernel_pagetable 存储到寄存器 t1 中， 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">ld</span> t1, <span style="color:#bd93f9">0</span>(a0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># wait for any previous memory operations to complete, so that
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># they use the user page table.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># 切换到内核的 page table
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">sfence.vma</span> zero, zero
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># install the kernel page table.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">csrw</span> satp, t1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># flush now-stale user entries from the TLB.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">sfence.vma</span> zero, zero
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># jump to usertrap(), which does not return
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># jump 到函数 usertrap()
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">jr</span> t0
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># ...
</span></span></span></code></pre></div><p>根据上面的代码，uservec 的处理流程如下：</p>
<ul>
<li>用户态
<ul>
<li>存储用户态函数执行状态（存储各种寄存器）。</li>
<li>设置内核栈帧数据，获取 内核态 page table 的地址</li>
</ul>
</li>
<li>内核态
<ul>
<li>从用户态 page table 切换到 内核态 page table。</li>
<li>跳转到函数 usertrap 。</li>
</ul>
</li>
</ul>
<h3 id="usertrap">usertrap</h3>
<p>下面来看下 usertrap 这个函数，这个函数在 <code>kernel/trap.c</code> 下，这个是核心部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">void</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">usertrap</span>(<span style="color:#8be9fd">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> which_dev <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span>((<span style="color:#50fa7b">r_sstatus</span>() <span style="color:#ff79c6">&amp;</span> SSTATUS_SPP) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">panic</span>(<span style="color:#f1fa8c">&#34;usertrap: not from user mode&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// send interrupts and exceptions to kerneltrap(),
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// since we&#39;re now in the kernel.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// 把内核态的 trap 处理函数 kernelvec的地址存储到 寄存器STVEC，因为需要处理内核态发生 trap 的情形
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#50fa7b">w_stvec</span>((uint64)kernelvec);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">struct</span> proc <span style="color:#ff79c6">*</span>p <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">myproc</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// save user program counter.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// 把寄存器 SEPC 的值存储到 p-&gt;trapfram-&gt;epc, 从上面得知是用户态时候的寄存器 pc 的值
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  p<span style="color:#ff79c6">-&gt;</span>trapframe<span style="color:#ff79c6">-&gt;</span>epc <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">r_sepc</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// 判断是因为啥而触发了trap 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">if</span>(<span style="color:#50fa7b">r_scause</span>() <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">8</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// system call
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// 系统调用
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span>(<span style="color:#50fa7b">killed</span>(p))
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">exit</span>(<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// sepc points to the ecall instruction,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// but we want to return to the next instruction.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// 用户态 调用 ecall 时的下一条指令，衔接 ecall 返回后，即返回到用户态后继续执行，避免再次调用ecall造成死循环
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    p<span style="color:#ff79c6">-&gt;</span>trapframe<span style="color:#ff79c6">-&gt;</span>epc <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">4</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// an interrupt will change sepc, scause, and sstatus,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// so enable only now that we&#39;re done with those registers.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">intr_on</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 执行系统调用
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">sysdall</span>();
</span></span><span style="display:flex;"><span>  } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span>((which_dev <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">devintr</span>()) <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>){ <span style="color:#6272a4">// 设备中断
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// ok
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  } <span style="color:#ff79c6">else</span> { <span style="color:#6272a4">// 异常状态，杀死进程
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">printf</span>(<span style="color:#f1fa8c">&#34;usertrap(): unexpected scause 0x%lx pid=%d</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, <span style="color:#50fa7b">r_scause</span>(), p<span style="color:#ff79c6">-&gt;</span>pid);
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">printf</span>(<span style="color:#f1fa8c">&#34;            sepc=0x%lx stval=0x%lx</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, <span style="color:#50fa7b">r_sepc</span>(), <span style="color:#50fa7b">r_stval</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">setkilled</span>(p);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span>(<span style="color:#50fa7b">killed</span>(p))
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">exit</span>(<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// give up the CPU if this is a timer interrupt.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">if</span>(which_dev <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">2</span>)<span style="color:#6272a4">// 时钟中断
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">yield</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">usertrapret</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>usertrap 的处理流程如下：</p>
<ul>
<li>设置寄存器 stvec 的值为内核态trap 的处理逻辑的地址，即 kernelvec，因为是用户态触发的trap，会进入到内核态的环境来处理，在这期间可能会有 trap 触发。</li>
<li>usertrap 根据 trap 触发的原因执行与之对应的处理动作：
<ul>
<li>ecall，执行对应的系统调用</li>
<li>设备中断，目前来看是不做任何处理的</li>
<li>异常，杀死进程</li>
<li>时钟中断，执行 yield 切换进程</li>
</ul>
</li>
<li>上述处理完成后，执行 usertrapret 从处理 trap 回调逻辑中返回。</li>
</ul>
<h3 id="usertrapret">usertrapret</h3>
<p>如下是 usertrapret 的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">void</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">usertrapret</span>(<span style="color:#8be9fd">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">struct</span> proc <span style="color:#ff79c6">*</span>p <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">myproc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// we&#39;re about to switch the destination of traps from
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// kerneltrap() to usertrap(), so turn off interrupts until
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// we&#39;re back in user space, where usertrap() is correct.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#50fa7b">intr_off</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// send syscalls, interrupts, and exceptions to uservec in trampoline.S
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// 设置寄存器STVEC ，指向 trampoline, 首尾呼应 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  uint64 trampoline_uservec <span style="color:#ff79c6">=</span> TRAMPOLINE <span style="color:#ff79c6">+</span> (uservec <span style="color:#ff79c6">-</span> trampoline);
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">w_stvec</span>(trampoline_uservec);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// set up trapframe values that uservec will need when
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// the process next traps into the kernel.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// 填充 p-&gt;trapfram 中内核的相关参数，供下次trap的时候，uservec 使用
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  p<span style="color:#ff79c6">-&gt;</span>trapframe<span style="color:#ff79c6">-&gt;</span>kernel_satp <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">r_satp</span>();         <span style="color:#6272a4">// kernel page table
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  p<span style="color:#ff79c6">-&gt;</span>trapframe<span style="color:#ff79c6">-&gt;</span>kernel_sp <span style="color:#ff79c6">=</span> p<span style="color:#ff79c6">-&gt;</span>kstack <span style="color:#ff79c6">+</span> PGSIZE; <span style="color:#6272a4">// process&#39;s kernel stack
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  p<span style="color:#ff79c6">-&gt;</span>trapframe<span style="color:#ff79c6">-&gt;</span>kernel_trap <span style="color:#ff79c6">=</span> (uint64)usertrap;
</span></span><span style="display:flex;"><span>  p<span style="color:#ff79c6">-&gt;</span>trapframe<span style="color:#ff79c6">-&gt;</span>kernel_hartid <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">r_tp</span>();         <span style="color:#6272a4">// hartid for cpuid()
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// set up the registers that trampoline.S&#39;s sret will use
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// to get to user space.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// set S Previous Privilege mode to User.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// 设置寄存器 sstatus
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">long</span> x <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">r_sstatus</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// 设置用户特权级别
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  x <span style="color:#ff79c6">&amp;=</span> <span style="color:#ff79c6">~</span>SSTATUS_SPP; <span style="color:#6272a4">// clear SPP to 0 for user mode
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// 恢复进入到监督模式之前中断开/关状态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  x <span style="color:#ff79c6">|=</span> SSTATUS_SPIE; <span style="color:#6272a4">// enable interrupts in user mode
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#50fa7b">w_sstatus</span>(x);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// set S Exception Program Counter to the saved user pc.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// 设置 寄存器 sepc 的值， 在sret 的时候，sepc 会赋值给寄存器 pc
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#50fa7b">w_sepc</span>(p<span style="color:#ff79c6">-&gt;</span>trapframe<span style="color:#ff79c6">-&gt;</span>epc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// tell trampoline.S the user page table to switch to.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// 获取到用户态的page table
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  uint64 satp <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">MAKE_SATP</span>(p<span style="color:#ff79c6">-&gt;</span>pagetable);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// jump to userret in trampoline.S at the top of memory, which 
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// switches to the user page table, restores user registers,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// and switches to user mode with sret.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// 调用 userret 从内核态切换到用户态
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  uint64 trampoline_userret <span style="color:#ff79c6">=</span> TRAMPOLINE <span style="color:#ff79c6">+</span> (userret <span style="color:#ff79c6">-</span> trampoline);
</span></span><span style="display:flex;"><span>  ((<span style="color:#8be9fd">void</span> (<span style="color:#ff79c6">*</span>)(uint64))trampoline_userret)(satp); <span style="color:#6272a4">// satp 存储到寄存器a0中
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>}
</span></span></code></pre></div><p>usertrapret 的处理流程大致如下：</p>
<ul>
<li>设置寄存器 stvec, 指向 <code>kernel/trampoline.S</code> 中的 uservec，形成完美闭环。</li>
<li>设置 uservec 需要使用的内核相关数据，即填充结构体 trapframe，供下次 trap 使用。</li>
<li>设置寄存器 SEPC，指向 ecall 的下一条指令。</li>
<li>获取到用户态的 page table</li>
<li>执行 <code>kernel/trampoline.S</code>  中的 userret 函数，用户态 page table 的地址作为参数。</li>
</ul>
<h3 id="userret">userret</h3>
<p>userret 的逻辑和 uservec 的逻辑正好相反：</p>
<ul>
<li>切换页表，从内核态 page table 切换到 用户态 page table。</li>
<li>恢复用户态函数的执行状态（通过读取 trapframe 结构体来恢复各个寄存器的值)。</li>
<li>调用 sret 指令，跳转到用户态， 会把寄存器 sepc 的值（从上述可知是 <code>ecall</code> 的下一条指令）就会加载到寄存器 pc，让用户态函数继续执行。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#50fa7b">.globl</span> userret
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">userret:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># userret(pagetable)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># called by usertrapret() in trap.c to
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># switch from kernel to user.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># a0: user page table, for satp.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># switch to the user page table.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">sfence.vma</span> zero, zero
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">csrw</span> satp, a0
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sfence.vma</span> zero, zero
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">li</span> a0, TRAPFRAME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># restore all but a0 from TRAPFRAME
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">ld</span> ra, <span style="color:#bd93f9">40</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> sp, <span style="color:#bd93f9">48</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> gp, <span style="color:#bd93f9">56</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> tp, <span style="color:#bd93f9">64</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t0, <span style="color:#bd93f9">72</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t1, <span style="color:#bd93f9">80</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t2, <span style="color:#bd93f9">88</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s0, <span style="color:#bd93f9">96</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s1, <span style="color:#bd93f9">104</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a1, <span style="color:#bd93f9">120</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a2, <span style="color:#bd93f9">128</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a3, <span style="color:#bd93f9">136</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a4, <span style="color:#bd93f9">144</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a5, <span style="color:#bd93f9">152</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a6, <span style="color:#bd93f9">160</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a7, <span style="color:#bd93f9">168</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s2, <span style="color:#bd93f9">176</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s3, <span style="color:#bd93f9">184</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s4, <span style="color:#bd93f9">192</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s5, <span style="color:#bd93f9">200</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s6, <span style="color:#bd93f9">208</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s7, <span style="color:#bd93f9">216</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s8, <span style="color:#bd93f9">224</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s9, <span style="color:#bd93f9">232</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s10, <span style="color:#bd93f9">240</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> s11, <span style="color:#bd93f9">248</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t3, <span style="color:#bd93f9">256</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t4, <span style="color:#bd93f9">264</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t5, <span style="color:#bd93f9">272</span>(a0)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t6, <span style="color:#bd93f9">280</span>(a0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#6272a4"># restore user a0
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">ld</span> a0, <span style="color:#bd93f9">112</span>(a0)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># return to user mode and user pc.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># usertrapret() set up sstatus and sepc.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">sret</span>
</span></span></code></pre></div><h2 id="xv6-内核态触发-trap-处理流程">xv6 内核态触发 trap 处理流程</h2>
<h3 id="kernelvec">kernelvec</h3>
<p>内核态 trap 的处理要比用户态trap的处理简单的多，先存储寄存器，然后调用 kerneltrap 处理逻辑，最后恢复寄存器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>        <span style="color:#6272a4">#
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># interrupts and exceptions while in supervisor
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># mode come here.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">#
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># the current stack is a kernel stack.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># push registers, call kerneltrap().
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4"># when kerneltrap() returns, restore registers, return.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">#
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#50fa7b">.globl</span> kerneltrap
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">.globl</span> kernelvec
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">.align</span> <span style="color:#bd93f9">4</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">kernelvec:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># make room to save registers.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">addi</span> sp, sp, -<span style="color:#bd93f9">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># save caller-saved registers.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">sd</span> ra, <span style="color:#bd93f9">0</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> sp, <span style="color:#bd93f9">8</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> gp, <span style="color:#bd93f9">16</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> tp, <span style="color:#bd93f9">24</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t0, <span style="color:#bd93f9">32</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t1, <span style="color:#bd93f9">40</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t2, <span style="color:#bd93f9">48</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a0, <span style="color:#bd93f9">72</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a1, <span style="color:#bd93f9">80</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a2, <span style="color:#bd93f9">88</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a3, <span style="color:#bd93f9">96</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a4, <span style="color:#bd93f9">104</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a5, <span style="color:#bd93f9">112</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a6, <span style="color:#bd93f9">120</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> a7, <span style="color:#bd93f9">128</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t3, <span style="color:#bd93f9">216</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t4, <span style="color:#bd93f9">224</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t5, <span style="color:#bd93f9">232</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">sd</span> t6, <span style="color:#bd93f9">240</span>(sp)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># call the C trap handler in trap.c
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">call</span> kerneltrap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># restore registers.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">ld</span> ra, <span style="color:#bd93f9">0</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> sp, <span style="color:#bd93f9">8</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> gp, <span style="color:#bd93f9">16</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># not tp (contains hartid), in case we moved CPUs
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">ld</span> t0, <span style="color:#bd93f9">32</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t1, <span style="color:#bd93f9">40</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t2, <span style="color:#bd93f9">48</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a0, <span style="color:#bd93f9">72</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a1, <span style="color:#bd93f9">80</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a2, <span style="color:#bd93f9">88</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a3, <span style="color:#bd93f9">96</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a4, <span style="color:#bd93f9">104</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a5, <span style="color:#bd93f9">112</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a6, <span style="color:#bd93f9">120</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> a7, <span style="color:#bd93f9">128</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t3, <span style="color:#bd93f9">216</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t4, <span style="color:#bd93f9">224</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t5, <span style="color:#bd93f9">232</span>(sp)
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">ld</span> t6, <span style="color:#bd93f9">240</span>(sp)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">addi</span> sp, sp, <span style="color:#bd93f9">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># return to whatever we were doing in the kernel.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">sret</span>
</span></span></code></pre></div><h3 id="kerneltrap">kerneltrap</h3>
<p>kerneltrap 的处理也比较简单：</p>
<ul>
<li>保存 spec， sstatus 寄存器，应对进程切换的状况。</li>
<li>在进入到监督模式之前的特权级别必须是监督模式，否则panic。</li>
<li>中断必须禁用，否则panic。</li>
<li>对于未知的 trap 直接 panic。</li>
<li>对于时钟中断，调用 yield 进行进程切换。</li>
<li>寄存器 spec，sstatus 复位。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">// interrupts and exceptions from kernel code go here via kernelvec,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// on whatever the current kernel stack is.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd">void</span> 
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">kerneltrap</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> which_dev <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>  uint64 sepc <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">r_sepc</span>();
</span></span><span style="display:flex;"><span>  uint64 sstatus <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">r_sstatus</span>();
</span></span><span style="display:flex;"><span>  uint64 scause <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">r_scause</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span>((sstatus <span style="color:#ff79c6">&amp;</span> SSTATUS_SPP) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">panic</span>(<span style="color:#f1fa8c">&#34;kerneltrap: not from supervisor mode&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span>(<span style="color:#50fa7b">intr_get</span>() <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">panic</span>(<span style="color:#f1fa8c">&#34;kerneltrap: interrupts enabled&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span>((which_dev <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">devintr</span>()) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// interrupt or trap from an unknown source
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">printf</span>(<span style="color:#f1fa8c">&#34;scause=0x%lx sepc=0x%lx stval=0x%lx</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, scause, <span style="color:#50fa7b">r_sepc</span>(), <span style="color:#50fa7b">r_stval</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">panic</span>(<span style="color:#f1fa8c">&#34;kerneltrap&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// give up the CPU if this is a timer interrupt.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">if</span>(which_dev <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#50fa7b">myproc</span>() <span style="color:#ff79c6">!=</span> <span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">yield</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// the yield() may have caused some traps to occur,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// so restore trap registers for use by kernelvec.S&#39;s sepc instruction.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#50fa7b">w_sepc</span>(sepc);
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">w_sstatus</span>(sstatus);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
  </div>


  
<div>
  <ul class="tags">
  <li>
    <a href="https://www.zhangzewen.net/tags/%E5%85%AC%E5%BC%80%E8%AF%BE/" class="tag-link">公开课</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="tag-link">操作系统</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/linux/" class="tag-link">Linux</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/mit/" class="tag-link">Mit</a>
  </li>
  
  <li>
    <a href="https://www.zhangzewen.net/tags/xv6/" class="tag-link">Xv6</a>
  </li>
  </ul>
</div>



  <div class="share-buttons">
    
  
<script src="https://utteranc.es/client.js"
        repo="zhangzewen/zhangzewen.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>


  
</div>
  </main>

  <footer>
  <div>
    <p>
      &copy; Zhang Zewen 2025

      &middot; <a href="https://creativecommons.org/licenses/by-sa/4.0" target="_blank">CC BY-SA 4.0</a>

      
    </p>
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
    integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin="anonymous"></script>


  <script src="/js/jquery.min.js"></script>
  <script src="/js/soho.js"></script>

  

  
  
  
</body>

</html>
